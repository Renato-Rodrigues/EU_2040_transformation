---
title: "2040 greenhouse gas reduction targets and energy transitions in line with the EU Green Deal"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
params:
  forceUpdateData: FALSE
  loadHist: TRUE
  energyInMtoe: TRUE
  chartsFolder: "report_paperCharts_Mtoe"
---

<style>
  .main-container {
    max-width: 95% !important;
  }
  .toc-content {
    padding-left: 0px !important;
  }
  .svg-container {
    margin: auto !important;
  }
</style>

Description:
Charts created for the paper:

Rodrigues, R., Pietzcker, R., Sitarz, J., Merfort, A., Hasse, R., Hoppe, J., Pehl, M., Ershad, A. M., Baumstark, L., Luderer, G. 2040 greenhouse gas reduction targets and energy transitions in line with the EU Green Deal. under revision (2023). 


<!-- Setting default chunk options -->
```{r chunkOptions, echo=FALSE, include = FALSE}
#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 12,
                        fig.height = 6,
                        dpi=100
                        )
```  


```{r loading_packages, echo=FALSE, include = FALSE}

  #Loading required packages
  # install.packages("remotes")
  #remotes::install_github("coolbutuseless/ggpattern")
  #install.packages('rsvg')
  #remotes::install_github('coolbutuseless/ggsvg')
  packagesList <- c("quitte","ggplot2","geomtextpath","ggpattern","tidyr","grid","stringr","gridExtra","ggrepel","kableExtra","dplyr","remind2","rsvg","ggsvg")
  packages <- suppressWarnings(suppressMessages(lapply(packagesList, function(x){ if(!require(x, character.only = T, quietly = T)){ install.packages(x); return(paste0("installed missing package: ", x)) } else paste0("required package is installed: ", x) } )))

```

```{r options, echo=FALSE, include = FALSE}

#Options
forceUpdateData <- params$forceUpdateData
loadHist <- params$loadHist
energyInMtoe <- params$energyInMtoe
chartsFolder <- params$chartsFolder

```


<!-- Preprocess: prepare and load the data for use in the charts and markdown -->

```{r preprocess, echo=FALSE, include = FALSE}

# data and output folders
folders <- file.info(list.files(path="./data", full.names = T))
dataFolder <- folders %>% tibble::rownames_to_column(var = "path") %>% arrange(desc(path)) %>% slice(1) %>% pull(path)

source("./R/preprocess.R") 

#create output folders
outFolder <- paste0("./output/",gsub("./data/","",dataFolder))
outChartsFolder <- paste0(outFolder,"/", chartsFolder)
dir.create(paste0(outChartsFolder,"/png"), recursive = TRUE, showWarnings = FALSE)
dir.create(paste0(outChartsFolder,"/svg"), recursive = TRUE, showWarnings = FALSE)

```

<!-- units conversion -->

```{r unitsConversion, echo=FALSE, include = FALSE}

# conversion factors
  EJ2Mtoe <- 23.8845896627496 # 1EJ = 23.8845896627496 Mtoe
  
  #1EJ <- 7 million tons #https://hydrogencouncil.com/wp-content/uploads/2017/11/Hydrogen-Scaling-up_Hydrogen-Council_2017.compressed.pdf
  #1 EJ is provided by 7 million tons or 78 billion cubic meters of gaseous hydrogen.
  #It is equivalent to 990 billion British thermal units, 278 TWh of electricity, and roughly 170 million barrels of oil or 290 billion cubic feet of natural gas.
  #1EJ <- 8 million tons adrian
  EJ2MtH2 <- 8
  
  EJ2TWh <- 1/0.0036

```



<!-- Markdown Data Section -->

<!-- Calculating results specifically for the paper -->
```{r calculatingPaperResults, echo=FALSE, include=FALSE}

mainScen <- "Nzero_57_bio7p5" # "Nzero_55_ff55Eff_bio7p5" #Nzero_55_ff55Eff_bio12" # #Nzero_55_bio12" #"Nzero_55_ff55Eff_bio12"
tgt2030Scen <- c(55,57,59)

#loading reference emissions
source("./R/calcResults.R") 

```  

---


# Data {.tabset}

<!-- Outputs -->

## Reference emissions 

```{r data_referenceEmissions, echo=FALSE}

selectedTgt %>%
  replace(is.na(.),"") %>% 
  select(target,region,period,tgt55,tgt57,tgt59,tgt61,tgt63,tgt65) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  

```

---

## Efficiency targets 

```{r data_efficiencyTargets, echo=FALSE}

effTgt %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  

```


---

## 2040 Emission Reductions

```{r data_emissionsReductions, echo=FALSE}

budget %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```


---

## Results

```{r data_results, echo=FALSE, fig.width=12, fig.height=5}

indirect_electrification %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

electricity_demand_upscale %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

electricity_share_in_FE %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

gen_upscale %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

wind_and_Solar_participation %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

Generation %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

share_of_fossil_in_electricity %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

primaryEnergy %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

primaryEnergyImports %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

fe_gas_and_hydrogen %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

FE_electricity %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

FE %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

share_of_sustainable_fuel %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

share_of_build_UE_heating %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

share_of_build_FE_in_relation_to_2020 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

BEVs_in_LDV %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

chemicals_df %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

other_industry_df %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 


```


---

## Carbon Management Results

```{r data_carbonManagement, echo=FALSE, fig.width=12, fig.height=5}

CDR %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```

---

## Milestones upscaling rates

```{r data_milestones, echo=FALSE, fig.width=12, fig.height=5}

electShare %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

FEbySector_change %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

renewablesShare %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

ElectricityShare %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

hydrogenProduction %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

ElectricityDemand %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

SolarPV %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

Wind %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

residualFossils %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```


<!-- Markdown Charts Section -->

<!-- Charts aesthetics -->
```{r chart_aesthetics, echo=FALSE, include=FALSE}

#loading theme and colors
source("./R/aesthetics.R") 

```

<!-- Initializing charts object -->
```{r chart_initialization, echo=FALSE}

g <- NULL

```


---

# Figure 1. Emission results panel

<!-- (a) Total GHG emissions (Mt CO2eq/yr)                    (b) Emission reductions (%) -->

```{r chart_figure1a_figure1b, echo=FALSE}

# all emission reductions were calculated relative to 1990 emissions with LULUCF and international transport (4814 Mt CO2e), except for 2030 emission reduction calculated relative to 1990 emissions with LULUCF and intra-EU aviation only (4713 Mt CO2e).

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen) %>% 
  calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T)  %>%
  group_by(model,region,variable,period) %>% 
  filter(tgt2050 != "Npi") %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

minValue <- min(plotData$value)

h <- refEmi %>% filter(variable == "Emissions with LULUCF and with international transport", region == "EU27", pollutant == "All greenhouse gases - (CO2 equivalent)") %>% ungroup() %>% select(region,variable,period,value)

emi1990 <- tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)
#linearProjection <- data.frame(period=c(2030,2035,2040,2045,2050),value=((1-seq(0,1,1/4))*(emi1990*(1-0.57))))

##emi2030 <- tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(tgt57)
emi2030 <- plotData %>% filter(scenario == mainScen, period == 2030) %>% pull(value)
linearProjection <- data.frame(period=c(2030,2035,2040,2045,2050),value=((1-seq(0,1,1/4))*(emi2030)))

g[["GHG emi"]] <- ggplot(plotData, aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    geom_ribbon(aes(ymax = ribbon.max, ymin = ribbon.min), alpha = 0.5, fill = "#545454") + 
    geom_line(data=plotData %>% filter(scenario == mainScen), linewidth=1.5) +
    #geom_line(data=plotData, color= "#545454", linewidth=0.2, alpha=0.2, aes(group=scenario)) +
    geom_line(data=h,linewidth=0.7,linetype="dashed") +
    geom_line(data=linearProjection,linewidth=0.8,linetype="dashed") +
    #geom_segment(data=plotData %>% filter(scenario == mainScen, period == 2040), aes(x=2040, xend=2040, y=0, yend=value), linetype="dashed", color="black") +
    geom_segment(data=linearProjection %>% filter(period == 2040), aes(x=2040, xend=2040, y=0, yend=value), linetype="dashed", color="black") +
    geom_point(data=plotData %>% filter(scenario == mainScen, period == 2040),size=3,shape=21,fill="white",stroke=1.5) +
    geom_point(data=linearProjection %>% filter(period == 2040),size=3,shape=21,fill="white",stroke=1.5) +
    geom_label_repel(data=data.frame(period=c(2042.5),value=mean(linearProjection %>% filter(period %in% c(2040,2045)) %>% pull(value))),
                     label = "linear reduction",
                     nudge_x = 10,
                     nudge_y = 800,
                     segment.square = TRUE,
                     point.padding = 0.6,
                     hjust = 0,
                     direction="y",
                     size = geomText.size) + 
    theme_doubleColumn() +
    theme(axis.title.y=element_blank()) +
    expand_limits(y=emi1990) +
    scale_y_continuous(breaks = c(0,1000,2000,3000,4000,5000)) +
    scale_x_continuous(breaks = seq(1990,2060,10)) +
    labs(title = expression(paste("(a) Total GHG emissions (Mt ", CO[2],"eq/yr)"))) + 
    #theme(plot.title = element_text(hjust = -0.2)) +
    theme(plot.title = element_text(margin=margin(b=20)))

plotData <- rbind(
  df %>% 
    filter(region == "EU27", period %in% c(2030:2040), tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>% 
    mutate(reduction = round(value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference) ,2)) %>% 
    select(-variable)
  ,
  df %>% 
    filter(region == "EU27", period %in% c(2045:2050), tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>% 
    mutate(reduction = round(value / tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference) ,2)) %>% 
    select(-variable)
  ) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(x=ifelse(reduction>=0,period+1,NA),
         xend=ifelse(reduction>=0,period+1,NA),
         y=ifelse(reduction>=0,1,NA),
         yend=ifelse(reduction>=0,ifelse(reduction<=0,0,reduction),NA),
         bar = ifelse(period==2040,"2040","emi"),
         #label = ifelse(value>0,paste0( "- ", (1-value) * 100, "% (-", (1-intraEURed) * 100 ,"%)"),NA),
         labelY = reduction + (1-reduction)/2,
         labelX=period+1) %>%
  group_by(model,region,period) %>% 
  mutate(max=max(reduction),
         min=min(reduction),
         range=max-min,
         label= ifelse(round((1-max) * 100) == round((1-min) * 100), paste0(round((1-max) * 100), "%"), paste0(round((1-max) * 100), "% to ", round((1-min) * 100) ,"%")))

g[["target"]] <- ggplot(data=plotData,aes(x=period,y=reduction,fill=bar)) +
  geom_bar(data=plotData %>% filter(scenario == mainScen), stat='identity', show.legend = FALSE, alpha = 0.7, color="black") +
  geom_errorbar(aes(ymin=min, ymax=max), width=1, colour="black", alpha=0.9, linewidth=1.3) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  scale_fill_manual(values = c("emi" = "black", "2040" = "#5a788b")) + 
  guides(y = "none") +
  geom_segment(data=plotData %>% filter(scenario == mainScen), aes(x=x, y=y, xend=xend, yend=yend), arrow = arrow(length=unit(.5, 'cm')), na.rm=TRUE) +
  geom_text(data=plotData %>% filter(scenario == mainScen), aes(label = label, y=labelY, x=labelX, color=factor(period)), vjust=-1, hjust=0.5, na.rm=TRUE, size = geomText.size, angle = 90) +
  scale_color_manual(values = c("2030" = "black", "2035" = "#777777","2040" = "black", "2045" = "#777777","2050" = "black"), breaks=c("2030", "2035","2040", "2045","2050")) +
  expand_limits(y=minValue/emi1990) +
  annotate("text", x=2052, y=1, label= "1990 emissions", vjust=-1, hjust=1, size = geomText.size) +
  geom_hline(yintercept=1, color = "black", linetype="dashed", linewidth=1.5, alpha = 0.5) +
  coord_cartesian(clip = 'off') +
  scale_y_continuous(breaks = c(0,1000/emi1990,2000/emi1990,3000/emi1990,4000/emi1990,5000/emi1990)) + 
  theme(legend.position = "none") +
  labs(title = "(b) Emission reductions (%)") + 
  theme(plot.title = element_text(margin=margin(b=20))) 

g[["GHG Emission reductions"]] <- gridExtra::arrangeGrob(
  g[["GHG emi"]], #+ theme(plot.margin=margin(10,10,30,10)),
  g[["target"]], # + theme(plot.margin=margin(10,10,10,10)),
  layout_matrix = rbind(c(1, 1, 1, 1, 2, 2),
                        c(1, 1, 1, 1, 2, 2))
   )
# 
#  ggsave(paste0(outChartsFolder,"/svg/Figure 1. Emission results panel - (a) GHG and (b) reduction.svg"), g[["GHG Emission reductions"]] , device="svg", width = 12, height = 5, dpi=100, units = "in")
#  ggsave(paste0(outChartsFolder,"/png/Figure 1. Emission results panel - (a) GHG and (b) reduction.png"), g[["GHG Emission reductions"]] , device="png", width = 12, height = 5, dpi=300, units = "in")


```

<!-- (c) Breakdown of residual CO2 emissions from energy and industrial processes (% in relation to 2020) -->

```{r chart_figure1c, echo=FALSE}

vars <- list(
  "Industrial\nProcesses" = "Emi|GHG|Industrial Processes",
  "Industry" = "Emi|GHG|Gross|Energy|Demand|Industry",
  "Buildings" ="Emi|GHG|Energy|Demand|Buildings",
  "Transportation" ="Emi|GHG|Energy|Demand|Transport",
  "Bunkers" = "Emi|CO2|Energy|Demand|Transport|International Bunkers",
#  "CDR" = "Emi|GHG|Gross|Energy|Demand|CDR",
#  "AFOFI" = "Emissions|CO2|Energy|Demand|AFOFI",
#  "Other Sector" ="Emissions|CO2|Energy|Demand|Other Sector",
  "Heat"="Emi|CO2|Gross|Energy|Supply|Heat",
  "Other Energy\nConversion" = "Emi|CO2|Gross|Other Energy Conversion",
    #"Hydrogen" ="Emi|CO2|Gross|Energy|Supply|Hydrogen",
    #"Liquids"="Emi|CO2|Gross|Energy|Supply|Liquids",
    #"Gases"="Emi|CO2|Gross|Energy|Supply|Gases",
    #"Solids"="Emi|CO2|Gross|Energy|Supply|Solids",
#  "Other"="Emissions|CO2|Energy|Supply|Other",
  "Electricity"="Emi|GHG|Gross|Energy|Supply|Electricity"
)
# "Emi|GHG|Agriculture",
#   "Emi|GHG|Land-Use Change",
#   "Emi|GHG|Waste",
#   "Emi|CO2|CDR|BECCS",
#   "Emi|CO2|CDR|Industry CCS|Synthetic Fuels",
#   "Emi|CO2|CDR|DACCS",
#   "Emi|CO2|CDR|EW"

plotColor <- c(
  "Electricity"= "#ffb200",
  "Heat"= "#cc0000",
  "Other Energy\nConversion" = "#0000cc",
  #"Gases"= "#999959",
  #"Liquids"= "#0000cc",
  #"Solids"= "#0c0c0c",
  #"Other" = "#79a6d2",
  #"Hydrogen" = "#5ed5b0",
  "Transportation" = "#a1dd70",
  "Bunkers" = "#ffc0cb",
  "Buildings" = "#5edfff",
  "Other Sector" = "#999959",
  "AFOFI" = "#005900",
  "Industry" = "#5f6769",
  "Industrial\nProcesses" = "#5c5c5c",
  "Other" = "#5b0d8f",
  "Waste" = "#A52A2A",
  "AFOLU" = "#4DAF4A",
  "Agriculture" = "#357933",
  "LULUCF" = "#6ec16b"
)


labels <- setNames(names(vars),vars[names(vars)])

fulldata <- df %>%
  filter(region == "EU27",
         period %in% c(2020,2030,2040),
         tgt2030 %in% tgt2030Scen,
         variable %in% unlist(vars)) %>%
  mutate(labels = factor(labels[as.character(variable)],levels = names(vars)),
         variable = factor(variable, levels = vars)) %>%
  group_by(period,variable) %>%
  mutate(min = min(value),
         max = max(value))

plotData <- fulldata %>%
  filter(scenario == mainScen) %>%
  mutate(complement = FALSE) %>%
  group_by(variable) %>%
  mutate(pct = paste0(round(value / value[period==2020],2)*100, "%")) %>%
  bind_rows(
    fulldata %>%
      filter(scenario == mainScen) %>%
      mutate(complement = TRUE) %>%
      group_by(variable) %>%
      mutate(value = value[period==2020] - value) %>%
      mutate(labels=NA)
  ) %>%
  mutate(ext_Var = ifelse(complement, paste0(as.character(variable),"_"), as.character(variable))) %>%
  arrange(period,ext_Var) %>%
  group_by(period) %>%
  arrange(variable) %>%
  mutate(ymid = as.numeric(sub("\\D+", "", period)),
         ymax = ymid + 4, ymin = ymid - 4,
         xmin = c(0, head(cumsum(value), -1)),
         xmax = cumsum(value),
         xmid = (xmax + xmin) / 2,
         ) %>%
  ungroup() %>%
  filter(complement == FALSE)

g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]] <- plotData %>% 
  ggplot(aes(xmid, ymid, fill = ext_Var)) +
  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
                alpha = factor(period), color = variable)) +
  geom_errorbar(data=plotData %>% filter(period == 2040), aes(xmin=xmax-value+min, xmax=xmax-value+max), width=4, colour="black", alpha=0.9, linewidth=0.8) +
  geom_text(data=plotData %>% filter(period == 2020), aes(y = 2015, label = labels, group = labels, hjust=1, angle = 90), vjust=0.5, hjust=1.1, na.rm=TRUE, size = geomText.size, angle = 90, lineheight = 0.8) +
  geom_text(data=plotData %>% filter(period == 2040), aes(x=xmid , y = 2045, label = pct), vjust=0.5, hjust=-0.1, na.rm=TRUE, size = geomText.size, angle = 90) +
  scale_fill_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) + 
  scale_alpha_manual(values = c(0.2, 0.3, 1)) +
  scale_color_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) +
  theme_doubleColumn() +
  theme(legend.position = "none") +
  scale_y_continuous(breaks=c(2020,2030,2040), labels=c("current",2030,2040), minor_breaks = NULL, limits=c(2008,2047)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank()) +
  scale_x_continuous(breaks = NULL) +
  coord_cartesian(clip="off") +
  theme(plot.margin = margin(t = 30, r = 0, b = 100, l = 0, unit = "pt")) +
  labs(title = "(c) Sectoral breakdown of residual gross CO2 emissions from energy and industrial processes (% of average 2018-2022)") + 
  theme(plot.title = element_text(margin=margin(t=0,r=0,b=35,l=-200), hjust=1))
  
# ggsave(paste0(outChartsFolder,"/svg/Figure 1. Emission results panel - (c) Energy and Industrial Processes.svg"), g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]] , device="svg", width = 12, height = 3.2, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 1. Emission results panel - (c) Energy and Industrial Processes.png"), g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]] , device="png", width = 12, height = 3.2, dpi=300, units = "in")


```


```{r, echo=FALSE, include=FALSE}

g[["Figure 1"]] <- gridExtra::arrangeGrob(
  g[["GHG emi"]],
  g[["target"]],
  g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]],
  layout_matrix = rbind(c(1, 1, 1, 1, 2, 2),
                        c(1, 1, 1, 1, 2, 2),
                        c(1, 1, 1, 1, 2, 2),
                        c(1, 1, 1, 1, 2, 2),
                        c(3, 3, 3, 3, 3, 3),
                        c(3, 3, 3, 3, 3, 3),
                        c(3, 3, 3, 3, 3, 3))
   )

ggsave(paste0(outChartsFolder,"/png/Figure 1. Emission results panel.png"), g[["Figure 1"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Figure 1. Emission results panel.svg"), g[["Figure 1"]], device="svg", width = 12, height = 8, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=8}

grid.newpage()
grid.draw(g[["Figure 1"]])

```

Figure 1. Greenhouse gas emission reductions for scenarios reaching climate neutrality by 2050. Central values are given for the reference scenario (57% reduction by 2030, reference final energy projections, biomass availability limited to 7.5 EJ/yr and default CCS assumption), ranges for the full scenario ensemble.

---


# Figure 2. Electricity panel

<!-- (a) Electricity Generation (%) -->

```{r chart_figure2a, echo=FALSE}

vars <- c(
  "Net Imports" = "SE|Electricity|Net Imports",
  "Coal w/ CC" = "SE|Electricity|Coal|w/ CC",
  "Coal w/o CC" = "SE|Electricity|Coal|w/o CC",
  "Oil" = "SE|Electricity|Oil",
  "Gas w/ CC" = "SE|Electricity|Gas|w/ CC",
  "Gas w/o CC" = "SE|Electricity|Gas|w/o CC",
  "Hydrogen" = "SE|Electricity|Hydrogen",
  "Nuclear" = "SE|Electricity|Nuclear",
  "Geothermal" = "SE|Electricity|Geothermal",
  "Hydro" = "SE|Electricity|Hydro",
  "Biomass w/ CC" = "SE|Electricity|Biomass|w/ CC",
  "Biomass w/o CC" = "SE|Electricity|Biomass|w/o CC",
  "Solar CSP" = "SE|Electricity|Solar|CSP",
  "Solar PV" = "SE|Electricity|Solar|PV",
  "Wind Onshore" = "SE|Electricity|Wind|Onshore",
  "Wind Offshore" = "SE|Electricity|Wind|Offshore")

inv_vars <- setNames(names(vars),vars)

color <- c(
  "Net Imports"   = "#472b62",
  "Coal w/ CC"    = "#b2b2b2",
  "Coal w/o CC"   = "#0c0c0c",
  "Oil"           = "#b30000",
  "Gas w/ CC"     = "#b79e38",
  "Gas w/o CC"    = "#999959",
  "Hydrogen"      = "#5ed5b0",
  "Nuclear"       = "#ff33ff",
  "Geothermal"    = "#e51900",
  "Hydro"         = "#191999",
  "Biomass w/ CC" = "#33ff00",
  "Biomass w/o CC"= "#005900",
  "Solar CSP"     = "#ffcc00",
  "Solar PV"      = "#ffe600",
  "Wind Onshore"  = "#193F7F",
  "Wind Offshore" = "#337fff")

plotData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario  == mainScen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=vars)) %>% 
  arrange(factor(variable, levels = rev(vars))) %>%
  group_by(model,scenario,region,period) %>%
  mutate(cumValue = cumsum(value),
         n = sum(value),
         percentage = value / n,
         cumPercentage = cumValue / n) 

plotData2040 <- plotData[plotData$period == 2040,]
#plotData$value <- plotData$value / plotData[plotData$period == "2020",]$value
#plotData$period <- as.character(plotData$period)
#plotData$period <- factor(plotData$period , levels = rev(c("2020","2030","2040","2050")))

plotData2040$xPos <- 2042.5
#plotData2040[plotData2040$variable %in% c("SE|Electricity|Hydro"),]$xPos <- 2028.5
#plotData2040[plotData2040$variable %in% c("SE|Electricity|Biomass|w/o CC"),]$xPos <- 2020
plotData2040[plotData2040$variable %in% c("SE|Electricity|Nuclear","SE|Electricity|Biomass|w/o CC"),]$xPos <- 2035

plotDataRenewables <- plotData %>%
  filter(variable %in% c("SE|Electricity|Geothermal","SE|Electricity|Hydro","SE|Electricity|Biomass|w/ CC","SE|Electricity|Biomass|w/o CC","SE|Electricity|Solar|CSP","SE|Electricity|Solar|PV","SE|Electricity|Wind|Onshore","SE|Electricity|Wind|Offshore","SE|Electricity|Nuclear")) %>%
  group_by(model,scenario,region,period) %>%
  summarize(percentage = sum(percentage),.groups = "keep")

g[["Electricity Generation"]] <- 
  ggplot(plotData,aes(x=period,y=percentage)) +
  geom_area(aes(fill=variable),alpha=0.4) +
  geom_line(data=plotDataRenewables, linetype = "dashed", linewidth = 1.5, color="#666666") +
  geom_bar(data=plotData2040,aes(fill=variable),stat='identity', show.legend = FALSE, alpha = 0.7, color="white", width = 3, linewidth = 1.5) +
  geom_text(data=plotData2040[plotData2040$percentage >= 0.02,],aes(label = paste0(round(percentage,2)*100,"%", ifelse(inv_vars[variable] %in% c("Solar PV","Wind Onshore","Wind Offshore"),paste0(" - ", inv_vars[variable]), "")), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size=geomText.size) +
  theme_doubleColumn()  +
  scale_y_continuous(minor_breaks = seq(0.2, 0.8, 0.2), breaks=c(0,1),labels = scales::percent) +
  scale_x_continuous(breaks=c(2020,2040,2060)) +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) +
  guides(fill=guide_legend(ncol=3,override.aes = list(alpha=1))) + #, byrow = TRUE
  annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, label = "renewables\nand nuclear", color = "#666666",angle = 90, hjust=0.5, vjust=-0.5, size=geomText.size, lineheight = 0.8) +
  annotate(geom = "text", x = 2020, y = (1-plotDataRenewables[plotDataRenewables$period == 2020,]$percentage)/2+plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "fossil", color = "#666666",angle = 90, hjust=0.5, vjust=-2, size=geomText.size) +
  annotation_custom(grob = linesGrob(gp=gpar(col="#666666",lwd = 3,lty="dashed")), xmin = 2016, xmax = 2019.8, ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage) +
  #annotate(geom = "text", label = "100%", x = 2020, y = 1, hjust=1.2, color = "#666666", size=geomText.size) +
  #annotate(geom = "text", label = "0%", x = 2020, y = 0, hjust=1.2, color = "#666666", size=geomText.size) +
  coord_cartesian(clip = 'off') +
  #theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 20, unit = "pt")) +
  labs(title = "(a) Electricity Generation (%)") #+ 
  #theme(plot.title = element_text(hjust = -0.1))

# ggsave(paste0(outChartsFolder,"/svg/Figure 2. Electricity panel - (a) generation.svg"), g[["Electricity Generation"]] , device="svg", width = 6, height = 10, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 2. Electricity panel - (a) generation.png"), g[["Electricity Generation"]] , device="png", width = 6, height = 10, dpi=300, units = "in")


# g[["Electricity Generation - wide"]] <- 
#   ggplot(plotData,aes(x=period,y=percentage)) +
#   geom_area(aes(fill=variable),alpha=0.4) +
#   geom_line(data=plotDataRenewables, linetype = "dashed", linewidth = 1.5, color="#666666") +
#   geom_bar(data=plotData2040,aes(fill=variable),stat='identity', show.legend = FALSE, alpha = 0.7, color="white", width = 3, linewidth = 1.5) +
#   geom_text(data=plotData2040[plotData2040$percentage >= 0.02,],aes(label = paste0(round(percentage,2)*100,"%", ifelse(inv_vars[variable] %in% c("Solar PV","Wind Onshore","Wind Offshore"),paste0(" - ", inv_vars[variable]), "")), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size=geomText.size) +
#   theme_doubleColumn()  +
#   scale_y_continuous(minor_breaks = seq(0.2, 0.8, 0.2), breaks=c(0,1),labels = scales::percent) +
#   scale_x_continuous(breaks=c(2020,2040,2060)) +
#   scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) +
#   theme(legend.position="right") +
#   theme(legend.margin=margin(b = -2, unit='cm'))

#ggsave(paste0(outFolder_conference,"/Electricity Generation - wide.svg"), g[["Electricity Generation - wide"]] , device="svg", width = 12, height = 5, dpi=100, units = "in")
#ggsave(paste0(outFolder_conference,"/Electricity Generation - wide.png"), g[["Electricity Generation - wide"]] , device="png", width = 12, height = 5, dpi=300, units = "in")

```


<!-- (b) Solar Photovoltaics capacity (GW) -->

```{r chart_figure2b, echo=FALSE}

# Solar photovoltaics roll out
plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen, variable == "Cap|Electricity|Solar|PV") %>% 
  filter(tgt2050 != "Npi") %>% 
  group_by(model,region,variable,period) %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

target <- data.frame(target=c("REPowerEU","REPowerEU"),period=c(2025,2030),value=c(320,600)) 

#value <- data.frame(period=c(2025,2030,2040),value=c(plotData[plotData$period==2025,]$value,plotData[plotData$period==2030,]$value,plotData[plotData$period==2040,]$value))

# historical data
h <- hist %>% filter(model == "IRENA", region == "EU27", variable == "Cap|Electricity|Solar|PV", period >= 2005) %>% drop_na(value)

yendValue <- plotData %>% filter(scenario == mainScen, period == 2040) %>% pull(value)

g[["Solar_Photovoltaics_capacity"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    geom_segment(aes(x=2040, y=0, xend=2040, yend=yendValue), linetype="dashed", color="black") +
    geom_ribbon(aes(ymax = ribbon.max, ymin = ribbon.min), alpha = 0.5, fill = "#545454") + 
    geom_line(data=plotData %>% filter(scenario == mainScen),linewidth=1.5) +
    geom_line(data=h,linewidth=1,linetype="dashed") +
    geom_point(data=plotData %>% filter(scenario == mainScen, period %in% c(2030,2040)),size=3,shape=21,fill="white",stroke=1.5) +
    geom_point(data=target, size=3, shape=4, stroke = 1.5) +
    geom_label_repel(data=target, aes(label = paste0(round(value),"GW - ", target)),box.padding = 0.1,
                  #segment.curvature = -0.1,
                  segment.square = TRUE,
                  point.padding = 0.6,
                  nudge_x = 5,
                  #nudge_y = -0.02,
                  #force = 0.5,
                  hjust = 0,
                  direction="y", size = geomText.size, xlim = c(2020, 2070)) +
  geom_label_repel(data=plotData %>% filter(scenario == mainScen, period == 2030), aes(label = paste0(round(value),"GW")),box.padding = 0.1,
                  point.padding = 1,
                  nudge_x = -2,
                  nudge_y = 500,
                  hjust = 1, direction="y",
                  size = geomText.size) +
  geom_label_repel(data=plotData %>% filter(scenario == mainScen, period == 2040), aes(label = paste0(round(value),"GW")),box.padding = 0.1,
                  point.padding = 1,
                  nudge_x = -2,
                  nudge_y =500,
                  #hjust = 0, 
                  direction="y",
                  size = geomText.size) +
    theme_doubleColumn() + 
    coord_cartesian(clip = 'off') +
    expand_limits(y = 3000) +
    labs(title = "(b) Solar Photovoltaics capacity (GW)") #+ 
    #theme(plot.title = element_text(hjust = -0.4))

# ggsave(paste0(outChartsFolder,"/svg/Figure 2. Electricity panel - (b) solar.svg"), g[["Solar_Photovoltaics_capacity"]] , device="svg", width = 6, height = 4, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 2. Electricity panel - (b) solar.png"), g[["Solar_Photovoltaics_capacity"]] , device="png", width = 6, height = 4, dpi=300, units = "in")


```


<!-- (c) Electricity share in final energy (%) -->


```{r chart_figure2c, echo=FALSE}

# Electricity share
vars <- c("Total" = "Final Energy|Electricity Share",
          "Transport"="Final Energy|Transport|Electricity Share",
          "Industry"="Final Energy|Industry|Electricity Share",
          "Buildings"="Final Energy|Buildings|Electricity Share")

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>% 
  group_by(model,region,variable,period) %>% 
  filter(tgt2050 != "Npi") %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

h_Orig <- hist[hist$model == "IEA" & hist$region == "EU27" & hist$variable %in% c("FE","FE|Electricity","FE|Transport","FE|Transport|Electricity","FE|Industry", "FE|Industry|Electricity","FE|Buildings","FE|Buildings|Electricity"),] %>% drop_na(value)
  
h <- rbind(
  h_Orig %>% calc_addVariable("`Final Energy|Electricity Share`" = "`FE|Electricity` / `FE`", units = "%", only.new=T),
  h_Orig %>% calc_addVariable("`Final Energy|Transport|Electricity Share`" = "`FE|Transport|Electricity` / `FE|Transport`", units = "%", only.new=T),
  h_Orig %>% calc_addVariable("`Final Energy|Industry|Electricity Share`"  = "`FE|Industry|Electricity`  / `FE|Industry`", units = "%", only.new=T),
  h_Orig %>% calc_addVariable("`Final Energy|Buildings|Electricity Share`" = "`FE|Buildings|Electricity` / `FE|Buildings`", units = "%", only.new=T))


g[["Electricity_Share"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    geom_segment(aes(x=2040, y=0, xend=2040, yend=max(plotData %>% filter(scenario == mainScen, period == 2040) %>% pull(value))), linetype="dashed", color="black") +
    geom_ribbon(aes(ymax = ribbon.max, ymin = ribbon.min, fill=variable), alpha = 0.3) + 
    geom_line(data=plotData %>% filter(scenario == mainScen), linewidth=1.5,aes(color=variable)) +
    #geom_line(data=h,linewidth=1,linetype="dashed") +
    geom_point(data=plotData %>% filter(scenario == mainScen, period == 2040),size=3,shape=21,fill="white",stroke=1.5) +
    geom_line(data=h %>% filter(period >= 2005),linetype="dashed", linewidth = 1, aes(color=variable)) +
    geom_label_repel(data= plotData %>% filter(scenario == mainScen, period == 2040),
                         aes(
                           label = paste0(round(value*100),"%")),
                      box.padding = 3,
                      #segment.curvature = -0.1,
                      segment.square = TRUE,
                      point.padding = 0.6,
                      nudge_x = 5,
                      nudge_y = c(0.55,0.27,-0.05,-0.6),
                      #force = 0.5,
                      #hjust = 0,
                      direction="y"
                      , size = geomText.size
                      #, xlim = c(2020, 2070)
                      ) +
    scale_colour_manual(values = c("Final Energy|Electricity Share"="black","Final Energy|Transport|Electricity Share"="#a1dd70","Final Energy|Industry|Electricity Share"="#5f6769","Final Energy|Buildings|Electricity Share"="#5edfff"), labels = setNames(names(vars), vars)) +
    scale_fill_manual(values = c("Final Energy|Electricity Share"="black","Final Energy|Transport|Electricity Share"="#a1dd70","Final Energy|Industry|Electricity Share"="#5f6769","Final Energy|Buildings|Electricity Share"="#5edfff"), labels = setNames(names(vars), vars)) +
    theme_doubleColumn() + 
    scale_y_continuous(breaks = seq(0, 1, 0.2),labels = scales::percent) +
    expand_limits(y=c(0,1)) +
    guides(color=guide_legend(nrow=2)) +
    labs(title = "(c) Electricity share in final energy (%)\n    (includes bunker fuels and non-energy use)") #+ 
    #theme(plot.title = element_text(hjust = -0.4))

# ggsave(paste0(outChartsFolder,"/svg/Figure 2. Electricity panel - (c) electrification.svg"), g[["Electricity_Share"]] , device="svg", width = 6, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 2. Electricity panel - (c) electrification.png"), g[["Electricity_Share"]] , device="png", width = 6, height = 6, dpi=300, units = "in")


```


```{r, echo=FALSE, include=FALSE}

g[["Figure 2"]] <- gridExtra::arrangeGrob(
  g[["Electricity Generation"]],
  g[["Solar_Photovoltaics_capacity"]],
  g[["Electricity_Share"]],
  layout_matrix = rbind(c(1,1, 2,2),
                        c(1,1, 2,2),
                        c(1,1, 2,2),
                        c(1,1, 3,3),
                        c(1,1, 3,3),
                        c(1,1, 3,3),
                        c(1,1, 3,3))
   )

ggsave(paste0(outChartsFolder,"/png/Figure 2. Electricity supply and demand.png"), g[["Figure 2"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Figure 2. Electricity supply and demand.svg"), g[["Figure 2"]], device="svg", width = 12, height = 8, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=8}

grid.newpage()
grid.draw(g[["Figure 2"]])

```



---

# Figure 3. Energy supply panel

<!-- (a) Primary energy -->

```{r chart_figure3a, echo=FALSE}

# Primary Energy
vars <- c("Oil"="PE|Oil",
          "Gas"="PE|Gas",
          "Coal"="PE|Coal",
          "Biomass" = "PE|Biomass")

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=vars))  %>% 
  group_by(model,region,variable,period) %>% 
  filter(tgt2050 != "Npi") %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

# historical data
h <- hist %>% filter(model == "IEA", region == "EU27", variable %in% vars, period >= 2005, period <= 2020) %>% drop_na(value) %>% filter(value != 0)

# convert unit if necessary
if(energyInMtoe){
  plotData <- plotData %>%
    mutate(value = value * EJ2Mtoe,
           ribbon.min = ribbon.min * EJ2Mtoe,
           ribbon.max = ribbon.max * EJ2Mtoe,
           unit = "Mtoe/yr")
  h <- h %>%
    mutate(value = value * EJ2Mtoe,
           unit = "Mtoe/yr")
}

g[["Primary Energy"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    geom_segment(aes(x=2040, y=0, xend=2040, yend=max(plotData %>% filter(scenario == mainScen, period == 2040) %>% pull(value))), linetype="dashed", color="black") +
    geom_line(data=plotData %>% filter(scenario == mainScen), aes(color=variable), linewidth=1.5) +
    geom_line(data=h,aes(color=variable),linewidth=1,linetype="dashed") +
    geom_ribbon(aes(ymax = ribbon.max, ymin = ribbon.min, fill=variable), alpha = 0.3) + 
    #geom_point(data=plotData[plotData$period %in% c(2020,2030,2040),],size=4,shape=21,fill="white") +
    geom_point(data=plotData %>% filter(scenario == mainScen, period == 2040),aes(color=variable),size=3,shape=21,fill="white",stroke=1.5) +
    #annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "renewables\nand nuclear", color = "#666666",angle = 26, hjust=0, vjust=1, size=geomText.size) +
    scale_color_manual(values = c(setNames(options$aesthetics$legend$color[names(vars)],vars)), labels = setNames(names(vars), vars)) +
    scale_fill_manual(values = c(setNames(options$aesthetics$legend$color[names(vars)],vars)), labels = setNames(names(vars), vars)) +
    theme_doubleColumn() + 
    expand_limits(y=c(0,1)) +
    guides(color=guide_legend(nrow=1)) +
    expand_limits(y = 30) +
    theme(legend.margin=margin(l = -2, unit='cm')) +
    labs(title = paste0("(a) Primary energy demand (", unique(plotData$unit), ")")) #+ 
    #theme(plot.title = element_text(hjust = -0.3))
    #guides(fill = FALSE) 

# ggsave(paste0(outChartsFolder,"/svg/Figure 3. Energy supply panel - (a) primary energy.svg"), g[["Primary Energy"]] , device="svg", width = 6, height = 5, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 3. Energy supply panel - (a) primary energy.png"), g[["Primary Energy"]] , device="png", width = 6, height = 5, dpi=300, units = "in")

```

<!-- (c) Natural gas and syngas final energy demand -->

```{r chart_figure3c, echo=FALSE}

vars <- c(
  "Hydrogen"="FE|Hydrogen",
  "Gases"="FE|Gases"
  #"Syngas" = "FE|Gases|Hydrogen",
  #"Biogas" = "FE|Gases|Biomass",
  #"Natural gas" = "FE|Gases|Fossil"
)

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020,2030,2040,2050), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars), tgt2050 != "Npi") %>% 
  mutate(variable = factor(variable, levels=vars))  %>% 
  group_by(model,scenario,region,period) %>% 
  mutate(cumsum = cumsum(value),
         sum = sum(value)) %>% 
  group_by(model,region,variable,period) %>% 
  mutate(ribbon.max=max(cumsum),
         ribbon.min=min(cumsum)) %>% 
  group_by(model,region,period) %>% 
  mutate(ribbon.max.total=max(sum),
         ribbon.min.total=min(sum))

# convert unit if necessary
if(energyInMtoe){
  plotData <- plotData %>%
    mutate(value = value * EJ2Mtoe,
           ribbon.min = ribbon.min * EJ2Mtoe,
           ribbon.max = ribbon.max * EJ2Mtoe,
           ribbon.min.total = ribbon.min.total * EJ2Mtoe,
           ribbon.max.total = ribbon.max.total * EJ2Mtoe,
           unit = "Mtoe/yr")
}

g[["FE Gases"]] <- 
  ggplot(plotData,aes(x=period,y=value)) +
  geom_col(data=plotData %>% filter(scenario == mainScen), aes(fill = variable, alpha=factor(period))) +
  #geom_errorbar(data=plotData %>% filter(period != 2020), aes(ymin=ribbon.min, ymax=ribbon.max, group=variable), width=8, colour="black", alpha=0.9, size=1,position = position_dodge(width=2)) +
  geom_errorbar(data=plotData %>% filter(period != 2020, variable == vars[1], scenario == mainScen), aes(ymin=ribbon.min.total, ymax=ribbon.max.total), width=4, colour="black", alpha=0.9, linewidth=1,position = position_dodge(width=2)) +
  # scale_y_continuous(labels = scales::percent, breaks = c(0,1,plotData[plotData$period == "2030",]$value,plotData[plotData$period == "2040",]$value,plotData[plotData$period == "2050",]$value)) +
  coord_flip() +
  theme_doubleColumn() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank()) +
  #guides(y = "none") +
  theme(axis.title.y=element_blank()) +
  #theme(legend.position = "none") #+
  scale_fill_manual(values = setNames(options$aesthetics$legend$color[names(vars)],vars), labels = setNames(names(vars), vars), guide = guide_legend(reverse = TRUE, nrow = 1)) +
  scale_alpha_manual(values = c("2020"=0.7,"2030"=0.7,"2040"=1,"2050"=0.7), guide = 'none') +
  #theme(legend.text=element_text(size=theme.double.text.size)) +
  #scale_y_continuous(breaks = seq(0,round(ceiling(max(plotData$ribbon.max.total)),0),2)) +
  scale_y_continuous(  labels = scales::number_format(accuracy = 1)) +
  expand_limits(y=c(0,round(ceiling(max(plotData$ribbon.max.total)),0))) + 
  #scale_y_continuous(breaks = c(0,round(sum(plotData %>% filter(scenario == mainScen, period == 2020) %>% pull(value)),1),round(sum(plotData %>% filter(scenario == mainScen, period == 2030) %>% pull(value)),1),round(sum(plotData %>% filter(scenario == mainScen, period == 2040) %>% pull(value)),1))) +
  #scale_x_reverse()
  theme(legend.margin=margin(l = -2, unit='cm')) +
  labs(title = paste0("(c) Gaseous final energy demand (", unique(plotData$unit), ")")) #+ 
  #theme(plot.title = element_text(hjust = -0.5))

# ggsave(paste0(outChartsFolder,"/svg/Figure 3. Energy supply panel - (c) final energy gases.svg"), g[["FE Gases"]] , device="svg", width = 6, height = 4, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 3. Energy supply panel - (c) final energy gases.png"), g[["FE Gases"]] , device="png", width = 6, height = 4, dpi=300, units = "in")


```

<!-- (b) Fossil trade -->

```{r chart_figure3b, echo=FALSE}

vars <- list(
 "Oil" = c("Trade|Imports|Oil","Trade|Exports|Oil"),
 "Gas" = c("Trade|Imports|Gas|Adj","Trade|Exports|Gas|Adj"),
 "Coal" = c("Trade|Imports|Coal","Trade|Exports|Coal"),
 "Biomass" = c("Trade|Imports|Biomass","Trade|Exports|Biomass")
)

carrier <- c()
for(c in names(vars)){
  for(var in vars[[c]]){
    v <- c
    names(v) <- var
    carrier <- c(carrier,v)
  }
}

plotColor <- c(
  "Imports"= "#e56b6f",
  "Exports"= "#355070"
)

# with range
plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020,2030,2040,2050), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars), tgt2050 != "Npi") %>% 
  #mutate(variable = factor(variable, levels=vars))  %>%
  mutate(type = ifelse(grepl("Imports",variable),"Imports","Exports"),
         carrier = carrier[as.character(variable)]) %>%
  filter(carrier != "Biomass") %>%
  mutate(value = ifelse(type == "Exports", -value,value)) %>%
  mutate(carrier = factor(carrier, levels=c("Oil","Gas","Coal","Biomass"))) %>%
  group_by(model,scenario,region,unit,period,carrier) %>%
  summarize(value=sum(value),.groups = "keep") %>%
  mutate(type="EU-27 Net-trade") %>%
  group_by(model,region,carrier,period) %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

# convert unit if necessary
if(energyInMtoe){
  plotData <- plotData %>%
    mutate(value = value * EJ2Mtoe,
           ribbon.min = ribbon.min * EJ2Mtoe,
           ribbon.max = ribbon.max * EJ2Mtoe,
           unit = "Mtoe/yr")
}

g[["security of supply - net fossil with range"]] <- 
  ggplot(plotData,aes(x=period,y=value)) +
  geom_col(data=plotData %>% filter(scenario == mainScen), aes(fill = factor(period), alpha=factor(period))) +
  geom_errorbar(data=plotData %>% filter(period == 2040, scenario == mainScen), aes(ymin=ribbon.min, ymax=ribbon.max), width=4, colour="black", alpha=0.9, linewidth=1,position = position_dodge(width=2)) +
  # scale_y_continuous(labels = scales::percent, breaks = c(0,1,plotData[plotData$period == "2030",]$value,plotData[plotData$period == "2040",]$value,plotData[plotData$period == "2050",]$value)) +
  #coord_flip() +
  facet_wrap(~carrier,nrow=1) +
  theme_doubleColumn() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_fill_manual(values = c("2020" = "black", "2030"= "black", "2040" = "#5a788b", "2050" = "black")) +
  scale_alpha_manual(values = c("2020"=0.7,"2030"=0.7,"2040"=1,"2050"=0.7), guide = 'none') +
  theme(legend.position = "none") +
  labs(title = paste0("(b) Fossil energy carriersâ€™ net imports (", unique(plotData$unit), ")")) #+ 
  #theme(plot.title = element_text(hjust = -0.4))

# ggsave(paste0(outChartsFolder,"/svg/Figure 3. Energy supply panel - (b) fossil security of supply.svg"), g[["security of supply - net fossil with range"]] , device="svg", width = 6, height = 4.5, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 3. Energy supply panel - (b) fossil security of supply.png"), g[["security of supply - net fossil with range"]] , device="png", width = 6, height = 4.5, dpi=300, units = "in")

```

<!-- (d) Hydrogen production (EJ/yr) -->

```{r chart_figure3d, echo=FALSE}

vars <- c(
  "Black H2 (coal)" = "SE|Hydrogen|Coal|w/o CC",
  "Gray H2 (gas)" = "SE|Hydrogen|Gas|w/o CC",
  "Blue H2 (fossil w/ CCS)" = c("SE|Hydrogen|Coal|w/ CC", "SE|Hydrogen|Gas|w/ CC"),
  "H2 imports" = "SE|Hydrogen|Net Imports",
#  "Bio-based H2 (gasification)" = c("SE|Hydrogen|Biomass|w/ CC","SE|Hydrogen|Biomass|w/o CC"),
#  "Green H2 (electrolysis)" = "SE|Hydrogen|Electricity",
  "Green and bio-based H2" = c("SE|Hydrogen|Electricity", "SE|Hydrogen|Biomass|w/ CC","SE|Hydrogen|Biomass|w/o CC")
  #"VRE Storage Electrolysis" = "SE|Hydrogen|Electricity|VRE Storage Electrolysis",
  #"Standard Electrolysis" = "SE|Hydrogen|Electricity|Standard Electrolysis",
  )

color <- c(
  "Black H2 (coal)" = "#000000",
  "Gray H2 (gas)" = "#88888a",
  "Blue H2 (fossil w/ CCS)" = "#02abed",
  "H2 imports" = "#c18f4a",
  "Bio-based H2 (gasification)" = "#2eab83",
  "Green H2 (electrolysis)" = "#a1c44e",
  "Green and bio-based H2" = "#2eab83"
  )
#color <- setNames(options$aesthetics$legend$color[names(vars)],vars)
#color["SE|Hydrogen|Biomass|w/ CC"] <- color["SE|Hydrogen|Biomass|w/o CC"]

invertVars <- setNames(names(vars),vars)

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020,2030,2040,2050), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>% 
  mutate(type = gsub("\\d$", "", as.character(invertVars[as.character(variable)]))) %>%
  group_by(model,scenario,region,unit,period,type) %>%
  summarize(value=sum(value),.groups = "keep") %>%
  mutate(type=factor(type, levels=unique(gsub("\\d$", "", names(vars))))) %>%
  #mutate(value = value*8) %>% #1EJ <- 8 million tons adrian
  group_by(model,scenario,region,period) %>% 
  mutate(cumsum = cumsum(value),
         sum = sum(value)) %>% 
  group_by(model,region,type,period) %>% 
  mutate(ribbon.max=max(cumsum),
         ribbon.min=min(cumsum)) %>% 
  group_by(model,region,period) %>% 
  mutate(ribbon.max.total=max(sum),
         ribbon.min.total=min(sum))

target <- data.frame(target=c("REPowerEU","REPowerEU"),type=c("domestic","total"),period=c(2030,2030),value=c(10,20)) %>%
  mutate(value = value/EJ2MtH2)

# convert unit if necessary
if(energyInMtoe){
  plotData <- plotData %>%
    mutate(value = value * EJ2MtH2,
           ribbon.min = ribbon.min * EJ2MtH2,
           ribbon.max = ribbon.max * EJ2MtH2,
           ribbon.min.total = ribbon.min.total * EJ2MtH2,
           ribbon.max.total = ribbon.max.total * EJ2MtH2,
           unit = "Mt H2/yr")
  
  target <- target %>%
    mutate(value = value * EJ2MtH2)
}

g[["Hydrogen"]] <- 
  ggplot(plotData,aes(x=period,y=value)) +
  geom_hline(yintercept= target %>% filter(type == "domestic", period == 2030) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = 2015, y = target %>% filter(type == "domestic", period == 2030) %>% pull(value), label = "REPowerEU\ndomestic", angle=90, vjust = 0.4, hjust = 0, color = "black", alpha = 0.5, size = geomText.size) +
  geom_hline(yintercept= target %>% filter(type == "total", period == 2030) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = 2015, y = target %>% filter(type == "total", period == 2030) %>% pull(value), label = "REPowerEU\ntotal", angle=90, vjust = 0.4, hjust = 0, color = "black", alpha = 0.5, size = geomText.size) +
  geom_col(data=plotData %>% filter(scenario == mainScen), aes(fill = type, alpha=factor(period))) +
  geom_errorbar(data=plotData %>% filter(period != 2020, type == names(vars)[1], scenario == mainScen), aes(ymin=ribbon.min.total, ymax=ribbon.max.total), width=4, colour="black", alpha=0.9, linewidth=1,position = position_dodge(width=2)) +
  coord_flip() +
  theme_doubleColumn() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_fill_manual(values = color,
                    #labels = setNames(names(vars), vars)[c("SE|Hydrogen|Electricity", "SE|Hydrogen|Gas|w/o CC", "SE|Hydrogen|Biomass|w/ CC")],
                    #breaks = c("SE|Hydrogen|Electricity", "SE|Hydrogen|Gas|w/o CC", "SE|Hydrogen|Biomass|w/ CC"), 
                    guide = guide_legend(nrow = 3, reverse = TRUE)) +
  scale_alpha_manual(values = c("2020"=0.7,"2030"=0.7,"2040"=1,"2050"=0.7), guide = 'none') +
  #theme(legend.text=element_text(size=theme.double.text.size)) +
  #scale_y_continuous(breaks = seq(0,6,1)) +
  #scale_y_continuous(breaks = seq(0,round(ceiling(max(plotData$ribbon.max.total)),0),1)) +
  scale_y_continuous(  labels = scales::number_format(accuracy = 1)) +
  theme(legend.margin=margin(l = -2, unit='cm')) +
  labs(title = paste0("(d) Hydrogen production (", unique(plotData$unit), ")")) #+ 
  #theme(plot.title = element_text(hjust = -0.4))
  
# ggsave(paste0(outChartsFolder,"/svg/Figure 3. Energy supply panel - (d) hydrogen.svg"), g[["Hydrogen"]] , device="svg", width = 6, height = 4, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 3. Energy supply panel - (d) hydrogen.png"), g[["Hydrogen"]] , device="png", width = 6, height = 4, dpi=300, units = "in")


```


```{r, echo=FALSE, include=FALSE}

g[["Figure 3"]] <- gridExtra::arrangeGrob(
  g[["Primary Energy"]] + theme(plot.title = element_text(margin=margin(b=28)), plot.margin=margin(b = 10, r=10)),
  g[["security of supply - net fossil with range"]] + theme(plot.margin=margin(t = 0, b = 47, l=10)),
  g[["FE Gases"]] + theme(legend.margin=margin(b = 27, t = 10)) + theme(plot.margin=margin(r=10)),
  g[["Hydrogen"]] + theme(plot.margin=margin(l=10)),
  layout_matrix = rbind(c(1,2),
                        c(3,4))
   )

ggsave(paste0(outChartsFolder,"/png/Figure 3. Fuel Supply and Demand.png"), g[["Figure 3"]], device="png", width = 12, height = 10, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Figure 3. Fuel Supply and Demand.svg"), g[["Figure 3"]], device="svg", width = 12, height = 10, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=10}

grid.newpage()
grid.draw(g[["Figure 3"]])

```

---

# Figure 4. Demand panel


<!-- (a) Transport final energy -->

```{r chart_figure4a, echo=FALSE}

if("FE|Transport|Freight|Navigation|Liquids|Fossil" %in% unique(df$variable)){
  FEvars <- list(
    "Domestic" = list(
      "LDV" = c(
        "FE|Transport|Pass|Road|LDV|Electricity" = "Electricity",
        "FE|Transport|Pass|Road|LDV|Gases" = "Gases",
        "FE|Transport|Pass|Road|LDV|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Road|LDV|Liquids" = "Liquids"
         "FE|Transport|Pass|Road|LDV|Liquids|Fossil" = "Liquids - Fossil",
         "FE|Transport|Pass|Road|LDV|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Road|LDV|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Buses" = c(
        "FE|Transport|Pass|Road|Bus|Electricity" = "Electricity",
        "FE|Transport|Pass|Road|Bus|Gases" = "Gases",
        "FE|Transport|Pass|Road|Bus|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Road|Bus|Liquids" = "Liquids"
          "FE|Transport|Pass|Road|Bus|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Road|Bus|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Road|Bus|Liquids|Hydrogen" = "Liquids - Synthetic"
  
      ),
      "Trucks" = c(
        "FE|Transport|Freight|Road|Electricity" = "Electricity",
        "FE|Transport|Freight|Road|Gases" = "Gases",
        "FE|Transport|Freight|Road|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|Road|Liquids" = "Liquids"
          "FE|Transport|Freight|Road|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|Road|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|Road|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Rail" = c(
        "FE|Transport|Pass|Rail|Electricity" = "Electricity",
        "FE|Transport|Pass|Rail|Gases" = "Gases",
        "FE|Transport|Pass|Rail|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Rail|Liquids" = "Liquids",
          "FE|Transport|Pass|Rail|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Rail|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Rail|Liquids|Hydrogen" = "Liquids - Synthetic",
        "FE|Transport|Freight|Rail|Electricity" = "Electricity",
        "FE|Transport|Freight|Rail|Gases" = "Gases",
        "FE|Transport|Freight|Rail|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|Rail|Liquids" = "Liquids"
          "FE|Transport|Freight|Rail|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|Rail|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|Rail|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Aviation" = c(
        "FE|Transport|Pass|Aviation|Domestic|Electricity" = "Electricity",
        "FE|Transport|Pass|Aviation|Domestic|Gases" = "Gases",
        "FE|Transport|Pass|Aviation|Domestic|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Aviation|Domestic|Liquids" = "Liquids"
          "FE|Transport|Pass|Aviation|Domestic|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Aviation|Domestic|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Aviation|Domestic|Liquids|Hydrogen" = "Liquids - Synthetic"
      )
    ),
    "International" = list(
      "Aviation" = c(
        "FE|Transport|Pass|Aviation|International|Electricity" = "Electricity",
        "FE|Transport|Pass|Aviation|International|Gases" = "Gases",
        "FE|Transport|Pass|Aviation|International|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Aviation|International|Liquids" = "Liquids"
          "FE|Transport|Pass|Aviation|International|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Aviation|International|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Aviation|International|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Shipping" = c(
        "FE|Transport|Freight|Navigation|Electricity" = "Electricity",
        "FE|Transport|Freight|Navigation|Gases" = "Gases",
        "FE|Transport|Freight|Navigation|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|Navigation|Liquids" = "Liquids",
          "FE|Transport|Freight|Navigation|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|Navigation|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|Navigation|Liquids|Hydrogen" = "Liquids - Synthetic",
        "FE|Transport|Freight|International Shipping|Electricity" = "Electricity",
        "FE|Transport|Freight|International Shipping|Gases" = "Gases",
        "FE|Transport|Freight|International Shipping|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|International Shipping|Liquids" = "Liquids"
          "FE|Transport|Freight|International Shipping|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|International Shipping|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|International Shipping|Liquids|Hydrogen" = "Liquids - Synthetic"
      )
    )
  )

} else {
  FEvars <- list(
    "Domestic" = list(
      "LDV" = c(
        "FE|Transport|Pass|Road|LDV|Electricity" = "Electricity",
        "FE|Transport|Pass|Road|LDV|Gases" = "Gases",
        # "FE|Transport|Pass|Road|LDV|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Pass|Road|LDV|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Pass|Road|LDV|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Pass|Road|LDV|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Road|LDV|Liquids" = "Liquids"
         "FE|Transport|Pass|Road|LDV|Liquids|Fossil" = "Liquids - Fossil",
         "FE|Transport|Pass|Road|LDV|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Road|LDV|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Buses" = c(
        "FE|Transport|Pass|Road|Bus|Electricity" = "Electricity",
        "FE|Transport|Pass|Road|Bus|Gases" = "Gases",
        # "FE|Transport|Pass|Road|Bus|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Pass|Road|Bus|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Pass|Road|Bus|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Pass|Road|Bus|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Road|Bus|Liquids" = "Liquids"
          "FE|Transport|Pass|Road|Bus|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Road|Bus|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Road|Bus|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Trucks" = c(
        "FE|Transport|Freight|Road|Electricity" = "Electricity",
        "FE|Transport|Freight|Road|Gases" = "Gases",
        # "FE|Transport|Freight|Road|Bus|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Freight|Road|Bus|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Freight|Road|Bus|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Freight|Road|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|Road|Liquids" = "Liquids"
          "FE|Transport|Freight|Road|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|Road|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|Road|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Rail" = c(
        "FE|Transport|Pass|Rail|Electricity" = "Electricity",
        "FE|Transport|Pass|Rail|Gases" = "Gases",
        # "FE|Transport|Pass|Rail|Bus|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Pass|Rail|Bus|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Pass|Rail|Bus|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Pass|Rail|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Rail|Liquids" = "Liquids",
          "FE|Transport|Pass|Rail|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Rail|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Rail|Liquids|Hydrogen" = "Liquids - Synthetic",
        "FE|Transport|Freight|Rail|Electricity" = "Electricity",
        "FE|Transport|Freight|Rail|Gases" = "Gases",
        # "FE|Transport|Freight|Rail|Bus|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Freight|Rail|Bus|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Freight|Rail|Bus|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Freight|Rail|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Freight|Rail|Liquids" = "Liquids"
          "FE|Transport|Freight|Rail|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Freight|Rail|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Freight|Rail|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
  #     "Shipping" = c(
  #       "FE|Transport|Freight|Domestic Shipping|Electricity" = "Electricity",
  #       "FE|Transport|Freight|Domestic Shipping|Gases" = "Gases",
  #       # "FE|Transport|Freight|Domestic Shipping|Gases|Fossil" = "Gases - Fossil",
  #       # "FE|Transport|Freight|Domestic Shipping|Gases|Biomass" = "Gases - Biomass",
  #       # "FE|Transport|Freight|Domestic Shipping|Gases|Hydrogen" = "Gases - Synthetic",
  #       "FE|Transport|Freight|Domestic Shipping|Hydrogen" = "Hydrogen",
  # #      "FE|Transport|Freight|Domestic Shipping|Liquids" = "Liquids"
  #         "FE|Transport|Freight|Domestic Shipping|Liquids|Fossil" = "Liquids - Fossil",
  #         "FE|Transport|Freight|Domestic Shipping|Liquids|Biomass" = "Liquids - Biomass",
  #         "FE|Transport|Freight|Domestic Shipping|Liquids|Hydrogen" = "Liquids - Synthetic"
  #     ),
      "Aviation" = c(
        "FE|Transport|Pass|Domestic Aviation|Electricity" = "Electricity",
        "FE|Transport|Pass|Domestic Aviation|Gases" = "Gases",
        # "FE|Transport|Pass|Domestic Aviation|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Pass|Domestic Aviation|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Pass|Domestic Aviation|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Pass|Domestic Aviation|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Pass|Domestic Aviation|Liquids" = "Liquids"
          "FE|Transport|Pass|Domestic Aviation|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Pass|Domestic Aviation|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Pass|Domestic Aviation|Liquids|Hydrogen" = "Liquids - Synthetic"
      )
    ),
    "International" = list(
      "Aviation" = c(
        "FE|Transport|Bunkers|Pass|International Aviation|Electricity" = "Electricity",
        "FE|Transport|Bunkers|Pass|International Aviation|Gases" = "Gases",
        # "FE|Transport|Bunkers|Pass|International Aviation|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Bunkers|Pass|International Aviation|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Bunkers|Pass|International Aviation|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Bunkers|Pass|International Aviation|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Bunkers|Pass|International Aviation|Liquids" = "Liquids"
          "FE|Transport|Bunkers|Pass|International Aviation|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Bunkers|Pass|International Aviation|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Bunkers|Pass|International Aviation|Liquids|Hydrogen" = "Liquids - Synthetic"
      ),
      "Shipping" = c(
        "FE|Transport|Bunkers|Freight|International Shipping|Electricity" = "Electricity",
        "FE|Transport|Bunkers|Freight|International Shipping|Gases" = "Gases",
        # "FE|Transport|Bunkers|Freight|International Shipping|Gases|Fossil" = "Gases - Fossil",
        # "FE|Transport|Bunkers|Freight|International Shipping|Gases|Biomass" = "Gases - Biomass",
        # "FE|Transport|Bunkers|Freight|International Shipping|Gases|Hydrogen" = "Gases - Synthetic",
        "FE|Transport|Bunkers|Freight|International Shipping|Hydrogen" = "Hydrogen",
  #      "FE|Transport|Bunkers|Freight|International Shipping|Liquids" = "Liquids",
          "FE|Transport|Bunkers|Freight|International Shipping|Liquids|Fossil" = "Liquids - Fossil",
          "FE|Transport|Bunkers|Freight|International Shipping|Liquids|Biomass" = "Liquids - Biomass",
          "FE|Transport|Bunkers|Freight|International Shipping|Liquids|Hydrogen" = "Liquids - Synthetic"
      )
    )
  )
}

  FEvarList <- unlist(c(FEvars$Domestic$LDV,FEvars$Domestic$Buses,FEvars$Domestic$Trucks,FEvars$Domestic$Rail,FEvars$Domestic$Aviation,FEvars$International$Aviation,FEvars$International$Shipping))

typeVar <- c()
for(national in names(FEvars)){
  for(mode in names(FEvars[[national]])){
    for(var in names(FEvars[[national]][[mode]])){
      v <- mode
      names(v) <- var
      typeVar <- c(typeVar,v)
    }
  }
}

FEplotData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario == mainScen, variable %in% names(FEvarList))

FEplotData <- FEplotData %>%
  mutate(national = ifelse(variable %in% names(c(FEvars$Domestic$LDV,FEvars$Domestic$Buses,FEvars$Domestic$Trucks,FEvars$Domestic$Rail,FEvars$Domestic$Aviation)), "Domestic", "International"),
         name = FEvarList[as.character(variable)],
         type="Final Energy",
         mode = typeVar[as.character(variable)]) %>%
  group_by(model,scenario,region,unit,period,national,name,type,mode) %>%
  summarize(value=sum(value),.groups = "keep")

FEplotData$mode <- factor(FEplotData$mode, levels=c("LDV","Buses","Trucks","Rail","Shipping","Aviation"))

FEplotData$name <- factor(FEplotData$name, levels=c("Electricity","Hydrogen","Liquids","Liquids - Biomass","Liquids - Synthetic","Liquids - Fossil","Gases"))

plotColor <- c(
  "Electricity" = "#F3E16B",
  "Hydrogen" = "#82c9d9",
  "Liquids" = "#282828",
  "Liquids - Fossil" = "#282828",
  "Liquids - Biomass" = "#005900",
  "Liquids - Synthetic" = "#b56576",
  "Gases" = "#999959"
)

FEplotData <- FEplotData %>%
  mutate(cat = factor(ifelse(mode %in% c("Aviation","Shipping"), paste0(as.character(national),"\n", as.character(mode)), as.character(mode)),levels=c("LDV","Buses","Trucks","Rail","Domestic\nAviation","International\nShipping","International\nAviation")))


# convert unit if necessary
if(energyInMtoe){
  FEplotData <- FEplotData %>%
    mutate(value = value * EJ2Mtoe,
           unit = "Mtoe/yr")
}

logoURL <- c(
  "LDV" = "./img/LDV.svg",
  "Buses" = "./img/buses.svg",
  "Trucks" = "./img/truck.svg",
  "Rail" = "./img/rail.svg",
  "Domestic\nAviation" = "./img/aviation.svg",
  "International\nShipping" = "./img/shipping.svg",
  "International\nAviation" = "./img/aviation.svg"
)
logoSVG <- NULL
for (logo in names(logoURL)){
  logoSVG <- c(logoSVG, setNames(paste(readLines(logoURL[logo]), collapse = "\n"),logo))
}

logoData <- data.frame(cat = factor(names(logoSVG),levels=c("LDV","Buses","Trucks","Rail","Domestic\nAviation","International\nShipping","International\nAviation")), period = 2040, value = max(FEplotData$value)) %>%
  mutate(logo = logoSVG[cat])


g[["transport fe"]] <- ggplot(FEplotData,aes(x=period,y=value)) +
  geom_bar(aes(fill=name, alpha=factor(period)),stat='identity') +
  geom_point_svg(data=logoData, aes(x=period,y=value, svg = logo),vjust=1,size=15) + 
  facet_wrap(~cat,nrow=1) +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  scale_fill_manual(values = plotColor, guide = guide_legend(nrow = 1)) + #, guide = guide_legend(nrow = 2)
  scale_alpha_manual(values = c("2020"=0.7,"2025"=0.7,"2030"=0.7,"2035"=0.7,"2040"=1,"2045"=0.7,"2050"=0.7,"2055"=0.7,"2060"=0.7), guide = 'none') +
  scale_x_continuous(breaks = c(2020,2040,2060)) + 
  theme(
    strip.background = element_blank(),
    #strip.text.x = element_blank()
    ) +
  #theme(legend.text=element_text(size=theme.single.text.size)) +
  #theme(strip.text.x = element_text(size = 1.2*theme.double.text.size, vjust=0.5)) +
  theme(strip.clip = "off") +
  labs(title = paste0("(a) Transport Final energy (", unique(FEplotData$unit), ")"))

# ggsave(paste0(outChartsFolder,"/svg/Figure 4. Demand panel - (a) transport final energy.svg"), g[["transport fe"]] , device="svg", width = 12, height = 5, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 4. Demand panel - (a) transport final energy.png"), g[["transport fe"]] , device="png", width = 12, height = 5, dpi=300, units = "in")

```


<!-- (b) LDV sales and ICE stock (Millions of vehicles) -->

```{r chart_figure4b, echo=FALSE}

#LDV
if("Sales|Transport|LDV" %in% unique(df$variable)){
  Sales <- list(
    "BEV" = "Sales|Transport|LDV|BEV",
    "FCEV" = "Sales|Transport|LDV|FCEV",
    "Hybrid Electric" =	"Sales|Transport|LDV|Hybrid Electric",
    "Liquids" = "Sales|Transport|LDV|Liquids",
    "Gases" = "Sales|Transport|LDV|NG"
  )
  salesTotal <- c("Sales|Transport|LDV")
} else {
  Sales <- list(
    "BEV" = "Sales|Transport|Pass|Road|LDV|BEV",
    "FCEV" = "Sales|Transport|Pass|Road|LDV|FCEV",
    "Hybrid Electric" =	"Sales|Transport|Pass|Road|LDV|Hybrid electric",
    "Liquids" = "Sales|Transport|Pass|Road|LDV|Liquids",
    "Gases" = "Sales|Transport|Pass|Road|LDV|Gases"
  ) 
  salesTotal <- c("Sales|Transport|Pass|Road|LDV")
}

if("Stock|Transport|LDV" %in% unique(df$variable)){
  Stock <- list(
    "BEV" = "Stock|Transport|LDV|BEV",
    "FCEV" = "Stock|Transport|LDV|FCEV",
    "Hybrid Electric" =	"Stock|Transport|LDV|Hybrid Electric",
    "Liquids" = "Stock|Transport|LDV|Liquids",
    "Gases" = "Stock|Transport|LDV|NG"
  )
  StockFossil = c("Stock|Transport|LDV|Liquids","Stock|Transport|LDV|NG")
  StockTotal <- c("Stock|Transport|LDV")
} else {
  Stock <- list(
    "BEV" = "Stock|Transport|Pass|Road|LDV|BEV",
    "FCEV" = "Stock|Transport|Pass|Road|LDV|FCEV",
    "Hybrid Electric" =	"Stock|Transport|Pass|Road|LDV|Hybrid electric",
    "Liquids" = "Stock|Transport|Pass|Road|LDV|Liquids",
    "Gases" = "Stock|Transport|Pass|Road|LDV|Gases"
  ) 
  StockFossil = c("Stock|Transport|Pass|Road|LDV|Liquids","Stock|Transport|Pass|Road|LDV|Gases")
  StockTotal <- c("Stock|Transport|Pass|Road|LDV")
}

plotColor <- c(
  "BEV" = "#F3E16B",
  "FCEV" = "#82c9d9",
  "Hybrid Electric" =	"#F37A5E",
  "Gases" = "#dddddd" , #"#F7EFE8", 
  "Liquids" = "#282828"
)

vars <- Sales

plotData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario == mainScen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=vars)) 

salestot <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario == mainScen, variable %in% Sales) %>% 
  group_by(period) %>%
  summarize(value = sum(value)) %>%
  rename(tot = value)

plotData <- inner_join(plotData, salestot, by = "period") %>%
  mutate(value = value/tot)

labels <- setNames(names(vars),vars[names(vars)])

plotData$labels <- labels[as.character(plotData$variable)]

#stock
stockData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario == mainScen, variable %in% unlist(Stock)) %>% 
  mutate(variable = factor(variable, levels=Stock)) %>%
  filter(variable %in% StockFossil) %>%
  group_by(period) %>%
  summarize(value = sum(value),.groups = "keep") %>%
  mutate(variable = "ICE Stock")


totstockData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2060, scenario == mainScen, variable %in% StockTotal) %>% 
  select(period, value) %>%
  rename(tot = value)

stockData <- inner_join(stockData,totstockData, by = "period") %>% 
  mutate(value = value/tot, variable = "ICE Stock")

logoData <- data.frame(period = 2050, value = 0.7, logo = paste(readLines("./img/LDV.svg"), collapse = "\n"))

g[["LDV Sales"]] <-
  ggplot(plotData,aes(x=period,y=value)) +
  geom_bar(aes(fill=variable, alpha=factor(period)),stat='identity') +
  geom_line(data=stockData, aes(color=variable),linetype=11, lwd = 1) +
# geom_line(data=h,linetype="dashed", linewidth = 1, color="black") +
 geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
 geom_label_repel(data=data.frame(period=2030,value=stockData %>% filter(period == 2030) %>% pull(value)), label = "Stock",
                  #box.padding = 0.1,
                  #segment.curvature = -0.1,
                  #segment.square = TRUE,
                  #point.padding = 0.6,
                  nudge_x = 5,
                  nudge_y = 0.05,
                  #nudge_y = -0.02,
                  #force = 0.5,
                  hjust = 0,
                  direction="x", size = geomText.size) +
  geom_point_svg(data=logoData, aes(x=period,y=value, svg = logo),vjust=0.5,size=20) +
  theme_doubleColumn() +
 scale_fill_manual(values = setNames(plotColor[names(vars)],vars), labels = setNames(names(vars), vars), guide = guide_legend(nrow = 3, order = 1)) + #, guide = guide_legend(nrow = 2)
 scale_color_manual(values = c("ICE Stock"="black"), guide = guide_legend(order = 2, keywidth = unit(2, 'cm'))) +
 scale_alpha_manual(values = c("2020"=0.7,"2025"=0.7,"2030"=0.7,"2035"=0.7,"2040"=1,"2045"=0.7,"2050"=0.7,"2055"=0.7,"2060"=0.7), guide = 'none') +
 scale_x_continuous(breaks=c(2020,2030,2040,2050,2060)) +
 scale_y_continuous(limits = c(0, 1.1), breaks=c(0,1), labels = scales::percent, name = "Sales") +
 #theme(legend.text=element_text(size=theme.double.text.size),
#        legend.spacing.x = unit(0.4, 'cm'))  +
  guides(color = "none") +
  #theme(legend.text=element_text(size=theme.double.text.size)) +
  labs(title = "(b) LDV sales shares &  share of ICE in LDV stock (%)") +
  theme(plot.title = element_text(hjust=-0.5))  

# ggsave(paste0(outChartsFolder,"/svg/Figure 4. Demand panel - (b) LDV sales.svg"), g[["LDV Sales"]] , device="svg", width = 6, height = 4.5, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 4. Demand panel - (b) LDV sales.png"), g[["LDV Sales"]] , device="png", width = 6, height = 4.5, dpi=300, units = "in")

```

<!-- (d) Industry CO2 emissions per sub-sector (Mt CO2/yr) -->

```{r chart_figure4d, echo=FALSE}

# Industry Emissions
vars <- c("Chemicals"="Emi|CO2|Energy|Demand|Industry|Chemicals",
          "Other Industry"="Emi|CO2|Energy|Demand|Industry|Other Industry",
          "Steel"="Emi|CO2|Energy|Demand|Industry|Steel",
          "Cement" = "Emi|CO2|Energy|Demand|Industry|Cement"
          )

plotColor <- c(
  "Cement" = "#355070",
  "Steel" = "#219ebc",
  "Chemicals" = "#eaac8b",
  "Other Industry" = "#e56b6f"
)

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=vars)) %>%
  group_by(model,region,variable,period) %>% 
  filter(tgt2050 != "Npi") %>% 
  mutate(ribbon.max=max(value),
         ribbon.min=min(value))

# historical data #missing non-energy
#h <- hist[hist$model == "UNFCCC" & hist$region == "EU27" & hist$variable %in% vars,] %>% drop_na(value)

#View(hist[hist$model == "UNFCCC" & hist$region == "EU27" & hist$variable == "Emi|CO2|Industrial Processes",] %>% drop_na(value))
# Emi|CO2|Energy|Demand|Industry
# Emi|CO2|Energy|Demand|Industry|Cement
# Emi|CO2|Energy|Demand|Industry|Chemicals
# Emi|CO2|Energy|Demand|Industry|Other Industry
# Emi|CO2|Energy|Demand|Industry|Other Industry|AFOFI
# Emi|CO2|Energy|Demand|Industry|Steel
# Emi|CO2|Industrial Processes
# Emi|CO2|Industrial Processes|Chemicals
# Emi|CO2|Industrial Processes|Metals
# Emi|CO2|Industrial Processes|Minerals
# Emi|GHG|Energy|Demand|Industry
# Emi|GHG|Industrial Processes

g[["Industry Emissions"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    geom_segment(aes(x=2040, y=0, xend=2040, yend=max(plotData %>% filter(scenario == mainScen, period == 2040) %>% pull(value))), linetype="dashed", color="black") +
    geom_line(data=plotData %>% filter(scenario == mainScen), aes(color=variable), linewidth=1.5) +
    #geom_line(data=h,linewidth=1,linetype="dashed") +
    geom_ribbon(aes(ymax = ribbon.max, ymin = ribbon.min, fill=variable), alpha = 0.3) + 
    geom_point(data=plotData %>% filter(scenario == mainScen, period == 2040), aes(color=variable),size=3,shape=21,fill="white",stroke=1.5) +
    scale_color_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) +
    scale_fill_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) +
    theme_doubleColumn() + 
    expand_limits(y=c(0,1)) +
    guides(color=guide_legend(nrow=2)) +
    #theme(legend.text=element_text(size=theme.double.text.size)) +
    #theme(legend.text=element_text(size=theme.double.text.size))  +
    labs(title = expression(paste("(d) Industrial sectorsâ€™ ", CO[2], " emissions (Mt ", CO[2], "/yr)"))) #+
    #theme(plot.title = element_text(hjust=-0.3)) 

# ggsave(paste0(outChartsFolder,"/svg/Figure 4. Demand panel - (d) industrial emissions.svg"), g[["Industry Emissions"]] , device="svg", width = 6, height = 5.5, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 4. Demand panel - (d) industrial emissions.png"), g[["Industry Emissions"]] , device="png", width = 6, height = 5.5, dpi=300, units = "in")


```


<!-- (c) Buildings useful energy Electricity based heating (EJ/yr) -->

```{r chart_figure4c, echo=FALSE}

# full useful energy
vars <- c(
  "Electricity (appliances)" = "UE|Buildings|non-Heating|Electricity|Conventional",
  "Electricity (heat pumps)" = "UE|Buildings|Heating|Electricity|Heat pump",
  "Electricity (resistence)" = "UE|Buildings|Heating|Electricity|Resistance",
  "Heating - Hydrogen" = "UE|Buildings|Heating|Hydrogen",
  "District Heating" = "UE|Buildings|Heating|District Heating",
  "Gases" = "UE|Buildings|Heating|Gases",
  "Liquids" = "UE|Buildings|Heating|Liquids",
  "Solids" = "UE|Buildings|Heating|Solids"
)

invertVars <- setNames(names(vars),vars)

# origData <- df %>%
#   filter(region == "EU27", period >= 2020, period <= 2060, variable %in% vars) %>% #, scenario == mainScen
#   mutate(name = invertVars[as.character(variable)]) %>%
#   mutate(name = factor(invertVars[as.character(variable)], levels = names(vars)),
#          variable = factor(variable, levels=vars))

plotData <- df %>%
  filter(region == "EU27", period >= 2020, period <= 2060, variable %in% vars) %>% #, scenario == mainScen
  mutate(name = invertVars[as.character(variable)]) %>%
  filter(name %in% c("Electricity (heat pumps)", "Electricity (resistence)", "District Heating", "Gases", "Liquids", "Solids")) %>%
  filter(region == "EU27", period %in% c(2020,2030,2040,2050), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>%
  mutate(variable = factor(variable, levels=vars))  %>%
  mutate(name = factor(name, levels = names(vars)))  %>%
  filter(tgt2050 != "Npi")  %>%
  group_by(model,scenario,region,period) %>%
  mutate(cumsum = cumsum(value),
         sum = sum(value)) %>%
  group_by(model,region,variable,period) %>%
  mutate(ribbon.max=max(cumsum),
         ribbon.min=min(cumsum)) %>%
  group_by(model,region,period) %>%
  mutate(ribbon.max.total=max(sum),
         ribbon.min.total=min(sum))

plotColor <- c(
  "Electricity (appliances)" = as.vector(options$aesthetics$legend$color["Electricity"]),
  "Electricity (heat pumps)" = "#F3E16B", #"#D62828",
  "Electricity (resistence)" = "#F77F00",
  "Heating - Hydrogen" = as.vector(options$aesthetics$legend$color["Hydrogen"]),
  "District Heating" = "#E07A5F",
  "Gases" = as.vector(options$aesthetics$legend$color["Gases"]),
  "Liquids" = as.vector(options$aesthetics$legend$color["Liquids"]),
  "Solids" = as.vector(options$aesthetics$legend$color["Solids"])
)

# convert unit if necessary
if(energyInMtoe){
  plotData <- plotData %>%
    mutate(value = value * EJ2Mtoe,
           ribbon.max = ribbon.max * EJ2Mtoe,
           ribbon.min = ribbon.min * EJ2Mtoe,
           ribbon.max.total = ribbon.max.total * EJ2Mtoe,
           ribbon.min.total = ribbon.min.total * EJ2Mtoe,
           unit = "Mtoe/yr")
}

g[["Buildings heating useful energy"]] <-
  ggplot(plotData,aes(x=period,y=value)) +
  geom_col(data=plotData %>% filter(scenario == mainScen), aes(fill = name, alpha=factor(period))) +
  geom_errorbar(data=plotData %>% filter(period != 2020, variable == vars["Electricity (heat pumps)"], scenario == mainScen), aes(ymin=ribbon.min.total, ymax=ribbon.max.total), width=4, colour="black", alpha=0.9, linewidth=1,position = position_dodge(width=2)) +
  # scale_y_continuous(labels = scales::percent, breaks = c(0,1,plotData[plotData$period == "2030",]$value,plotData[plotData$period == "2040",]$value,plotData[plotData$period == "2050",]$value)) +
  coord_flip() +
  theme_doubleColumn() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_fill_manual(values = plotColor, guide = guide_legend(reverse = TRUE, nrow = 3)) +
  scale_alpha_manual(values = c("2020"=0.7,"2030"=0.7,"2040"=1,"2050"=0.7), guide = 'none') +
  #theme(legend.text=element_text(size=theme.double.text.size)) +
  #theme(legend.margin=margin(l = -2.5, t = -0.5, unit='cm')) +
  labs(title = paste0("(c) Buildings space and water heating useful energy (", unique(plotData$unit), ")")) +
  theme(plot.title = element_text(hjust=1)) #+
  #scale_y_continuous(breaks = c(0,round(sum(plotData %>% filter(scenario == mainScen, period == "2020") %>% pull(value)),1),round(sum(plotData %>% filter(scenario == mainScen, period == "2030") %>% pull(value)),1),round(sum(plotData %>% filter(scenario == mainScen, period == "2040") %>% pull(value)),1),round(sum(plotData %>% filter(scenario == mainScen, period == "2050") %>% pull(value)),1))) #+
  #scale_x_reverse()

# ggsave(paste0(outChartsFolder,"/svg/Figure 4. Demand panel - (c) buildings heating useful energy.svg"), g[["Buildings heating useful energy"]] , device="svg", width = 6, height = 4.3, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 4. Demand panel - (c) buildings heating useful energy.png"), g[["Buildings heating useful energy"]] , device="png", width =6, height = 4.3, dpi=300, units = "in")

```

<!-- (e) Carbon Management (Mt CO2/yr) -->

```{r chart_figure4e, echo=FALSE}

vars <- list(
  #"Usage"
  "e-liquids" = "Carbon Management|Usage|Synthetic Liquids",
  "e-gases" = "Carbon Management|Usage|Synthetic Gases",
  "stored carbon" = "Carbon Management|Storage",
  # "Capture type"
  "atmospheric/biogenic" = "Carbon Management|Carbon Capture|atmospheric/biogenic CO2",
  "fossil" = "Carbon Management|Carbon Capture|fossil origin",
  #"Capture"
  "DAC" = "Carbon Management|Carbon Capture|DAC",
  "BECC" = "Carbon Management|Carbon Capture|Biomass|Pe2Se", 
  "fossil (energy)" = "Carbon Management|Carbon Capture|Fossil|Pe2Se",
  "industry and waste" = "Carbon Management|Carbon Capture|Industry and Waste"
  #"industry" = "Carbon Management|Carbon Capture|Industry",
  #"waste" = "Carbon Management|Carbon Capture|Waste|Plastics Incineration"
  #"Storage type"
  # "atmospheric/biogenic" = "Carbon Management|atmospheric/biogenic CO2 - CDR",
  # "fossil" = "Carbon Management|CCS of fossil origin",
  #
  # "DAC" = "Carbon Management|Storage|DAC",
  # "BECCS" = "Carbon Management|Storage|Biomass|Pe2Se", 
  # "Fossil CCS" = "Carbon Management|Storage|Fossil|Pe2Se", 
  # "Industry CCS" = "Carbon Management|Storage|Industry CCS"
    # "Industry Energy" = "Carbon Management|Storage|Industry Energy",
    # "Industry Process" = "Carbon Management|Storage|Industry Process"
)

plotColor <- c(
  "e-liquids" = "#6f65b5",
  "e-gases" = "#b59765",
  "stored carbon" = "#b56576",
  "atmospheric/biogenic" = "#c1d8f0",
  "fossil" = "#6b5b4b",
  "DAC" = "#CC6666",
  "BECC" = "#8bc18b",
  #"Industry CCS" = "#5f6769",
  #"Fossil CCS" = "#47331f",
  "fossil (energy)" = "#6b5b4b",
  "industry and waste" = "#5f6769"#,
  #"industry" = "#5f6769",
  #"waste" = "#543a0f"
  #"fossil" = "#47331f"
)

plotData <- df %>% 
  filter(region == "EU27", period %in% c(2030, 2040, 2050), tgt2030 %in% tgt2030Scen, variable %in% unlist(vars)) %>% 
  mutate(CDRGroup = 
    ifelse(as.character(variable) %in% c("Carbon Management|Carbon Capture|fossil origin","Carbon Management|Carbon Capture|atmospheric/biogenic CO2"), "Capture type",
    ifelse(as.character(variable) %in% c("Carbon Management|CCS of fossil origin","Carbon Management|atmospheric/biogenic CO2 - CDR"), "Storage type",
    ifelse(as.character(variable) %in% c("Carbon Management|Storage","Carbon Management|Usage|Synthetic Gases","Carbon Management|Usage|Synthetic Liquids"), "Usage",
    ifelse(as.character(variable) %in% c("Carbon Management|Carbon Capture|DAC", "Carbon Management|Carbon Capture|Biomass|Pe2Se", "Carbon Management|Carbon Capture|Fossil|Pe2Se","Carbon Management|Carbon Capture|Industry and Waste"
                                         #"Carbon Management|Carbon Capture|Industry", "Carbon Management|Carbon Capture|Waste|Plastics Incineration"
                                         ), "Capture","CCS")))),
    variable = factor(variable, levels=c( "Carbon Management|Usage|Synthetic Liquids", "Carbon Management|Usage|Synthetic Gases", "Carbon Management|Storage", "destination", "empty1", "empty2", "Carbon Management|Carbon Capture|atmospheric/biogenic CO2", "Carbon Management|Carbon Capture|fossil origin", "type",
          #"empty1", "empty2", "Carbon Management|atmospheric/biogenic CO2 - CDR", "Carbon Management|CCS of fossil origin", "type",
          #"Carbon Management|Storage|DAC", "Carbon Management|Storage|Biomass|Pe2Se", "Carbon Management|Storage|Fossil|Pe2Se", "Carbon Management|Storage|Industry CCS", "origin")
          "Carbon Management|Carbon Capture|DAC", "Carbon Management|Carbon Capture|Biomass|Pe2Se", "Carbon Management|Carbon Capture|Fossil|Pe2Se", "Carbon Management|Carbon Capture|Industry and Waste"
          #"Carbon Management|Carbon Capture|Industry", "Carbon Management|Carbon Capture|Waste|Plastics Incineration"
          , "origin")),
         value = ifelse(grepl("Emi",variable,fixed = TRUE), -value, value))  %>% 
  mutate(CDRGroup = factor(CDRGroup, levels=c("Usage","Capture type", "Storage type", "Capture", "CCS"))) %>%
  group_by(model,scenario,region,period, CDRGroup) %>% 
  mutate(cumsum = cumsum(value),
         sum = sum(value)) %>% 
  group_by(model,region,variable,period, CDRGroup) %>% 
  mutate(ribbon.max=max(cumsum),
         ribbon.min=min(cumsum)) %>% 
  group_by(model,region,period, CDRGroup) %>% 
  mutate(ribbon.max.total=max(sum),
         ribbon.min.total=min(sum)) %>% 
  mutate(period = factor(period, levels=c(2050,2040,2030)))

 g[["Carbon Management"]] <- ggplot(plotData,aes(x=CDRGroup,y=value)) +
  #geom_area(aes(fill=variable)) +
  geom_bar(data=plotData %>% filter(scenario == mainScen), aes(fill=variable, alpha=factor(period)),stat='identity') + 
  geom_errorbar(data=plotData %>% filter(variable == vars[4], scenario == mainScen), aes(ymin=ribbon.min.total, ymax=ribbon.max.total), width=0.4, colour="black", alpha=0.9, linewidth=1) +
  facet_wrap(period ~ ., ncol=1, strip.position="left") +
  coord_flip() +
  theme_doubleColumn() +
  scale_fill_manual(values = c(setNames(plotColor[names(vars)],vars), "empty1" = "transparent", "empty2" = "transparent", "destination" = "transparent", "type" = "transparent", "origin" = "transparent"), 
                    labels = c(setNames(names(vars[! vars %in% c("Carbon Management|atmospheric/biogenic CO2 - CDR", "Carbon Management|Carbon Capture|atmospheric/biogenic CO2")] ), vars[! vars %in% c("Carbon Management|atmospheric/biogenic CO2 - CDR", "Carbon Management|Carbon Capture|atmospheric/biogenic CO2")] ),
                               #"Carbon Management|atmospheric/biogenic CO2 - CDR" = "atmospheric",
                               "Carbon Management|Carbon Capture|atmospheric/biogenic CO2" = "atmospheric",
                               "empty1" = "", "empty2" = "or biogenic", "destination" = "Destination", "type" = "Type", "origin" = "Origin"), guide = guide_legend(nrow = 5, reverse = TRUE), drop = FALSE) + 
  scale_alpha_manual(values = c("2020"=0.7,"2030"=0.7,"2040"=1,"2050"=0.7), guide = 'none') +
  theme(legend.title = element_blank()) +
  theme(legend.margin=margin(l = -1, unit='cm')) + 
  theme(strip.text.y.left = element_text(angle = 0)) +
  # theme(
  #   strip.background = element_blank(),
  #   strip.text.x = element_blank()
  # ) +
  theme(axis.text.y=element_blank(), #remove x axis labels
        axis.ticks.y=element_blank(), #remove x axis ticks
        ) +
  labs(title = expression(paste("(e) Carbon Capture and Storage (Mt ", CO[2], "/yr)"))) +
  theme(plot.title = element_text(hjust=-0.3))   #+
 
 # ggsave(paste0(outChartsFolder,"/svg/Figure 4. Demand panel - (e) carbon management.svg"), g[["Carbon Management"]] , device="svg", width = 6, height = 5.5, dpi=100, units = "in")
 # ggsave(paste0(outChartsFolder,"/png/Figure 4. Demand panel - (e) carbon management.png"), g[["Carbon Management"]] , device="png", width = 6, height = 5.5, dpi=300, units = "in")
 

```


```{r, echo=FALSE, include=FALSE}

g[["Figure 4"]] <- gridExtra::arrangeGrob(
  g[["transport fe"]] + theme(legend.margin=margin(b = 10, t = 10)),
  g[["LDV Sales"]],
  g[["Buildings heating useful energy"]] + theme(plot.title = element_text(margin=margin(b=30))),
  g[["Industry Emissions"]],
  g[["Carbon Management"]],
  layout_matrix = rbind(
    c(1,1),
    c(2,3),
		c(4,5))
   )

ggsave(paste0(outChartsFolder,"/png/Figure 4. Sectoral transformation indicators.png"), g[["Figure 4"]], device="png", width = 12, height = 16, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Figure 4. Sectoral transformation indicators.svg"), g[["Figure 4"]], device="svg", width = 12, height = 16, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=16}

grid.newpage()
grid.draw(g[["Figure 4"]])

```



---

# Figure 5. Targets update



```{r chart_figure5, echo=FALSE}

# â€œexistent targetsâ€
# emission reduction - 2030 (FitFor55) - 2030 scenarios - 2040 scenarios
# energy savings  - 2030 (FitFor55 and REPowerEU) - 2030 scenarios - 2040 scenarios
# renewables target - 2030 (RED II, RED II revised, REPowerEU) - 2030 scenarios - 2040 scenarios
# solar photovoltaics capacity - 2030 (REPowerEU) - 2030 scenarios - 2040 scenarios
# CCS capacity target - 2030 EU-wide 50 MtCO2/y â€œNet-Zero Industry Act"
# â€œimplicit targetsâ€
# electrification? -> fe electrification share -> 45%
# â€œcarbon-content in electricityâ€ ->â€œcarbon-free electricityâ€ (>95%) 
# Total Residual Fossil emissions
# sectoral emissions -> Transport emissions -> 23% of 2020 
#                                   -> Industry and buildings emissions -> 27% of 2020
# â€œresidual fossilâ€     -> Complete coal-phase by 2040
#                                  -> natural gas
#                                 -> oil
# â€œnet tradeâ€ -> net-supply independency of gas by 2040
#                       -> one third of oil imports by 2040

violin_scale <- 3 
violin_color = "#bbbbbb"
violin_boxPlotWidth <- 1.5   

#Emissions Reduction
plotData <- rbind(
    df %>% 
      filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen) %>%
      calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>% 
      mutate(value = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)) ,2)) %>% 
      select(-variable)
    ,
    df %>% 
      filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen) %>%
      calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>% 
      mutate(value = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)) ,2)) %>% 
      select(-variable)
  ) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Emissions\nreductions") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))

fullPlotData <- plotData 

h <- refEmi %>% filter(variable == "Emissions with LULUCF and with international transport", region == "EU27", pollutant == "All greenhouse gases - (CO2 equivalent)") %>% ungroup() %>% select(region,variable,period,value)
emi1990 <- tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)
reduction_h <- 1- (h %>% filter(period==2022) %>% pull(value) / emi1990)

g[["Emissions reductions"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=0.57, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Emissions\nreductions", y = 0.57, label = "FitFor55", angle=90, vjust = -0.5, hjust = 1, color = "black", alpha = 0.5) +
  geom_hline(yintercept=reduction_h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Emissions\nreductions", y = reduction_h, label = "2022", angle=90, vjust = -0.5, hjust = 1, color = "black", alpha = 0.5) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(%)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=0.8*geomText.size, hjust=1.4, na.rm = TRUE)

g[["milestone - vert"]][["Emissions reductions"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=0.55, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.55, label = "FitFor55", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=reduction_h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = reduction_h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Emissions reductions"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=0.55, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.55, label = "FitFor55", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=reduction_h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = reduction_h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=0.8*geomText.size) 

g[["milestone - violin"]][["Emissions reductions"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill="#bbbbbb", scale = violin_scale) + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=1, colour="black", alpha=0.9, linewidth=0.5) +
  geom_boxplot(outlier.shape = NA, width=1.5) +
  geom_hline(yintercept=0.55, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.55, label = "FitFor55", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=reduction_h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = reduction_h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=0.8*geomText.size) 


# Final Energy Demand - Energy savings
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "FE|w/o Non-energy Use w/o Bunkers") %>% select(-variable) %>%
  mutate(value = round(value * EJ2Mtoe)) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Final Energy\nDemand") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))

fullPlotData <- rbind(fullPlotData,plotData) 

h <- addHist$FE_consumption %>%
  mutate(value = round(value * EJ2Mtoe)) # 1EJ = 23.8845896627496 Mtoe

g[["Energy savings"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=750, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Final Energy\nDemand", y = 787, label = "FitFor55", angle=90, vjust = 1.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=787, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Final Energy\nDemand", y = 750, label = "REPowerEU", angle=90, vjust = -0.5, hjust = 0.7, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=h %>% filter(period==2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Final Energy\nDemand", y = h %>% filter(period==2022) %>% pull(value), label = "2022", angle=90, vjust = -0.5, hjust = 0.7, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(400,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(Mtoe/yr)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.2, na.rm = TRUE)


g[["milestone - vert"]][["Energy savings"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=750, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  geom_hline(yintercept=787, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 750, label = "REPowerEU", vjust = 1.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  annotate("text", x = Inf, y = 787, label = "FitFor55", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=h %>% filter(period==2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h %>% filter(period==2022) %>% pull(value), label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,400,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(Mtoe/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Energy savings"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mtoe/yr)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=750, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  geom_hline(yintercept=787, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 750, label = "REPowerEU", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  annotate("text", x = Inf, y = 787, label = "FitFor55", angle=90, vjust = 1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=h %>% filter(period==2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h %>% filter(period==2022) %>% pull(value), label = "2022", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mtoe/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Energy savings"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mtoe/yr)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=750, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  geom_hline(yintercept=787, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 750, label = "REPowerEU", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  annotate("text", x = Inf, y = 787, label = "FitFor55", angle=90, vjust = 1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=h %>% filter(period==2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h %>% filter(period==2022) %>% pull(value), label = "2022", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mtoe/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

# Electricity Demand
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "FE|Electricity") %>% select(-variable) %>%
  mutate(value = round(value * EJ2TWh)) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Electricity\nDemand") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))

fullPlotData <- rbind(fullPlotData,plotData) 

#2022 = 2469471.42 GWh = 2469471.42 *1000 / 8.76E+09 * 31.536 EJ - FE electricity - https://ec.europa.eu/eurostat/databrowser/bookmark/d19a01c7-6099-4b88-8ccd-c6bcc01c3ddc?lang=en
h <- 2469471.42 /1000
# old value? 2641

g[["Electricity Demand"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Electricity\nDemand", y = h, label = "2022", angle=90, vjust = -0.5, hjust = 1.2, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(0,5000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(TWh)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.2, na.rm = TRUE)

g[["milestone - vert"]][["Electricity Demand"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,5000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(TWh)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Electricity Demand"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (TWh)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,5000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(TWh)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Electricity Demand"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (TWh)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -1, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,5000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(TWh)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

# Renewables share
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Renewables Share") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Renewables\nShare in\nFinal Energy") 

plotData$value <- plotData$value*(
  addHist$res %>% filter(type == "RES", period == 2020) %>% pull(value) /
   df %>% filter(region == "EU27", period == 2020, variable == "SE|Renewables Share", scenario == mainScen) %>% pull(value) 
)

plotData <- plotData %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))

fullPlotData <- rbind(fullPlotData,plotData) 

g[["Renewables Share"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=0.4, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Renewables\nShare in\nFinal Energy", y = 0.4, label = "RED II revised", angle=90, vjust = -0.5, hjust = 0.5, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=0.45, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Renewables\nShare in\nFinal Energy", y = 0.45, label = "REPowerEU", angle=90, vjust = 1.5, hjust = 0.6, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Renewables\nShare in\nFinal Energy", y = addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), label = "2022", angle=90, vjust = -0.5, hjust = 0.6, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(%)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.4, na.rm = TRUE)

g[["milestone - vert"]][["Renewables Share"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=0.4, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.4, label = "RED II revised", vjust = 1.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=0.45, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.45, label = "REPowerEU", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Renewables Share"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=0.4, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.4, label = "RED II revised", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=0.45, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.45, label = "REPowerEU", angle=90, vjust = 1.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Renewables Share"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=0.4, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.4, label = "RED II revised", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=0.45, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 0.45, label = "REPowerEU", angle=90, vjust = 1.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

# Wind
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Cap|Electricity|Wind") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Wind\ncapacity") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

#target <- data.frame(target=c("REPowerEU","REPowerEU"),period=c(2025,2030),value=c(320,600)) 
g[["Wind capacity"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
  geom_hline(yintercept=255, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Wind\ncapacity", y = 255, label = "2022", angle=90, vjust = -0.5, hjust = 1.2, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(0,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(GW)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.3, na.rm = TRUE)

g[["milestone - vert"]][["Wind capacity"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=255, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 255, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(GW)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Wind capacity"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (GW)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=255, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 255, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(GW)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Wind capacity"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (GW)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=255, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 255, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1000)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(GW)", hjust = 1, color = "#666666", size = 0.8*geomText.size)
# Solar photovoltaics
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Cap|Electricity|Solar|PV") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Solar\nphotovoltaics") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

#target <- data.frame(target=c("REPowerEU","REPowerEU"),period=c(2025,2030),value=c(320,600)) 
g[["Solar photovoltaics"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=600, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Solar\nphotovoltaics", y = 600, label = "REPowerEU", angle=90, vjust = -0.5, hjust = 0.6, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=208.9, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Solar\nphotovoltaics", y = 208.9, label = "2022", angle=90, vjust = -0.5, hjust = 1.2, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(GW)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.3, na.rm = TRUE)

g[["milestone - vert"]][["Solar photovoltaics"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=600, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 600, label = "REPowerEU", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=208.9, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 208.9, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(GW)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Solar photovoltaics"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (GW)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=600, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 600, label = "REPowerEU", angle=90, vjust = 1.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=208.9, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 208.9, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(GW)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Solar photovoltaics"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (GW)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=600, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 600, label = "REPowerEU", angle=90, vjust = 1.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  geom_hline(yintercept=208.9, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 208.9, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(GW)", hjust = 1, color = "#666666", size = 0.8*geomText.size)
# Carbon Capture and Storage 
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Carbon Management|Storage") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Carbon\nCapture and\nStorage") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

g[["Carbon Capture and Storage"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=50, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Carbon\nCapture and\nStorage", y = 50, label = "Net-Zero\nIndustry Act", angle=90, vjust = -0.2, hjust = 0.6, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  #expand_limits(y=c(0,ceiling(max(plotData$value)/50)*50)) + 
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(Mt CO2/yr)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.1, na.rm = TRUE)

g[["milestone - vert"]][["Carbon Capture and Storage"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=50, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 50, label = "Net-Zero\nIndustry Act", vjust = 0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Carbon Capture and Storage"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=50, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 50, label = "Net-Zero\nIndustry Act", angle=90, vjust = 0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) +
  theme(strip.clip = "off")#+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Carbon Capture and Storage"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=50, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = 50, label = "Net-Zero\nIndustry Act", angle=90, vjust = 0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) +
  theme(strip.clip = "off")#+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

# Novel CDR = atmospheric/biogenic CO2 (CDR) 
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Carbon Management|atmospheric/biogenic CO2 - CDR") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "BECCS\nand\nDACCS") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

g[["Novel CDR"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(0,400)) + 
  #expand_limits(y=c(0,ceiling(max(plotData$value)/50)*50)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(Mt CO2/yr)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.1, na.rm = TRUE)

g[["milestone - vert"]][["Novel CDR"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Novel CDR"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Novel CDR"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,400)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)
# Direct Electrification
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Final Energy|Electricity Share") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Electricity\nShare in\nFinal Energy") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

#estimation of historical share in 2022 for FE electricity / FE with non-energy use and with bunkers
h <- (
      2550461.10 *1000 / 8.76E+09 * 31.536  # https://ec.europa.eu/eurostat/databrowser/bookmark/12d54df4-7c35-47eb-a103-dd8994d26b80?lang=en
     ) / (
      addHist$FE_consumption %>% mutate(value = value/1000000) %>% filter(period==2022) %>% pull(value) + # FE|w/o Non-energy Use w/o Bunkers - EJ
      df %>% filter(region == "EU27", period == 2020, scenario == "Npi", variable == "FE|Transport|Bunkers") %>% pull(value) +
      df %>% filter(region == "EU27", period == 2020, scenario == "Npi", variable == "FE|Non-energy Use|Industry") %>% pull(value)
     )

g[["Direct Electrification"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
    geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Electricity\nShare in\nFinal Energy", y = h, label = "2022", angle=90, vjust = -0.5, hjust = 1.2, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(%)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.4, na.rm = TRUE)

g[["milestone - vert"]][["Direct Electrification"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Direct Electrification"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=geomText.size, size = 0.8*geomText.size)

g[["milestone - violin"]][["Direct Electrification"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=geomText.size, size = 0.8*geomText.size)
# Carbon-free electricity share
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Electricity|carbon-free") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Carbon-free\nelectricity\nshare") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))  

fullPlotData <- rbind(fullPlotData,plotData) 

#historical - 2022 - https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Electricity_and_heat_statistics&oldid=347519
#solid fossil	453180
#oil	54277
#gas	571687
#nuclear	609169
#renewables	1076710
#other	32822
h <- (609169 + 1076710)	/ (453180 + 54277 + 571687 + 609169 + 1076710 + 32822)

g[["Carbon-free electricity share"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
    geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Carbon-free\nelectricity\nshare", y = h, label = "2022", angle=90, vjust = -0.5, hjust = 1.2, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(%)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.4, na.rm = TRUE)

g[["milestone - vert"]][["Carbon-free electricity share"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Carbon-free electricity share"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=geomText.size, size = 0.8*geomText.size)

g[["milestone - violin"]][["Carbon-free electricity share"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (%)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = Inf, y = h, label = "2022", angle=90, vjust = -0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,1)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(%)", hjust = 1, color = "#666666", size=geomText.size, size = 0.8*geomText.size)
# Residual Fossil Emissions
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Emi|CO2|Residual Fossil") %>% select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Residual\nFossil\nEmissions") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value))  


fullPlotData <- rbind(fullPlotData,plotData) 

g[["Residual Fossil Emissions"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
         #stat_summary(geom = "text", fun = quantile,
        #              aes(label = paste0(round(..y..*100),"%")),
        #       #position=position_nudge(x=c(0.1,0.35,0.35,0.35,0.1)), 
         #      hjust=-1, angle = 90) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(Mt CO2/yr)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.05, na.rm = TRUE)

g[["milestone - vert"]][["Residual Fossil Emissions"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Residual Fossil Emissions"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)

g[["milestone - violin"]][["Residual Fossil Emissions"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mt CO2/yr)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,2500)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mt CO2/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)


# Domestic Hydrogen Production
plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Hydrogen") %>% select(-variable) %>%
  mutate(value = value*EJ2MtH2)  %>% #1EJ <- 8 million tons adrian
  filter(tgt2050 != "Npi") %>%
  mutate(target = "Domestic\nHydrogen\nProduction") %>%
  group_by(period) %>% 
  mutate(min = min(value),
        max = max(value)) 

fullPlotData <- rbind(fullPlotData,plotData) 

target <- data.frame(target=c("REPowerEU","REPowerEU"),period=c(2030,2030),value=c(10,20))

g[["Domestic Hydrogen Production"]] <- ggplot(plotData, aes(x = target, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +   
  geom_boxplot(outlier.shape = NA, width=0.6) +
  geom_hline(yintercept=10, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = "Domestic\nHydrogen\nProduction", y = 10, label = "REPowerEU\ndomestic", angle=90, vjust = 0.5, hjust = 0.5, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(target~period, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  expand_limits(y=c(0,20)) + 
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  theme(strip.text.x = element_blank()) +
  theme(panel.spacing = unit(4, "lines")) +
  #theme(axis.text.x = element_text(size = 0.8*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1.2*theme.double.text.size)) +
  geom_text(data=data.frame(period=c(2030,2040),label=c("(Mtoe/yr)",NA)), aes(label = label,x = 0, y = 0), color = "#666666", size=geomText.size, hjust=1.4, na.rm = TRUE)

g[["milestone - vert"]][["Domestic Hydrogen Production"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=10, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = -Inf, y = 10, label = "REPowerEU\ndomestic", vjust = 0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") +
  expand_limits(y=c(0,20)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  theme(strip.text = element_text(angle = 90)) +
  coord_cartesian(clip = 'off') +
  annotate("text", x = -Inf, y = Inf, label = "(Mtoe/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size))

g[["milestone - hor"]][["Domestic Hydrogen Production"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mtoe/yr)")), aes(x = period, y = value, group=period)) +
  geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=6) +
  geom_hline(yintercept=10, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = -Inf, y = 10, label = "REPowerEU\ndomestic", angle=90, vjust = 0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,20)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mtoe/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)


g[["milestone - violin"]][["Domestic Hydrogen Production"]] <- ggplot(plotData %>% mutate(target = paste0(gsub("\n", " ", target)," (Mtoe/yr)")), aes(x = period, y = value, group=period)) +
  geom_violin(fill=violin_color, scale = violin_scale)  + #, trim=FALSE
  #geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=violin_boxPlotWidth) +
  geom_hline(yintercept=10, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  annotate("text", x = -Inf, y = 10, label = "REPowerEU\ndomestic", angle=90, vjust = 0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) +
  facet_grid(.~target, scales="free") +
  theme_doubleColumn() +
  coord_flip(clip = 'off') +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  scale_x_reverse(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL) +
  expand_limits(y=c(0,20)) + 
  theme(panel.spacing = unit(4, "lines")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(strip.placement = "outside") +
  #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) +
  #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) +
  theme(strip.text.x = element_text(hjust = 0, margin=margin(l=0, b=20))) #+
  #annotate("text", x = -Inf, y = -Inf, label = "(Mtoe/yr)", hjust = 1, color = "#666666", size = 0.8*geomText.size)


g[["Targets"]] <- gridExtra::arrangeGrob(
  g[["Emissions reductions"]] + theme(strip.text.x = element_blank()) + theme(plot.margin=margin(b=20, l = 30)), #+ theme(plot.margin=margin(10,10,30,10)),margin(t = 0, r = 0, b = 0, l = 0, unit = "pt")
  g[["Energy savings"]] + theme(plot.margin=margin(b=20, l = 10)),
  g[["Electricity Demand"]] + theme(plot.margin=margin(b=20, l = 35)),
  g[["Renewables Share"]] + theme(plot.margin=margin(b=20, l = 15)),
  g[["Wind capacity"]] + theme(plot.margin=margin(b=20, l = 50)),
  g[["Solar photovoltaics"]] + theme(plot.margin=margin(b=20, l = 10)),
  g[["Carbon Capture and Storage"]] + theme(plot.margin=margin(b=20, l = 15)),
  g[["Novel CDR"]] + theme(plot.margin=margin(b=20, l = 50)),
  g[["Direct Electrification"]] + theme(plot.margin=margin(b=20, l = 17)),
  g[["Carbon-free electricity share"]] + theme(plot.margin=margin(b=20, l = 24)),
  g[["Domestic Hydrogen Production"]] + theme(plot.margin=margin(b=20,l = 35)),
  g[["Residual Fossil Emissions"]] + theme(plot.margin=margin(b=20, l = 39)),
  ncol = 1
)

#ggsave(paste0(outChartsFolder,"/svg/targets.svg"), g[["Targets"]] , device="svg", width = 12, height = 17, dpi=100, units = "in")
#ggsave(paste0(outChartsFolder,"/png/targets.png"), g[["Targets"]] , device="png", width = 12, height = 17, dpi=300, units = "in")

g[["milestone - vert targets"]] <- gridExtra::arrangeGrob(
  g[["milestone - vert"]][["Emissions reductions"]] + theme(plot.margin=margin(r=30,t = 30)), #+ theme(plot.margin=margin(10,10,30,10)),margin(t = 0, r = 0, b = 0, l = 0, unit = "pt")
  g[["milestone - vert"]][["Energy savings"]] + theme(plot.margin=margin(r=30,t = 10)),
  g[["milestone - vert"]][["Renewables Share"]] + theme(plot.margin=margin(r=30,t = 15)),
  g[["milestone - vert"]][["Residual Fossil Emissions"]] + theme(plot.margin=margin(r=30,t = 39)),
  g[["milestone - vert"]][["Carbon Capture and Storage"]] + theme(plot.margin=margin(r=30,t = 15)),
  g[["milestone - vert"]][["Novel CDR"]] + theme(plot.margin=margin(t = 50)),
  
  g[["milestone - vert"]][["Electricity Demand"]] + theme(plot.margin=margin(r=30,t = 35)),
  g[["milestone - vert"]][["Wind capacity"]] + theme(plot.margin=margin(r=30,t = 50)),
  g[["milestone - vert"]][["Solar photovoltaics"]] + theme(plot.margin=margin(r=30,t = 10)),
  g[["milestone - vert"]][["Direct Electrification"]] + theme(plot.margin=margin(r=30,t = 17)),
  g[["milestone - vert"]][["Carbon-free electricity share"]] + theme(plot.margin=margin(t = 24)),
  g[["milestone - vert"]][["Domestic Hydrogen Production"]] + theme(plot.margin=margin(r=30,t = 35)),
  nrow = 2
)

#ggsave(paste0(outChartsFolder,"/svg/milestone - vert targets.svg"), g[["milestone - vert targets"]] , device="svg", width = 12, height = 17, dpi=100, units = "in")
#ggsave(paste0(outChartsFolder,"/png/milestone - vert targets.png"), g[["milestone - vert targets"]] , device="png", width = 12, height = 17, dpi=300, units = "in")


g[["milestone - hor targets"]] <- gridExtra::arrangeGrob(
  g[["milestone - hor"]][["Emissions reductions"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Energy savings"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Renewables Share"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Direct Electrification"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Carbon-free electricity share"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Domestic Hydrogen Production"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  g[["milestone - hor"]][["Electricity Demand"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Wind capacity"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Solar photovoltaics"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  g[["milestone - hor"]][["Residual Fossil Emissions"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Carbon Capture and Storage"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - hor"]][["Novel CDR"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  
  ncol = 2
)



g[["milestone - violin targets"]] <- gridExtra::arrangeGrob(
  g[["milestone - violin"]][["Emissions reductions"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Energy savings"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Renewables Share"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Direct Electrification"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Carbon-free electricity share"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Domestic Hydrogen Production"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  g[["milestone - violin"]][["Electricity Demand"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Wind capacity"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Solar photovoltaics"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  g[["milestone - violin"]][["Residual Fossil Emissions"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Carbon Capture and Storage"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  g[["milestone - violin"]][["Novel CDR"]] + theme(plot.margin=margin(l = 30, r = 10,t = 30)),
  
  ncol = 2
)


ggsave(paste0(outChartsFolder,"/svg/Figure 5. Milestones Panel.svg"), g[["milestone - violin targets"]] , device="svg", width = 12, height = 14, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Figure 5. Milestones Panel.png"), g[["milestone - violin targets"]] , device="png", width = 12, height = 14, dpi=300, units = "in")

```

<!-- ```{r, echo=FALSE} -->

<!-- g[["ECEMP abstract"]] <- gridExtra::arrangeGrob( -->
<!--   g[["milestone - vert"]][["Electricity Demand"]] + theme(plot.margin=margin(r=30,t = 35)), -->
<!--   g[["milestone - vert"]][["Direct Electrification"]] + theme(plot.margin=margin(r=30,t = 17)), -->
<!--   g[["milestone - vert"]][["Carbon-free electricity share"]] + theme(plot.margin=margin(t = 24)), -->
<!--   g[["milestone - vert"]][["Residual Fossil Emissions"]] + theme(plot.margin=margin(r=30,t = 39)), -->
<!--   g[["milestone - vert"]][["Carbon Capture and Storage"]] + theme(plot.margin=margin(r=30,t = 15)), -->
<!--   g[["milestone - vert"]][["Novel CDR"]] + theme(plot.margin=margin(t = 50)), -->
<!--   nrow = 1 -->
<!-- ) -->

<!-- ggsave(paste0(outChartsFolder,"/png/ECEMP abstract.png"), g[["ECEMP abstract"]] , device="png", width = 12, height = 8, dpi=300, units = "in") -->

<!-- ``` -->


```{r, echo=FALSE, fig.width=12, fig.height=14}

grid.newpage()
grid.draw(g[["milestone - hor targets"]])

```



---

# Supplementary Information:

### Supplementary Figure 1 - Variable renewables sensitivity panel

<!-- (a) Wind and Solar generation (TWh) -->

```{r supplChart_figure1a, echo=FALSE}

vars <- c(
#  "Solar CSP" = "SE|Electricity|Solar|CSP",
  "Solar PV" = "SE|Electricity|Solar|PV",
  "Wind Onshore" = "SE|Electricity|Wind|Onshore",
  "Wind Offshore" = "SE|Electricity|Wind|Offshore")

color <- c(
  "Solar CSP"     = "#ffcc00",
  "Solar PV"      = "#ffe600",
  "Wind Onshore"  = "#193F7F",
  "Wind Offshore" = "#337fff")

pattern <- c(
  "default"="none",
  "limited VRE"="stripe"
)

plotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2020,2030,2040,2050), scenario %in% c(mainScen,"Nzero_57_bio7p5_limVRE"), variable %in% vars) %>%
  mutate(scenName = ifelse(scenario == mainScen, "default", "limited VRE"),
         value = round(value * EJ2TWh),
         unit = "TWh")

#plotData %>% filter( period == 2040) %>% group_by(scenario) %>% summarise(value = sum(value))
#value2040 <- plotData %>% filter( period == 2040) %>% group_by(scenario) %>% summarise(value = sum(value)) %>% pull(value)
#round((1-value2040[2]/value2040[1])*100,2)

barwidth <- 3

g[["Wind and Solar generation"]] <- ggplot() +
  geom_bar_pattern(data = plotData %>% filter(scenario == mainScen), mapping = aes(x=period - (barwidth + 1)/2,y=value, fill=variable, pattern=scenName), stat='identity', position="stack", width = barwidth) +
  geom_bar_pattern(data = plotData %>% filter(scenario == "Nzero_57_bio7p5_limVRE"), mapping = aes(x=period + (barwidth + 1)/2,y=value, fill=variable, pattern=scenName), stat='identity', position="stack", width = barwidth, pattern_key_scale_factor = 0.3, pattern_density=0.3, pattern_spacing = 0.03, pattern_colour = "white", pattern_fill = "white", pattern_alpha=0.4) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars), guide = guide_legend(nrow = 1, order = 1, override.aes = list(pattern = "none"))) +
  scale_pattern_manual(values = pattern, breaks=c("default","limited VRE"), guide = guide_legend(nrow = 2, order = 1)) +
  scale_x_continuous(breaks=c(2020,2030,2040,2050), minor_breaks = NULL) +
  theme(axis.title.y = element_blank()) +
  #ylab("TWh") +
  #theme(legend.text=element_text(size=theme.single.text.size)) +
  theme(legend.margin=margin(t = -0.4, unit='cm')) +
  labs(title = "(a) Wind and Solar Generation (TWh)") + 
  #theme(plot.title = element_text(hjust=-0.1))
  theme(legend.box = "horizontal", 
        legend.box.just = "center")

 # ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 1 - Variable renewables sensitivity panel - (a) Wind and Solar generation.svg"), g[["Wind and Solar generation"]] , device="svg", width = 9, height = 6, dpi=100, units = "in")
 # ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 1 - Variable renewables sensitivity panel - (a) Wind and Solar generation.png"), g[["Wind and Solar generation"]] , device="png", width = 9, height = 6, dpi=300, units = "in")
  
```


(b) Limited VRE target reduction (%)

```{r supplChart_figure1b, echo=FALSE}

# error bars for scenarios with and without limVRE

plotData <- rbind(
  df %>%
    filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
    mutate(reduction = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)) ,2),
           scenName = "default") %>%
    select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  group_by(period) %>%
  mutate(min = min(reduction),
        max = max(reduction))
  ,
  df_beforeFilter %>%
    filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen, grepl("limVRE", scenario)) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
    mutate(reduction = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)) ,2),
           scenName = "limited VRE") %>%
    select(-variable) %>%
  filter(tgt2050 != "Npi") %>%
  group_by(period) %>%
  mutate(min = min(reduction),
        max = max(reduction))
)

g[["limVRE target reduction"]] <- ggplot(plotData, aes(x = scenName, y = reduction, group=scenName)) +
  geom_errorbar(mapping = aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +
  geom_boxplot(outlier.shape = NA, width=0.3) +
  geom_hline(yintercept=1, color = "black", linewidth=2, alpha = 0.5) +
  #geom_hline(yintercept=1, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") +
  theme_doubleColumn() +
  scale_y_reverse(breaks=c(1,0.95,0.9,0.85,0.8, 0.75), minor_breaks = NULL, labels = scales::percent) +
  expand_limits(y=c(1,0.75)) +
  labs(title = "(b) 2040 target (%)")

 # ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 1 - Variable renewables sensitivity panel - (b) 2040 target.svg"), g[["limVRE target reduction"]] , device="svg", width = 3, height = 6, dpi=100, units = "in")
 # ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 1 - Variable renewables sensitivity panel - (a) 2040 target.png"), g[["limVRE target reduction"]] , device="png", width = 3, height = 6, dpi=300, units = "in")


# g[["Supplementary Figure 1 - Variable renewables sensitivity panel"]] <- gridExtra::arrangeGrob(
#   g[["Wind and Solar generation"]], #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
#   g[["limVRE target reduction"]], #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
#   layout_matrix = rbind(c(1,1,1,2))
#   )

# ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 1 - Variable renewables sensitivity panel.svg"), g[["Supplementary Figure 1 - Variable renewables sensitivity panel"]] , device="svg", width = 12, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 1 - Variable renewables sensitivity panel.png"), g[["Supplementary Figure 1 - Variable renewables sensitivity panel(GW)"]] , device="png", width = 12, height = 6, dpi=300, units = "in")

```


```{r, echo=FALSE, include=FALSE}

g[["Supplementary figure 1"]] <- gridExtra::arrangeGrob(
  g[["Wind and Solar generation"]] + theme(plot.margin=margin(t=10)), 
  g[["limVRE target reduction"]] + theme(plot.margin=margin(l=20, b=10, t=10)), 
  layout_matrix = rbind(c(1,1,1,2))
)

ggsave(paste0(outChartsFolder,"/png/Supplementary figure 1. Variable Renewable Energy.png"), g[["Supplementary figure 1"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 1. Variable Renewable Energy.svg"), g[["Supplementary figure 1"]], device="svg", width = 12, height = 6, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Supplementary figure 1"]])

```

---

### Supplementary Figure 2 - Mitigation costs panel


<!-- :::: {style="display: flex;"} -->

<!-- ::: {} -->

<!-- (a) Carbon price (â‚¬/t CO2) -->

```{r supplChart_figure2a, echo=FALSE, include=FALSE}

vars <- c(
  "Carbon price" = "Price|Carbon"
)

plotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2020:2050), tgt2030 %in% tgt2030Scen, variable %in% vars) %>%
  mutate(period = as.Date(paste0("01/01/", period),format="%m/%d/%Y"),
         value = 1.17*value)

ETS_price <- addHist$ETS_price %>%
  mutate(scenario = "ETS price")


g[["Carbon Price"]] <- ggplot(plotData,aes(x=period,y=value,group = scenario)) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
  geom_line(size = 0.5, aes(linetype=tgt2030, color = efficiency)) +
  geom_point(size = 3, aes(shape = lim, fill = bioLim)) +
  geom_line(data=ETS_price,aes(x=Date, y=Price),size=0.5, color = "#000000") +
  scale_x_date(date_labels = "%Y") +
  scale_linetype_manual(values = c("55"="twodash", "57"="solid", "59"="dashed"), guide = guide_legend(nrow =1, byrow = T, order = 1, override.aes = list(linewidth = 1))) +   
  scale_color_manual(values = c("reference"="#ae0000", "EED 2018 Eff"="#db4646", "FitFor55 eff"="#0090ab", "RePowerEU eff"="#095786"), guide = guide_legend(nrow =2, byrow = F, order = 2, override.aes = list(linewidth = 1.5))) + 
  scale_fill_manual(values = c("BioLim4"="#fedc97", "BioLim7.5"="#b5b682", "BioLim12"="#7c9885", "BioLim20"="#28666e"), guide = guide_legend(nrow =2, byrow = F, override.aes = list(shape = 21, size = 6, colour = "transparent"), order = 3)) +
  scale_shape_manual(values = c("default"=21,"limCCS"=22,"limH2"=23,"limVRE"=24), guide = guide_legend(nrow =2, byrow = T, order = 4, override.aes = list(size = 6))) +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #guides(fill = guide_legend(nrow = 2, byrow = T)) +
  #theme(legend.text=element_text(size=theme.single.text.size)) +
  theme(legend.key.width = unit(2,"cm")) +
  theme(legend.position="right", legend.direction = "vertical", legend.box = "vertical") + 
  #theme(legend.key.width = unit(2,"cm")) +
  #ylab("â‚¬/t CO2") +
  theme(legend.spacing.y = unit(0.2, "lines")) +
  labs(title = "(a) Carbon price (â‚¬/t CO2)") #+ 
  #theme(plot.title = element_text(hjust=-0.1))
  #guides(linetype=guide_legend(keywidth = 3))
  
#  theme(legend.position="right", legend.direction = "vertical")

# ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 2 - Mitigation costs panel - (a) Carbon Price.svg"), g[["Carbon Price"]] , device="svg", width = 12, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary figure 2 - Mitigation costs panel - (a) Carbon Price.png"), g[["Carbon Price"]] , device="png", width = 12, height = 6, dpi=300, units = "in")

```


<!-- ```{r, echo=FALSE, fig.width=12, fig.height=5} -->

<!-- g[["Carbon Price"]] -->

<!-- ``` -->

<!-- (b) Energy supply electricity investments (billion â‚¬/yr) -->

```{r supplChart_figure2b, echo=FALSE, include=FALSE}

vars <- c(
#  "Grid" = "Energy Investments|Electricity|Grid",
  "Grid - BEV Chargers" = "Energy Investments|Electricity|Grid|BEV Chargers",
  "Grid - VRE support" = "Energy Investments|Electricity|Grid|VRE support",
  "Grid - T&D" = "Energy Investments|Electricity|Grid|Normal",
  "Hydrogen"   = "Energy Investments|Electricity|Hydrogen",
  "Storage"    = "Energy Investments|Electricity|Storage",
  "Solar" = "Energy Investments|Electricity|Solar",
  "Wind" = "Energy Investments|Electricity|Wind",
  "Hydro" = "Energy Investments|Electricity|Hydro",
  "Nuclear" = "Energy Investments|Electricity|Nuclear",
  "Geothermal" = "Energy Investments|Electricity|Geothermal",
  "Biomass w/ CC" = "Energy Investments|Electricity|Biomass|w/ CC",
  "Biomass w/o CC" = "Energy Investments|Electricity|Biomass|w/o CC",
  "Oil" = "Energy Investments|Electricity|Oil",
  "Gas w/ CC" = "Energy Investments|Electricity|Gas|w/ CC",
  "Gas w/o CC" = "Energy Investments|Electricity|Gas|w/o CC",
  "Coal w/ CC" = "Energy Investments|Electricity|Coal|w/ CC",
  "Coal w/o CC" = "Energy Investments|Electricity|Coal|w/o CC")
  
color <- c(
#   "Grid" = "",
  "Grid - BEV Chargers" = "#BC4873",
  "Grid - VRE support"  ="#003F5C",
  "Grid - T&D"     = "#472b62",
  "Storage"        = "#9500da",
  "Wind"           = "#337fff",
  "Solar"          = "#ffe600",
  "Biomass w/o CC" = "#005900",
  "Biomass w/ CC"  = "#33ff00",
  "Hydro"          = "#191999",
  "Geothermal"     = "#e51900",
  "Nuclear"        = "#ff33ff",
  "Hydrogen"       = "#5ed5b0",
  "Gas w/o CC"     = "#999959",
  "Gas w/ CC"      = "#b79e38",
  "Oil"            = "#b30000",
  "Coal w/o CC"    = "#0c0c0c",
  "Coal w/ CC"     = "#b2b2b2")
  
plotData <- df %>% 
  filter(region == "EU27", period >= 2020, period <= 2050, scenario  == mainScen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=vars),
   value = 1.17*value) #%>% 
 # arrange(factor(variable, levels = rev(vars))) 
  
g[["Energy Supply Investments"]] <- ggplot(plotData, aes(x=period,y=value, fill=variable)) +
  geom_bar(stat='identity', position="stack") +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars), guide = guide_legend(ncol = 1, order = 1)) +
  #ylab("billion â‚¬/yr") +
  theme(#legend.text=element_text(size=0.8*geomText.size),
        legend.key.height = unit(0.6, "cm"),
        legend.key.width = unit(0.6,"cm")) +
  theme(legend.position="left", legend.direction = "vertical", legend.box = "vertical",
        legend.margin=margin(t = 40)) +
  labs(title = "(b) Energy supply investments (billion â‚¬/yr) ") #+ 
  #theme(plot.title = element_text(hjust=-0.6))
  
# ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 2 - Mitigation costs panel - (b) Energy Supply Investments.svg"), g[["Energy Supply Investments"]] , device="svg", width = 12, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary figure 2 - Mitigation costs panel - (b) Energy Supply Investments.png"), g[["Energy Supply Investments"]] , device="png", width = 12, height = 6, dpi=300, units = "in")  

```

<!-- ```{r, echo=FALSE, fig.width=12, fig.height=5} -->

<!-- g[["Energy Supply Investments"]] -->

<!-- ``` -->

```{r, echo=FALSE, include=FALSE}

g[["Supplementary figure 2"]] <- gridExtra::arrangeGrob(
  g[["Carbon Price"]], 
  g[["Energy Supply Investments"]], 
  layout_matrix = rbind(
    c(1),
    c(2)
  ))

ggsave(paste0(outChartsFolder,"/png/Supplementary figure 2. EU-27 mitigation costs panel.png"), g[["Supplementary figure 2"]], device="png", width = 12, height = 10, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 2. EU-27 mitigation costs panel.svg"), g[["Supplementary figure 2"]], device="svg", width = 12, height = 10, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=10}

grid.newpage()
grid.draw(g[["Supplementary figure 2"]])

```


---

### Supplementary Figure 3 - Country results electricity capacity panel (GW)


```{r supplChart_figure3, echo=FALSE, include=FALSE}

vars <- c(
  "Net Imports" = "Cap|Electricity|Net Imports",
  "Coal w/ CC" = "Cap|Electricity|Coal|w/ CC",
  "Coal w/o CC" = "Cap|Electricity|Coal|w/o CC",
  "Oil" = "Cap|Electricity|Oil",
  "Gas w/ CC" = "Cap|Electricity|Gas|w/ CC",
  "Gas w/o CC" = "Cap|Electricity|Gas|w/o CC",
  "Hydrogen" = "Cap|Electricity|Hydrogen",
  "Nuclear" = "Cap|Electricity|Nuclear",
  "Geothermal" = "Cap|Electricity|Geothermal",
  "Hydro" = "Cap|Electricity|Hydro",
  "Biomass w/ CC" = "Cap|Electricity|Biomass|w/ CC",
  "Biomass w/o CC" = "Cap|Electricity|Biomass|w/o CC",
  "Solar CSP" = "Cap|Electricity|Solar|CSP",
  "Solar PV" = "Cap|Electricity|Solar|PV",
  "Wind Onshore" = "Cap|Electricity|Wind|Onshore",
  "Wind Offshore" = "Cap|Electricity|Wind|Offshore",
  "Battery Storage" = "Cap|Electricity|Storage|Battery")

color <- c(
  "Net Imports"   = "#472b62",
  "Coal w/ CC"    = "#b2b2b2",
  "Coal w/o CC"   = "#0c0c0c",
  "Oil"           = "#b30000",
  "Gas w/ CC"     = "#b79e38",
  "Gas w/o CC"    = "#999959",
  "Hydrogen"      = "#5ed5b0",
  "Nuclear"       = "#ff33ff",
  "Geothermal"    = "#e51900",
  "Hydro"         = "#191999",
  "Biomass w/ CC" = "#33ff00",
  "Biomass w/o CC"= "#005900",
  "Solar CSP"     = "#ffcc00",
  "Solar PV"      = "#ffe600",
  "Wind Onshore"  = "#193F7F",
  "Wind Offshore" = "#337fff",
  "Battery Storage"="#9500da")

regName <- c(
  "EU27" = "European Union",
  "DEU" = "Germany",
  "FRA" = "France"
)

plotData <- df %>% 
  filter(region %in% c("EU27","DEU","FRA"), period >= 2020, period <= 2060, scenario  == mainScen, variable %in% unlist(vars)) %>% 
  mutate(variable = factor(variable, levels=rev(vars)),
         region = factor(region, levels=c("EU27","DEU","FRA"))) %>% 
  arrange(factor(variable, levels = rev(vars))) %>%
  mutate(regionName = regName[region])

g[["Capacity"]] <- lapply(setNames(c("EU27","DEU","FRA"),c("EU27","DEU","FRA")), function(reg){
  gg <- ggplot(plotData %>% filter(region == reg),aes(x=period,y=value)) +
  geom_area(aes(fill=variable),alpha=0.8) +
  facet_wrap(~regionName, scales = "free_y") +
  theme_doubleColumn() +
  scale_x_continuous(breaks=c(2020,2040,2060)) +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) +
  theme(legend.position="none") +
  theme(axis.title.y=element_blank()) +
  theme(strip.clip = "off")
})

g[["Capacity_2040"]] <- lapply(setNames(c("EU27","DEU","FRA"),c("EU27","DEU","FRA")), function(reg){
  gg <- ggplot(plotData %>%
                 filter(region == reg, period == 2040) %>%
                 group_by(model,scenario,region,period) %>%
                 mutate(n = sum(value), percentage = value / n),
               aes(x=period,y=percentage)) +
  geom_bar(aes(fill=variable),alpha=0.8,stat='identity') +
  facet_wrap(~period, scales = "free_y") +
  theme_doubleColumn() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(breaks=c(2040)) +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) +
  theme(legend.position="none") +
  theme(axis.title.y=element_blank()) +
  theme(strip.clip = "off")
})

## Function to extract legend
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

legend <- g_legend(
  ggplot(plotData,aes(x=period,y=value)) +
  geom_area(aes(fill=variable),alpha=0.8) +
  theme_doubleColumn() +
  scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) +
  guides(fill=guide_legend(nrow=2,override.aes = list(alpha=1))) +
  theme(#legend.text = element_text(size = theme.double.text.size),
        #legend.key.height = unit(0.8, "cm"),
        #legend.key.width = unit(0.8,"cm"),
        legend.spacing.x = unit(0.3, 'cm')) +
  theme(legend.title=element_blank(),
        legend.margin=margin(c(0,0,0,0))) +
  theme(plot.margin=margin(0,0,0,0)) + 
  theme(legend.margin=margin(l=-10))
) 

g[["Supplementary Figure 3 - Country results electricity capacity panel (GW)"]] <- gridExtra::arrangeGrob(
  g[["Capacity"]][["EU27"]] + theme(plot.margin=margin(b=0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  g[["Capacity_2040"]][["EU27"]] + theme(plot.margin=margin(0,20,37,0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  g[["Capacity"]][["DEU"]] + theme(plot.margin=margin(b=0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  g[["Capacity_2040"]][["DEU"]] + theme(plot.margin=margin(0,20,37,0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  g[["Capacity"]][["FRA"]] + theme(plot.margin=margin(b=0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  g[["Capacity_2040"]][["FRA"]] + theme(plot.margin=margin(0,20,37,0)), #+ theme(plot.margin=margin(80,5,50,0)), #margin(t = 0, r = 0, b = 0, l = 0
  legend,
  layout_matrix = rbind(c(1,1,1,1, 2,2, 3,3,3,3, 4,4, 5,5,5,5, 6,6),
                        c(1,1,1,1, 2,2, 3,3,3,3, 4,4, 5,5,5,5, 6,6),
                        c(1,1,1,1, 2,2, 3,3,3,3, 4,4, 5,5,5,5, 6,6),
                        rep(7,18))
  )

 ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 3 - Country results electricity capacity panel (GW).svg"), g[["Supplementary Figure 3 - Country results electricity capacity panel (GW)"]] , device="svg", width = 12, height = 5, dpi=100, units = "in")
 ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 3 - Country results electricity capacity panel (GW).png"), g[["Supplementary Figure 3 - Country results electricity capacity panel (GW)"]] , device="png", width = 12, height = 5, dpi=300, units = "in")

```

```{r, echo=FALSE, fig.width=12, fig.height=5}

grid.newpage()
grid.draw(g[["Supplementary Figure 3 - Country results electricity capacity panel (GW)"]])

```      


---

### Supplementary Figure 4 - Sectoral mitigation - Energy and non-energy use panel


<!-- :::: {style="display: flex;"} -->

<!-- ::: {} -->

<!-- (a) per sector and carrier -->

```{r supplChart_figure4a, echo=FALSE, include=FALSE}

vars <- list(
  "Transport - Electricity" = "FE|Transport|Electricity",
  "Buildings - Electricity" = "FE|Buildings|Electricity",
  "Industry - Electricity" = "FE|Industry|Electricity",
  "Transport - Hydrogen" = "FE|Transport|Hydrogen",
  "Buildings - Hydrogen" = "FE|Buildings|Hydrogen",
  "Industry - Hydrogen" = "FE|Industry|Hydrogen",
  "Buildings - Heat" = "FE|Buildings|Heat",
  "Industry - Heat" = "FE|Industry|Heat",
  "Transport - Gases" = "FE|Transport|Gases",
  "Buildings - Gases" = "FE|Buildings|Gases",
  "Industry - Gases" = "FE|Industry|Gases",
  "Transport - Liquids" = "FE|Transport|Liquids",
  "Buildings - Liquids" = "FE|Buildings|Liquids",
  "Industry - Liquids" = "FE|Industry|Liquids",
  "Buildings - Solids" = "FE|Buildings|Solids",
  "Industry - Solids" = "FE|Industry|Solids"
)

plotColor <- list(
  "Transport - Electricity" = "#ffb200",
  "Buildings - Electricity" = "#ffcc55",
  "Industry - Electricity" = "#fa8c02",
  "Transport - Hydrogen" = "#46fc02",
  "Buildings - Hydrogen" = "#94ff6c",
  "Industry - Hydrogen" = "#2b7c0d",
  "Buildings - Heat" = "#ff7a59",
  "Industry - Heat" = "#b92400",
  "Transport - Gases" = "#b200ff",
  "Buildings - Gases" = "#c875ec",
  "Industry - Gases" = "#610d85",
  "Transport - Liquids" = "#0f30ec",
  "Buildings - Liquids" = "#7e8fef",
  "Industry - Liquids" = "#04167c",
  "Buildings - Solids" = "#a5a5a5",
  "Industry - Solids" = "#1b1b1b"
)

plotData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable %in% vars, scenario == mainScen) %>%
  mutate(variable=factor(variable, levels=vars))
  
#total
totalData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "FE", scenario == mainScen)

if(energyInMtoe){
  plotData <- plotData %>%
    mutate(
      value = value*EJ2Mtoe,
      unit  = "Mtoe/yr")
  totalData <- totalData %>%
    mutate(
      value = value*EJ2Mtoe,
      unit  = "Mtoe/yr")
}

g[["Supplementary Figure 4a. Final energy demand per sector and carrier"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_area(aes(fill=variable), alpha = 0.8) +
  geom_line(data=totalData, linewidth = 1, color="black") +
  geom_vline(xintercept=2020, color = "black", linetype="dashed", linewidth=1, alpha = 0.5) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  #ylab("Final Energy Demand - EJ/yr") + 
  #ggtitle("(a) per sector and carrier") +
  scale_fill_manual(values = setNames(plotColor[names(vars)],vars), labels = setNames(names(vars), vars), guide = guide_legend(nrow = 6)) +
  theme(legend.margin=margin(l = -1, unit='cm')) +
  scale_x_continuous(breaks=c(2010, 2010, 2020,2030,2040,2050)) + 
  theme(axis.title.x=element_blank()) +
  theme(axis.title.y=element_blank()) +
  theme(legend.title = element_blank()) +
  theme(#legend.text = element_text(size = theme.double.text.size*0.7),
        #legend.key.height = unit(0.7, "cm"),
        #legend.key.width = unit(0.7,"cm"),
        legend.spacing.x = unit(0.2, 'cm')) + 
  #  theme(plot.title = element_text(size = 1.2*theme.double.text.size)) +
  labs(title = paste0("(a) Energy and non-energy use per sector and carrier (", unique(plotData$unit), ")")) +
  theme(plot.title = element_text(hjust=1))

ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 4a. Final energy demand per sector and carrier.svg"), g[["Supplementary Figure 4a. Final energy demand per sector and carrier"]] , device="svg", width = 6, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 4a. Final energy demand per sector and carrier.png"), g[["Supplementary Figure 4a. Final energy demand per sector and carrier"]] , device="png", width = 6, height = 8, dpi=300, units = "in")
 
 
```

<!-- ```{r, echo=FALSE, fig.width=6, fig.height=8} -->

<!-- g[["Supplementary Figure 4a. Final energy demand per sector and carrier"]] -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {} -->

<!-- (b) per fossil content -->

```{r supplChart_figure4b, echo=FALSE, include=FALSE}

vars <- list(
  "Electric - Non-Fossil" = c(
    "FE|Transport|Electricity|Non-Fossil",
    "FE|Buildings|Electricity|Non-Fossil",
    "FE|Industry|Electricity|Non-Fossil"
   ),
  "Non-Electric - Non-Fossil" = c(
    "FE|Transport|Hydrogen",
    "FE|Buildings|Hydrogen",
    "FE|Industry|Hydrogen",
    "FE|Buildings|Heat",
    "FE|Industry|Heat",
    "FE|Transport|Gases|Biomass",
    "FE|Transport|Gases|Hydrogen",
    "FE|Buildings|Gases|Biomass",
    "FE|Buildings|Gases|Hydrogen",
    "FE|Industry|Gases|Biomass",
    "FE|Industry|Gases|Hydrogen",
    "FE|Transport|Liquids|Biomass",
    "FE|Transport|Liquids|Hydrogen",
    "FE|Buildings|Liquids|Biomass",
    "FE|Buildings|Liquids|Hydrogen",
    "FE|Industry|Liquids|Biomass",
    "FE|Industry|Liquids|Hydrogen",
    "FE|Buildings|Solids|Biomass",
    "FE|Industry|Solids|Biomass"
  ), 
  "Electric - Fossil" = c(
    "FE|Transport|Electricity|Fossil",
    "FE|Buildings|Electricity|Fossil",
    "FE|Industry|Electricity|Fossil"
   ),
  "Non-Electric - Fossil" = c(
    "FE|Buildings|Gases|Fossil",
    "FE|Transport|Gases|Fossil",
    "FE|Industry|Gases|Fossil",
    "FE|Transport|Liquids|Fossil",
    "FE|Buildings|Liquids|Fossil",
    "FE|Industry|Liquids|Fossil",
    "FE|Buildings|Solids|Fossil",
    "FE|Industry|Solids|Fossil"
  )
)

plotColor <- list(
  "Electric - Non-Fossil" = "#e56b6f",
  "Non-Electric - Non-Fossil" = "#6d597a",
  "Electric - Fossil" = "#474973",
  "Non-Electric - Fossil" = "#161b33"
)

var2label <- c()
for(label in names(vars)){
  for (var in vars[[label]]){
    tmp <- as.character(label)
    names(tmp) <- as.character(var)
    var2label <- c(var2label,tmp)
  }
} 

plotData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable %in% unlist(vars), scenario == mainScen) %>%
  mutate(label=as.character(var2label[as.character(variable)])) %>%
  mutate(label=factor(label, levels=names(vars))) %>%
  group_by(period,label,unit) %>%
  summarize(value = sum(value))

#total
totalData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "FE", scenario == mainScen) 

if(energyInMtoe){
  plotData <- plotData %>%
    mutate(
      value = value*EJ2Mtoe,
      unit  = "Mtoe/yr")
  totalData <- totalData %>%
    mutate(
      value = value*EJ2Mtoe,
      unit  = "Mtoe/yr")
}

g[["Supplementary Figure 4b. Final energy demand per fossil content"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_area(aes(fill=label), alpha = 0.8) +
  geom_line(data=totalData, linewidth = 1, color="black") +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  geom_vline(xintercept=2020, color = "black", linetype="dashed", linewidth=1, alpha = 0.5) +
  theme_doubleColumn() +
  scale_fill_manual(values = plotColor, guide = guide_legend(nrow = 6)) +
  #ggtitle("(b) per fossil content") +
  theme(legend.margin=margin(l = -1, unit='cm')) +
  scale_x_continuous(breaks=c(2010, 2010, 2020,2030,2040,2050)) + 
  theme(axis.title.x=element_blank()) +
  theme(axis.title.y=element_blank()) +
  theme(legend.title = element_blank()) +
  theme(#legend.text = element_text(size = theme.double.text.size*0.7),
        #legend.key.height = unit(0.7, "cm"),
        #legend.key.width = unit(0.7,"cm"),
        legend.spacing.x = unit(0.2, 'cm')) + 
  #  theme(plot.title = element_text(size = 1.2*theme.double.text.size)) +
  labs(title = paste0("(b) Energy and non-energy use per fossil content (", unique(plotData$unit), ")")) +
  theme(plot.title = element_text(hjust=1)) 

# ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 4b. Final energy demand per fossil content.svg"), g[["Supplementary Figure 4b. Final energy demand per fossil content"]] , device="svg", width = 6, height = 8, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 4b. Final energy demand per fossil content.png"), g[["Supplementary Figure 4b. Final energy demand per fossil content"]] , device="png", width = 6, height = 8, dpi=300, units = "in")
 
```

<!-- ```{r, echo=FALSE, fig.width=6, fig.height=8} -->

<!-- g[["Supplementary Figure 4b. Final energy demand per fossil content"]] -->

<!-- ``` -->
<!-- ::: -->

<!-- :::: -->

```{r, echo=FALSE, include=FALSE}

g[["Supplementary figure 4"]] <- gridExtra::arrangeGrob(
  g[["Supplementary Figure 4a. Final energy demand per sector and carrier"]], 
  g[["Supplementary Figure 4b. Final energy demand per fossil content"]], 
  layout_matrix = rbind(
    c(1,2)
  ))

ggsave(paste0(outChartsFolder,"/png/Supplementary figure 4. Energy and non-energy use.png"), g[["Supplementary figure 4"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 4. Energy and non-energy use.svg"), g[["Supplementary figure 4"]], device="svg", width = 12, height = 8, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=8}

grid.newpage()
grid.draw(g[["Supplementary figure 4"]])

```


---

### Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector (Mt CO2/yr)

```{r supplChart_figure5, echo=FALSE, include=FALSE}

vars <- c(
  "Energy Supply - Electricity"               = "Emi|GHG|Gross|Energy|Supply|Electricity",
  "Energy Supply - Non-electric"              = "Emi|GHG|Gross|Energy|Supply|Non-electric",
  "Energy Demand - Transport"                 = "Emi|GHG|Energy|Demand|Transport",
  "Energy Demand - International Bunkers"     = "Emi|CO2|Energy|Demand|Transport|International Bunkers",
  "Energy Demand - Buildings"                 = "Emi|GHG|Energy|Demand|Buildings",
  "Energy Demand - Industry and Agriculture"  = "Emi|GHG|Gross|Energy|Demand|Industry",
  "Energy Demand - Carbon Dioxide Removal"    = "Emi|GHG|Energy|Demand|CDR",
  "Industrial Processes"                      = "Emi|GHG|Industrial Processes",
  "Agriculture"                               = "Emi|GHG|Agriculture",
  "Land-Use Change"                           = "Emi|GHG|Land-Use Change|LULUCF national accounting", #"Emi|GHG|Land-Use Change",
  "Waste"                                     = "Emi|GHG|Waste",
  "BECCS"                                     = "Emi|CO2|CDR|BECCS",
  "Industry CCS"                              = "Emi|CO2|CDR|Industry CCS|Synthetic Fuels",
  "DACCS"                                     = "Emi|CO2|CDR|DACCS",
  "Enhanced Weathering"                       = "Emi|CO2|CDR|EW")


plotColor <- c(
  "Energy Supply - Electricity"               = "#ffb200",
  "Energy Supply - Non-electric"              = "#0000cc",
  "Energy Demand - Transport"                 = "#a1dd70",
  "Energy Demand - International Bunkers"     = "#ffc0cb",
  "Energy Demand - Buildings"                 = "#5edfff",
  "Energy Demand - Industry and Agriculture"  = "#5f6769",
  "Energy Demand - Carbon Dioxide Removal"    = "#999959",
  "Industrial Processes"                      = "#5c5c5c",
  "Agriculture"                               = "#357933",
  "Land-Use Change"                           = "#6ec16b",
  "Waste"                                     = "#A52A2A",
  "BECCS"                                     = "#377EB8",
  "Industry CCS"                              = "#5ed5b0",
  "DACCS"                                     = "#CC6666",
  "Enhanced Weathering"                       = "#5b0d8f") 

plotData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable %in% vars, scenario == mainScen) %>%
  mutate(variable=factor(variable, levels=vars))
  
#total
totalData <- df %>%
  calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emissions with LULUCF and with international transport", scenario == mainScen)

# check <- left_join(
#   plotData %>% group_by(period) %>% summarize(value = sum(value)),
#   totalData %>% group_by(period) %>% summarize(total = sum(value)),
#   by = join_by(period == period)
# ) %>%
#   mutate(diff= round(total-value,2))
# 
# left_join(
#   plotData %>% filter(period == 2010) %>% mutate(value2010 = value),
#   plotData %>% filter(period == 2015) %>% mutate(value2015 = value),
#   by = join_by(variable == variable)
# ) %>%
#   mutate(diff= round(value2015-value2010,2)) %>%
#   select(variable,value2010,value2015,diff)

g[["Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_area(aes(fill=variable), alpha = 0.8) +
  geom_line(data=totalData, linewidth = 1, color="black") +
  geom_vline(xintercept=2020, color = "black", linetype="dashed", linewidth=1, alpha = 0.5) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  #ylab("Final Energy Demand - EJ/yr") + 
  #ggtitle("(a) per sector and carrier") +
  scale_fill_manual(values = setNames(plotColor[names(vars)],vars), labels = setNames(names(vars), vars)) +
  #theme(legend.margin=margin(l = -1, unit='cm')) +
  scale_x_continuous(breaks=c(2010, 2010, 2020,2030,2040,2050)) + 
  theme(axis.title.x=element_blank()) +
  theme(axis.title.y=element_blank()) +
  theme(legend.title = element_blank()) +
  theme(#legend.text = element_text(size = theme.double.text.size*0.7),
        #legend.key.height = unit(0.7, "cm"),
        #legend.key.width = unit(0.7,"cm"),
        legend.spacing.x = unit(0.2, 'cm')) + 
  #  theme(plot.title = element_text(size = 1.2*theme.double.text.size)) +
  theme(legend.position="right", legend.direction = "vertical", legend.box = "vertical")

ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector.svg"), g[["Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector"]] , device="svg", width = 12, height = 6, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector.png"), g[["Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector"]] , device="png", width = 12, height = 6, dpi=300, units = "in")

```

```{r, echo=FALSE, fig.width=12, fig.height=6}

g[["Supplementary Figure 5 - Sectoral mitigation - GHG Emissions per sector"]]

```

<!-- explain LULUCF and agriculture assumptions  -->

---

### Supplementary Figure 6 - GHG emissions per gases (Mt CO2/yr)


```{r supplChart_figure6, echo=FALSE, include=FALSE}

vars <- c(
  "CO2 - Energy"                = "Emi|CO2|Energy",
  "CO2 - International Bunkers" = "Emi|CO2|Energy|Demand|Transport|International Bunkers",
  "CO2 - Industrial Processes"  = "Emi|CO2|Industrial Processes",
  "CO2 - Land-Use Change"       = "Emi|CO2|Land-Use Change|LULUCF national accounting", #"Emi|CO2|Land-Use Change",
  "CO2 - non-BECCS CDR"         = "Emi|CO2|non-BECCS CDR",
  "CH4"                         = "Emi|GHG|CH4",
  "N2O"                         = "Emi|GHG|N2O",
  "F-Gases"                     = "Emi|GHG|F-Gases"
  )

plotColor <- c(
  "CO2 - Energy"                = "#3D4849",
  "CO2 - International Bunkers" = "#ffc0cb",
  "CO2 - Industrial Processes"  = "#5c5c5c",
  "CO2 - Land-Use Change"       = "#6ec16b",
  "CO2 - non-BECCS CDR"         = "#5b0d8f",
  "CH4"                         = "#ffe7a0",
  "N2O"                         = "#44ba97",
  "F-Gases"                     = "#ff9977"
)


plotData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable %in% vars, scenario == mainScen) %>%
  mutate(variable=factor(variable, levels=vars))

#plotData %>% group_by(period) %>% summarize(value = sum(value))

  
#total
totalData <- df %>%
  calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emissions with LULUCF and with international transport", scenario == mainScen)

g[["Supplementary Figure 6 - GHG emissions per gases"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_area(aes(fill=variable), alpha = 0.8) +
  geom_line(data=totalData, linewidth = 1, color="black") +
  geom_vline(xintercept=2020, color = "black", linetype="dashed", linewidth=1, alpha = 0.5) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  theme_doubleColumn() +
  #ylab("Final Energy Demand - EJ/yr") + 
  #ggtitle("(a) per sector and carrier") +
  scale_fill_manual(values = setNames(plotColor[names(vars)],vars), labels = setNames(names(vars), vars)) +
  #theme(legend.margin=margin(l = -1, unit='cm')) +
  scale_x_continuous(breaks=c(2010, 2010, 2020,2030,2040,2050)) + 
  theme(axis.title.x=element_blank()) +
  theme(axis.title.y=element_blank()) +
  theme(legend.title = element_blank()) +
  theme(#legend.text = element_text(size = theme.double.text.size*0.7),
        #legend.key.height = unit(0.7, "cm"),
        #legend.key.width = unit(0.7,"cm"),
        legend.spacing.x = unit(0.2, 'cm')) + 
  #  theme(plot.title = element_text(size = 1.2*theme.double.text.size)) +
  theme(legend.position="right", legend.direction = "vertical", legend.box = "vertical")

ggsave(paste0(outChartsFolder,"/svg/Supplementary Figure 6 - GHG emissions per gases.svg"), g[["Supplementary Figure 6 - GHG emissions per gases"]] , device="svg", width = 12, height = 6, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Supplementary Figure 6 - GHG emissions per gases.png"), g[["Supplementary Figure 6 - GHG emissions per gases"]] , device="png", width = 12, height = 6, dpi=300, units = "in")



# 
#   "Emi|CO2|Energy",
#   "Emi|CO2|Industrial Processes",
#   "Emi|CO2|Land-Use Change",
#   "Emi|GHG|CH4",
#   "Emi|GHG|N2O",
#   "Emi|GHG|F-Gases",
#   "Emi|CO2|non-BECCS CDR")
# 
# 
# Emi|CH4
# Emi|CH4|Extraction
# Emi|CH4|Agriculture
# Emi|CH4|Land-Use Change
# Emi|CH4|Waste
# Emi|CH4|Energy Supply
# Emi|N2O
# Emi|N2O|Agriculture
# Emi|N2O|Land-Use Change
# Emi|N2O|Waste
# Emi|N2O|Transport
# Emi|N2O|Industry
# Emi|N2O|Energy Supply
# Emi|GHG|F-Gases

# Emi|CO2
# Emi|CO2|Land-Use Change
# Emi|CO2|Industrial Processes
# Emi|CO2|Energy|Demand|Transport
# Emi|CO2|Energy|Demand|Industry
# Emi|CO2|Energy|Demand|Buildings
# Emi|CO2|Energy|Supply|Non-electric
# Emi|CO2|Energy|Supply|Electricity w/ couple prod
# Emi|CO2|CDR|DACCS
# Emi|CO2|CDR|EW
# Emi|CO2|Energy|Waste

```


```{r, echo=FALSE, fig.width=12, fig.height=6}

g[["Supplementary Figure 6 - GHG emissions per gases"]]

```

---

### Supplementary Figure 7 - Carbon-dioxide removal


<!-- :::: {style="display: flex;"} -->

<!-- ::: {} -->

<!-- (a) Bioenergy with Carbon Capture and Storage - BECCS (Mt CO2/yr) -->

```{r supplChart_figure7a, echo=FALSE, include=FALSE}

vars <- c(
  "BECCS" = "Emi|CO2|CDR|BECCS"
)

plotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2020:2050), tgt2030 %in% tgt2030Scen, variable %in% vars) %>%
  mutate(min = min(value), max = max(value))

limitsBECCS <- c(
  min(
    df_beforeFilter %>%
      filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen, variable %in% vars) %>% pull(value)),
  max(
    df_beforeFilter %>%
      filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen, variable %in% vars) %>% pull(value)
    ))

limY <- min(plotData %>% pull(min))

g[["BECCS"]] <- ggplot(plotData,aes(x=period,y=value,group = scenario)) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
  geom_line(size = 0.5, aes(linetype=tgt2030, color = efficiency)) +
  geom_point(size = 3, aes(shape = lim, fill = bioLim)) +
  #scale_x_date(date_labels = "%Y") +
  scale_linetype_manual(values = c("55"="twodash", "57"="solid", "59"="dashed"), guide = guide_legend(nrow =1, byrow = T, order = 1, override.aes = list(linewidth = 1.5))) + 
  scale_color_manual(values = c("reference"="#ae0000", "EED 2018 Eff"="#db4646", "FitFor55 eff"="#0090ab", "RePowerEU eff"="#095786"), guide = guide_legend(nrow =4, byrow = T, order = 2, override.aes = list(linewidth = 1.5))) + 
  scale_fill_manual(values = c("BioLim4"="#fedc97", "BioLim7.5"="#b5b682", "BioLim12"="#7c9885", "BioLim20"="#28666e"), guide = guide_legend(nrow =2, byrow = T, override.aes = list(shape = 21, size = 8), order = 3)) +
  scale_shape_manual(values = c("default"=21,"limCCS"=22,"limH2"=23,"limVRE"=24), guide = guide_legend(nrow =2, byrow = T, order = 4, override.aes = list(size = 8))) +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #guides(fill = guide_legend(nrow = 2, byrow = T)) +
  #theme(legend.text=element_text(size=theme.single.text.size)) +
  theme(legend.key.width = unit(2,"cm")) +
  theme(legend.position="right", legend.direction = "vertical", legend.box = "vertical") + 
  #theme(legend.key.width = unit(2,"cm")) +
  theme(legend.spacing.y = unit(0.5, "lines")) +
  theme(legend.position="none") +
  expand_limits(y=limitsBECCS) +
  labs(title = expression(paste("(a) BECCS (Mt ", CO[2],"/yr)"))) +
  theme(plot.title = element_text(hjust=-0.1))

#  theme(legend.position="right", legend.direction = "vertical")

# ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 7 - Carbon-dioxide removal - (a) Bioenergy with Carbon Capture and Storage - BECCS.svg"), g[["BECCS"]] , device="svg", width = 4, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary figure 7 - Carbon-dioxide removal - (a) Bioenergy with Carbon Capture and Storage - BECCS.png"), g[["BECCS"]] , device="png", width = 4, height = 6, dpi=300, units = "in")

```

<!-- ```{r, echo=FALSE, fig.width=4, fig.height=6} -->

<!-- g[["BECCS"]] -->

<!-- ``` -->

<!-- ::: -->

<!-- ::: {} -->

<!-- (b) Direct Air Capture (Mt CO2/yr) -->

```{r supplChart_figure7b, echo=FALSE, include=FALSE}


#"Emi|CO2|CDR|BECCS","Emi|CO2|CDR|DACCS","Emi|CO2|CDR|Industry CCS|Synthetic Fuels"

vars <- c(
  "DAC" = "Emi|CO2|CDR|DACCS"
)

plotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2020:2050), tgt2030 %in% tgt2030Scen, variable %in% vars)

limitsDAC <- df_beforeFilter %>%
  filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen, variable %in% vars) %>%
  group_by(lim) %>%
  summarize (min = min(value), max = max(value))

g[["DAC"]] <- ggplot(plotData,aes(x=period,y=value,group = scenario)) +
  geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
  geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
  geom_line(size = 0.5, aes(linetype=tgt2030, color = efficiency)) +
  geom_point(size = 3, aes(shape = lim, fill = bioLim)) +
  #scale_x_date(date_labels = "%Y") +
  scale_linetype_manual(values = c("55"="twodash", "57"="solid", "59"="dashed"), guide = guide_legend(nrow =1, byrow = T, order = 1, override.aes = list(linewidth = 1))) +   scale_color_manual(values = c("reference"="#ae0000", "EED 2018 Eff"="#db4646", "FitFor55 eff"="#0090ab", "RePowerEU eff"="#095786"), guide = guide_legend(nrow =2, byrow = F, order = 2, override.aes = list(linewidth = 1.5))) + 
  scale_fill_manual(values = c("BioLim4"="#fedc97", "BioLim7.5"="#b5b682", "BioLim12"="#7c9885", "BioLim20"="#28666e"), guide = guide_legend(nrow =2, byrow = F, override.aes = list(shape = 21, size = 6, colour = "transparent"), order = 3)) +
  scale_shape_manual(values = c("default"=21,"limCCS"=22,"limH2"=23,"limVRE"=24), guide = guide_legend(nrow =2, byrow = T, order = 4, override.aes = list(size = 6))) +
  theme_doubleColumn() +
  theme(axis.title.y=element_blank()) +
  theme(strip.text.y = element_blank()) +
  #guides(fill = guide_legend(nrow = 2, byrow = T)) +
  #theme(legend.text=element_text(size=theme.single.text.size)) +
  theme(legend.key.width = unit(2,"cm")) +
  theme(legend.position="right", legend.direction = "vertical", legend.box = "vertical") + 
  #theme(legend.key.width = unit(2,"cm")) +
  theme(legend.spacing.y = unit(0.3, "lines")) +
  expand_limits(y=limY) +
  labs(title = expression(paste("(b) Direct Air Capture (Mt ", CO[2],"/yr)"))) +
  theme(plot.title = element_text(hjust=-0.1))

  
#  theme(legend.position="right", legend.direction = "vertical")

# ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 7 - Carbon-dioxide removal - (b) Direct Air Capture.svg"), g[["DAC"]] , device="svg", width = 8, height = 6, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Supplementary figure 7 - Carbon-dioxide removal - (b) Direct Air Capture.png"), g[["DAC"]] , device="png", width = 8, height = 6, dpi=300, units = "in")

```


<!-- ```{r, echo=FALSE, fig.width=8, fig.height=6} -->

<!-- g[["DAC"]] -->

<!-- ``` -->

<!-- ::: -->

<!-- :::: -->

```{r, echo=FALSE, include=FALSE}

g[["Supplementary figure 7"]] <- gridExtra::arrangeGrob(
  g[["BECCS"]], 
  g[["DAC"]], 
  layout_matrix = rbind(
    c(1,1,1,2,2,2,2,2,2,2))
  )

ggsave(paste0(outChartsFolder,"/png/Supplementary figure 7. Carbon-dioxide removal.png"), g[["Supplementary figure 7"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outChartsFolder,"/svg/Supplementary figure 7. Carbon-dioxide removal.svg"), g[["Supplementary figure 7"]], device="svg", width = 12, height = 6, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Supplementary figure 7"]])

```


