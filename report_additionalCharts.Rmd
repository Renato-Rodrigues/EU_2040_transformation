---
title: "additional charts"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

<!-- Setting default chunk options -->
```{r chunkOptions, echo=FALSE, include = FALSE}
#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 12,
                        fig.height = 6,
                        dpi=100
                        )
```  


```{r loading_packages, echo=FALSE, include = FALSE}

  #Loading required packages
  # install.packages("remotes")
  #remotes::install_github("coolbutuseless/ggpattern")
  #install.packages('rsvg')
  #remotes::install_github('coolbutuseless/ggsvg')
  packagesList <- c("quitte","ggplot2","geomtextpath","ggpattern","tidyr","grid","stringr","gridExtra","ggrepel","kableExtra","dplyr","remind2","rsvg","ggsvg","plotly")
  packages <- suppressWarnings(suppressMessages(lapply(packagesList, function(x){ if(!require(x, character.only = T, quietly = T)){ install.packages(x); return(paste0("installed missing package: ", x)) } else paste0("required package is installed: ", x) } )))

```


<!-- Preprocess: prepare and load the data for use in the charts and markdown -->

```{r preprocess, echo=FALSE, include = FALSE}

#Options
forceUpdateData = FALSE
loadHist = TRUE

# data and output folders
folders <- file.info(list.files(path="./data", full.names = T))
dataFolder <- folders %>% tibble::rownames_to_column(var = "path") %>% arrange(desc(path)) %>% slice(1) %>% pull(path)

source("./R/preprocess.R") 

outFolder <- paste0("./output/",gsub("./data/","",dataFolder))
outChartsFolder <- paste0(outFolder,"/report_additionalCharts")
dir.create(paste0(outChartsFolder, "/png"), recursive = TRUE, showWarnings = FALSE)
dir.create(paste0(outChartsFolder, "/svg"), recursive = TRUE, showWarnings = FALSE)

```

<!-- units conversion -->

```{r unitsConversion, echo=FALSE, include = FALSE}

# conversion factors
  USS2017_2_EURO2020 <- 0.9502 # 1 USD 2017 = 0.9502 EURO 2020

```

<!-- Initializing charts object -->
```{r chart_initialization, echo=FALSE, include = FALSE}

#loading theme and colors
source("./R/aesthetics.R") 

g <- NULL

```


# Emission reduction {.tabset}

## Gross

<!-- (c) Breakdown of residual CO2 emissions from energy and industrial processes (% in relation to 2020) -->

```{r, echo=FALSE}

vars <- list(
  "Industrial\nProcesses" = "Emi|GHG|Industrial Processes",
  "Industry" = "Emi|GHG|Gross|Energy|Demand|Industry",
  "Buildings" ="Emi|GHG|Energy|Demand|Buildings",
  "Transportation" ="Emi|GHG|Energy|Demand|Transport",
  "Bunkers" = "Emi|CO2|Energy|Demand|Transport|International Bunkers",
#  "CDR" = "Emi|GHG|Gross|Energy|Demand|CDR",
#  "AFOFI" = "Emissions|CO2|Energy|Demand|AFOFI",
#  "Other Sector" ="Emissions|CO2|Energy|Demand|Other Sector",
  "Heat"="Emi|CO2|Gross|Energy|Supply|Heat",
  "Other Energy\nConversion" = "Emi|CO2|Gross|Other Energy Conversion",
    #"Hydrogen" ="Emi|CO2|Gross|Energy|Supply|Hydrogen",
    #"Liquids"="Emi|CO2|Gross|Energy|Supply|Liquids",
    #"Gases"="Emi|CO2|Gross|Energy|Supply|Gases",
    #"Solids"="Emi|CO2|Gross|Energy|Supply|Solids",
#  "Other"="Emissions|CO2|Energy|Supply|Other",
  "Electricity"="Emi|GHG|Gross|Energy|Supply|Electricity"
)
# "Emi|GHG|Agriculture",
#   "Emi|GHG|Land-Use Change",
#   "Emi|GHG|Waste",
#   "Emi|CO2|CDR|BECCS",
#   "Emi|CO2|CDR|Industry CCS|Synthetic Fuels",
#   "Emi|CO2|CDR|DACCS",
#   "Emi|CO2|CDR|EW"

plotColor <- c(
  "Electricity"= "#ffb200",
  "Heat"= "#cc0000",
  "Other Energy\nConversion" = "#0000cc",
  #"Gases"= "#999959",
  #"Liquids"= "#0000cc",
  #"Solids"= "#0c0c0c",
  #"Other" = "#79a6d2",
  #"Hydrogen" = "#5ed5b0",
  "Transportation" = "#a1dd70",
  "Bunkers" = "#ffc0cb",
  "Buildings" = "#5edfff",
  "Other Sector" = "#999959",
  "AFOFI" = "#005900",
  "Industry" = "#5f6769",
  "Industrial\nProcesses" = "#5c5c5c",
  "Other" = "#5b0d8f",
  "Waste" = "#A52A2A",
  "AFOLU" = "#4DAF4A",
  "Agriculture" = "#357933",
  "LULUCF" = "#6ec16b"
)


labels <- setNames(names(vars),vars[names(vars)])

fulldata <- df %>%
  filter(region == "EU27",
         period %in% c(2020,2030,2040),
         tgt2030 %in% tgt2030Scen,
         variable %in% unlist(vars)) %>%
  mutate(labels = factor(labels[as.character(variable)],levels = names(vars)),
         variable = factor(variable, levels = vars)) %>%
  group_by(period,variable) %>%
  mutate(min = min(value),
         max = max(value))

plotData <- fulldata %>%
  filter(scenario == mainScen) %>%
  mutate(complement = FALSE) %>%
  group_by(variable) %>%
  mutate(pct = paste0(round(value / value[period==2020],2)*100, "%")) %>%
  bind_rows(
    fulldata %>%
      filter(scenario == mainScen) %>%
      mutate(complement = TRUE) %>%
      group_by(variable) %>%
      mutate(value = value[period==2020] - value) %>%
      mutate(labels=NA)
  ) %>%
  mutate(ext_Var = ifelse(complement, paste0(as.character(variable),"_"), as.character(variable))) %>%
  arrange(period,ext_Var) %>%
  group_by(period) %>%
  arrange(variable) %>%
  mutate(ymid = as.numeric(sub("\\D+", "", period)),
         ymax = ymid + 4, ymin = ymid - 4,
         xmin = c(0, head(cumsum(value), -1)),
         xmax = cumsum(value),
         xmid = (xmax + xmin) / 2,
         ) %>%
  ungroup() %>%
  filter(complement == FALSE)

g[["2040 Emissions - Energy and Industrial Processes - Gross"]] <- plotData %>% 
  ggplot(aes(xmid, ymid, fill = ext_Var)) +
  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
                alpha = factor(period), color = variable)) +
  geom_errorbar(data=plotData %>% filter(period == 2040), aes(xmin=xmax-value+min, xmax=xmax-value+max), width=4, colour="black", alpha=0.9, linewidth=0.8) +
  geom_text(data=plotData %>% filter(period == 2020), aes(y = 2015, label = labels, group = labels, hjust=1, angle = 90), vjust=0.5, hjust=1.1, na.rm=TRUE, size = geomText.size, angle = 90, lineheight = 0.8) +
  geom_text(data=plotData %>% filter(period == 2040), aes(x=xmid , y = 2045, label = pct), vjust=0.5, hjust=-0.1, na.rm=TRUE, size = geomText.size, angle = 90) +
  scale_fill_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) + 
  scale_alpha_manual(values = c(0.2, 0.3, 1)) +
  scale_color_manual(values = c(setNames(plotColor[names(vars)],vars)), labels = setNames(names(vars), vars)) +
  theme_doubleColumn() +
  theme(legend.position = "none") +
  scale_y_continuous(breaks=c(2020,2030,2040), labels=c("current",2030,2040), minor_breaks = NULL, limits=c(2008,2047)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank()) +
  scale_x_continuous(breaks = NULL) +
  coord_cartesian(clip="off") +
  theme(plot.margin = margin(t = 30, r = 0, b = 100, l = 0, unit = "pt")) +
  labs(title = "(c) Sectoral breakdown of residual gross CO2 emissions from energy and industrial processes (% of average 2018-2022)") + 
  theme(plot.title = element_text(margin=margin(t=0,r=0,b=35,l=-200), hjust=1))
  
# ggsave(paste0(outChartsFolder,"/svg/Figure 1. Emission results panel - (c) Energy and Industrial Processes.svg"), g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]] , device="svg", width = 12, height = 3.2, dpi=100, units = "in")
# ggsave(paste0(outChartsFolder,"/png/Figure 1. Emission results panel - (c) Energy and Industrial Processes.png"), g[["2040 Emissions - Energy and Industrial Processes - horizontal bar"]] , device="png", width = 12, height = 3.2, dpi=300, units = "in")


```








# Targets debug {.tabset}

## Reduction Matrix


```{r data_emissionReductionMatrix, echo=FALSE, include = FALSE}

## Reduction Matrix
reductionMatrix <- df_beforeFilter %>% 
  filter(region == "EU27", 
         period == 2040, 
         tgt2030 == "57",
         !grepl("eedEff|ff55Eff|RpEUEff",scenario)) %>% 
  calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
  mutate(reduction = round((1 - (value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)))*100 ,2)) %>%
  select(bioLim,lim,reduction) %>%
  pivot_wider(names_from=lim,values_from=reduction) %>%
  mutate(bioLim = factor(c("BioLim4","BioLim7.5","BioLim12","BioLim20")))

if("limVRE" %in% colnames(reductionMatrix)){
  colors <- spec_color(c(reductionMatrix$default,reductionMatrix$limCCS,reductionMatrix$limH2,reductionMatrix$limVRE), end = 0.9, option = "A", direction = -1)

redMatrix <- reductionMatrix %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, bold = T) %>%
  column_spec(2,color = colors[1:3]) %>%
  column_spec(3,color = colors[4:6]) %>%
  column_spec(4,color = colors[7:9]) %>%
  column_spec(5,color = colors[10:12])
} else {
  colors <- spec_color(c(reductionMatrix$default,reductionMatrix$limCCS,reductionMatrix$limH2), end = 0.9, option = "A", direction = -1)

redMatrix <- reductionMatrix %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  column_spec(1, bold = T) %>%
  column_spec(2,color = colors[1:3]) %>%
  column_spec(3,color = colors[4:6]) %>%
  column_spec(4,color = colors[7:9])
}

redMatrix2 <- df_beforeFilter %>%
    filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
    mutate(reduction = value / (tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)),
           tgtAchieved = (1-reduction)*100,
           diff = as.numeric(as.character(tgt2030)) - ((1-reduction)*100)) %>%
  mutate(text = paste0(round(tgtAchieved,2), "%"))

g[["reduction matrix"]][["ggplot"]] <- ggplot(redMatrix2, aes(x=bioLim, y=lim, fill= tgtAchieved, text = text)) + 
  geom_tile() +
  facet_grid(tgt2030 ~ efficiency, scales = "free") +
  scale_fill_distiller(palette = "Blues", direction = 1, breaks = seq(floor(min(redMatrix2$tgtAchieved)), ceiling(max(redMatrix2$tgtAchieved)),2)) +
  theme_doubleColumn() +
  theme(strip.clip = "off") +
  guides(fill = guide_colorbar(barwidth = 20, barheight = 1)) +
  theme(legend.position="bottom") +
  theme(legend.title=element_blank())
  
g[["reduction matrix"]][["plotly"]] <- ggplotly(g[["reduction matrix"]][["ggplot"]],tooltip = c("text")) %>% layout(autosize = TRUE)  

ggsave(paste0(outChartsFolder,"/svg/Emission Reduction 2040.svg"), g[["reduction matrix"]][["ggplot"]] , device="svg", width = 10, height = 6, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Emission Reduction 2040.png"), g[["reduction matrix"]][["ggplot"]] , device="png", width = 10, height = 6, dpi=300, units = "in")

```

```{r, echo=FALSE, fig.width=10, fig.height=6}

g[["reduction matrix"]][["plotly"]]


```

- Reduction Matrix for the 2030 57% target

```{r, echo=FALSE}

redMatrix

```


## non-achieved 2030

<!-- Debug non-achieved targets -->
```{r, echo=FALSE, include = FALSE}


plotData <- left_join(
  df_beforeFilter %>%
    filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
    mutate(reduction = value / (tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)),
           tgtAchieved = (1-reduction)*100,
           diff = as.numeric(as.character(tgt2030)) - ((1-reduction)*100)) %>%
    group_by(tgt2030) %>% 
    mutate(min = min(value),
           max = max(value)),
  df_beforeFilter %>%
    filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen, variable == "Price|Carbon") %>%
    mutate(price_2030 = USS2017_2_EURO2020*value) %>%
    select(scenario, price_2030),
  by = "scenario") %>%
  mutate(text = paste0("Target Achieved: ", tgtAchieved, " % reduction", "\n2030 price: ", round(price_2030,2), " â‚¬/t CO2", "\nScenario: ", scenario, "\nTarget 2030: ", tgt2030, "%", "\nEfficiency: ", efficiency, "\nBiomass Limit: ", bioLim, "\nSensititivy limit: ", lim))

g[["2030 targets"]][["ggplot"]] <-  ggplot(plotData,aes(x=period,y=tgtAchieved)) +
  geom_point(aes(shape = lim, fill = bioLim, color = efficiency, text = text), size = 3) +
  geom_segment(aes(x=2029, xend=2031, y=as.numeric(as.character(tgt2030)), yend=as.numeric(as.character(tgt2030))), linetype="dashed", color="black") +
  #geom_errorbar(aes(ymin=min, ymax=max), colour="black", alpha=0.9, linewidth=1) +
  #geom_boxplot(outlier.shape = NA) +
  facet_grid(~ tgt2030) +
  theme_doubleColumn() +
  scale_fill_manual(values = c("BioLim4"="#fedc97", "BioLim7.5"="#b5b682", "BioLim12"="#7c9885", "BioLim20"="#28666e"), guide = guide_legend(nrow =2, byrow = F, override.aes = list(shape = 21, size = 6, colour = "transparent"), order = 3)) +
  scale_shape_manual(values = c("default"=21,"limCCS"=22,"limH2"=23,"limVRE"=24), guide = guide_legend(nrow =2, byrow = T, order = 4, override.aes = list(size = 6))) +
  scale_color_manual(values = c("reference"="#ae0000", "EED 2018 Eff"="#db4646", "FitFor55 eff"="#0090ab", "RePowerEU eff"="#095786"), guide = guide_legend(nrow =2, byrow = F, order = 2, override.aes = list(shape = 1, linewidth = 1.5))) + 
  scale_x_continuous(breaks=2030) +
  scale_y_continuous(breaks=seq(53,61,1)) +
  theme(legend.position="none")
  
g[["2030 targets"]][["plotly"]] <- ggplotly(g[["2030 targets"]][["ggplot"]],tooltip = c("text")) %>% layout(autosize = TRUE)

ggsave(paste0(outChartsFolder,"/svg/Emission Reduction 2030.svg"), g[["2030 targets"]][["ggplot"]], device="svg", width = 8, height = 4, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Emission Reduction 2030.png"), g[["2030 targets"]][["ggplot"]], device="png", width = 8, height = 4, dpi=300, units = "in")

## Function to extract legend
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

legend <- g_legend(
  g[["2030 targets"]][["ggplot"]] +
  theme(legend.position="bottom") +  
  theme(legend.title=element_blank(),
        legend.margin=margin(c(0,0,0,0))) +
  theme(plot.margin=margin(0,0,0,0))
) 

nonAchieved2030 <- left_join(
  df_beforeFilter %>%
    filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen) %>%
    calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%
    mutate(reduction = value / (tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)),
           tgtAchieved = (1-reduction)*100,
           diff = as.numeric(as.character(tgt2030)) - ((1-reduction)*100)) %>%
    group_by(tgt2030) %>% 
    mutate(min = min(value),
           max = max(value)),
  df_beforeFilter %>%
    filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen, variable == "Price|Carbon") %>%
    mutate(price_2030 = USS2017_2_EURO2020*value) %>%
    select(scenario, price_2030),
  by = "scenario") %>%
  filter(diff >= 0.5 | diff <= -0.5) %>%
  select(scenario, price_2030, tgt2030, tgtAchieved, diff) %>%
  arrange(desc(abs(diff)))
  
#View(nonAchieved2030)

```


```{r, echo=FALSE, fig.width=8, fig.height=4}

g[["2030 targets"]][["plotly"]]

```

```{r, echo=FALSE, fig.width=8, fig.height=2}

grid.newpage()
grid.draw(legend)

```


```{r, echo=FALSE}

nonAchieved2030 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```


## non-achieved 2050

<!-- Debug non-achieved targets -->
```{r, echo=FALSE, include = FALSE}


plotData <- df_beforeFilter %>%
  filter(region == "EU27", period == 2050, tgt2030 %in% tgt2030Scen) %>%
  calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>%
  mutate(reduction = value / (tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)),
         tgtAchieved = (1-reduction)*100) %>% 
  mutate(min = min(value),
         max = max(value))

g[["2050 targets"]][["ggplot"]] <-  ggplot(plotData,aes(x=period,y=tgtAchieved)) +
  geom_point(aes(shape = lim, fill = bioLim, color = efficiency), size = 3) +
  geom_segment(aes(x=2049, xend=2051, y=100, yend=100), linetype="dashed", color="black") +
  theme_doubleColumn() +
  scale_fill_manual(values = c("BioLim4"="#fedc97", "BioLim7.5"="#b5b682", "BioLim12"="#7c9885", "BioLim20"="#28666e"), guide = guide_legend(nrow =2, byrow = F, override.aes = list(shape = 21, size = 6, colour = "transparent"), order = 3)) +
  scale_shape_manual(values = c("default"=21,"limCCS"=22,"limH2"=23,"limVRE"=24), guide = guide_legend(nrow =2, byrow = T, order = 4, override.aes = list(size = 6))) +
  scale_color_manual(values = c("reference"="#ae0000", "EED 2018 Eff"="#db4646", "FitFor55 eff"="#0090ab", "RePowerEU eff"="#095786"), guide = guide_legend(nrow =2, byrow = F, order = 2, override.aes = list(shape = 1, linewidth = 1.5))) + 
  scale_x_continuous(breaks=2050) +
  scale_y_continuous(breaks=c(99.5,100,100.5)) +
  expand_limits(y=c(99.5,100.5)) +
  theme(legend.position="none")

  g[["2050 targets"]][["plotly"]] <- ggplotly(g[["2050 targets"]][["ggplot"]]) %>% layout(autosize = TRUE)

  
ggsave(paste0(outChartsFolder,"/svg/Emission Reduction 2050.svg"), g[["2050 targets"]][["ggplot"]], device="svg", width = 4, height = 4, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Emission Reduction 2050.png"), g[["2050 targets"]][["ggplot"]], device="png", width = 4, height = 4, dpi=300, units = "in")

nonAchieved2050 <- df_beforeFilter %>%
  filter(region == "EU27", period == 2050, tgt2030 %in% tgt2030Scen) %>%
  calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>%
  mutate(reduction = value / (tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)),
         tgtAchieved = (1-reduction)*100) %>%
  filter(tgtAchieved >= 100.3 | tgtAchieved <= 99.7) %>%
  select(scenario, reduction, tgtAchieved) %>%
  arrange(desc(abs(reduction)))

#View(nonAchieved2050)

```


```{r, echo=FALSE, fig.width=4, fig.height=4}

g[["2050 targets"]][["plotly"]]

```


```{r, echo=FALSE, fig.width=8, fig.height=2}

grid.newpage()
grid.draw(legend)

```

```{r, echo=FALSE}

nonAchieved2050 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```




# Fuel Shares {.tabset}

```{r, echo=FALSE, include=FALSE}

vars <- list(
  "Liquids" = list(
    "Transport" = c(
      "FE|Transport|Liquids|Biomass",
      "FE|Transport|Liquids|Hydrogen",
      "FE|Transport|Liquids|Fossil"
    ),
    "Buildings" = c(
      "FE|Buildings|Liquids|Biomass",
      "FE|Buildings|Liquids|Hydrogen",
      "FE|Buildings|Liquids|Fossil"
    ),
    "Industry" = c(
      "FE|Industry|Liquids|Biomass",
      "FE|Industry|Liquids|Hydrogen",
      "FE|Industry|Liquids|Fossil"
    )
  ),
  "Gases" = list(
    "Transport" = c(
      "FE|Transport|Gases|Biomass",
      "FE|Transport|Gases|Hydrogen",
      "FE|Transport|Gases|Fossil"
    ),
    "Buildings" = c(
      "FE|Buildings|Gases|Biomass",
      "FE|Buildings|Gases|Hydrogen",
      "FE|Buildings|Gases|Fossil"
    ),
    "Industry" = c(
      "FE|Industry|Gases|Biomass",
      "FE|Industry|Gases|Hydrogen",
      "FE|Industry|Gases|Fossil"
    )
  ),
  "Solids" = list(
    "Buildings" = c(
      "FE|Buildings|Solids|Biomass",
      "FE|Buildings|Solids|Fossil"
    ),
    "Industry" = c(
      "FE|Industry|Solids|Biomass",
      "FE|Industry|Solids|Fossil"
    )
  )
  )

plotColor <- c(
    "Biomass"  = "#597445",
    "Hydrogen" = "#F96666",
    "Fossil"   = "#bbbbbb"
  )


#tgt2050 tgt2030 efficiency bioLim lim  

fullPlotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2010:2050), variable %in% unlist(vars)) %>%
  mutate(sector = factor(unlist(regmatches(variable, gregexpr('Transport|Industry|Buildings', variable))),levels=c("Industry", "Buildings", "Transport")),
         carrier= factor(unlist(regmatches(variable, gregexpr('Liquids|Gases|Solids', variable))),levels=c("Liquids", "Gases", "Solids")),
         type   = factor(unlist(regmatches(variable, gregexpr('Biomass|Hydrogen|Fossil', variable))),levels=c("Biomass", "Fossil", "Hydrogen")))

plotData <- fullPlotData %>%
  filter(tgt2030 == 57, 
         efficiency == "reference", 
         #bioLim == "BioLim7.5", 
         lim == "default")

g[["Fuel shares"]][["BioLim"]] <-  ggplot(plotData,aes(x=period,y=value)) +
    geom_bar(aes(fill=type),stat='identity', position="fill") +
    facet_grid(carrier~bioLim+sector) +
    theme_doubleColumn() +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = plotColor) + 
    theme(plot.background = element_rect(fill = 'white', colour = 'white'))

ggsave(paste0(outChartsFolder,"/svg/Fuel shares - tgt57,effRef,limDef - BioLim.svg"), g[["Fuel shares"]][["BioLim"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Fuel shares - tgt57,effRef,limDef - BioLim.png"), g[["Fuel shares"]][["BioLim"]], device="png", width = 12, height = 8, dpi=300, units = "in")

plotData <- fullPlotData %>%
  filter(tgt2030 == 57, 
         #efficiency == "reference", 
         bioLim == "BioLim7.5", 
         lim == "default")

g[["Fuel shares"]][["efficiency"]] <-  ggplot(plotData,aes(x=period,y=value)) +
    geom_bar(aes(fill=type),stat='identity', position="fill") +
    facet_grid(carrier~efficiency+sector) +
    theme_doubleColumn() +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = plotColor) + 
    theme(plot.background = element_rect(fill = 'white', colour = 'white'))

ggsave(paste0(outChartsFolder,"/svg/Fuel shares - tgt57,bio7p5,limDef - efficiency.svg"), g[["Fuel shares"]][["efficiency"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Fuel shares - tgt57,bio7p5,limDef - efficiency.png"), g[["Fuel shares"]][["efficiency"]], device="png", width = 12, height = 8, dpi=300, units = "in")

plotData <- fullPlotData %>%
  filter(#tgt2030 == 57, 
         efficiency == "reference", 
         bioLim == "BioLim7.5", 
         lim == "default")

g[["Fuel shares"]][["tgt2030"]] <-  ggplot(plotData,aes(x=period,y=value)) +
    geom_bar(aes(fill=type),stat='identity', position="fill") +
    facet_grid(carrier~tgt2030+sector) +
    theme_doubleColumn() +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = plotColor) + 
    theme(plot.background = element_rect(fill = 'white', colour = 'white'))

ggsave(paste0(outChartsFolder,"/svg/Fuel shares - effRef,bio7p5,limDef - tgt2030.svg"), g[["Fuel shares"]][["tgt2030"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Fuel shares - effRef,bio7p5,limDef - tgt2030.png"), g[["Fuel shares"]][["tgt2030"]], device="png", width = 12, height = 8, dpi=300, units = "in")

plotData <- fullPlotData %>%
  filter(tgt2030 == 57, 
         efficiency == "reference", 
         bioLim == "BioLim7.5"#, 
         #lim == "default"
         )

g[["Fuel shares"]][["lim"]] <-  ggplot(plotData,aes(x=period,y=value)) +
    geom_bar(aes(fill=type),stat='identity', position="fill") +
    facet_grid(carrier~lim+sector) +
    theme_doubleColumn() +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = plotColor) + 
    theme(plot.background = element_rect(fill = 'white', colour = 'white'))

ggsave(paste0(outChartsFolder,"/svg/Fuel shares - tgt57,effRef,bio7p5 - lim.svg"), g[["Fuel shares"]][["lim"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/Fuel shares - tgt57,effRef,bio7p5 - lim.png"), g[["Fuel shares"]][["lim"]], device="png", width = 12, height = 8, dpi=300, units = "in")

```


## tgt2030

```{r, echo=FALSE, fig.width=12, fig.height=8}

g[["Fuel shares"]][["tgt2030"]]

```

## Efficiency

```{r, echo=FALSE, fig.width=12, fig.height=8}

g[["Fuel shares"]][["efficiency"]]

```

## BioLim

```{r, echo=FALSE, fig.width=12, fig.height=8}

g[["Fuel shares"]][["BioLim"]]

```

## Lim

```{r, echo=FALSE, fig.width=12, fig.height=8}

g[["Fuel shares"]][["lim"]]

```





<!-- <!-- # GHG Emissions --> -->

<!-- ```{r chart_, echo=FALSE, include=FALSE} -->

<!-- library(plotly) -->
<!-- plotData <- df %>%  -->
<!--   filter(region == "EU27", period %in% c(2020:2060), tgt2030 %in% tgt2030Scen) %>%  -->
<!--   calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>% -->
<!--   mutate(reduction = round((1 - (value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference))) ,2)) -->

<!-- g[["GHG emi_plotly"]] <- ggplotly(ggplot(plotData, aes(x=period,y=reduction, color=scenario)) + -->
<!--            geom_line() + -->
<!--            guides(color="none") + -->
<!--            theme_doubleColumn() + -->
<!--            scale_y_continuous(labels = scales::percent, trans="reverse") + -->
<!--            theme(axis.title.y=element_blank()) -->
<!--   ) -->

<!-- g[["GHG emi_plotly_limit"]] <- ggplotly(ggplot(plotData %>% filter(!grepl("limVRE|bio20|Nzero_55", scenario)), aes(x=period,y=reduction, color=scenario)) + -->
<!--            geom_line() + -->
<!--            guides(color="none") + -->
<!--            theme_doubleColumn() + -->
<!--            scale_y_continuous(labels = scales::percent, trans="reverse") + -->
<!--            theme(axis.title.y=element_blank()) -->
<!--   ) -->
<!-- #min(plotData %>% filter(!grepl("limVRE|bio20|Nzero_55", scenario), period == 2040) %>% pull(reduction)) -->
<!-- ``` -->


<!-- <!-- ```{r, echo=FALSE, fig.width=6, fig.height=10} --> -->

<!-- <!-- g[["GHG emi_plotly"]] --> -->

<!-- <!-- ``` --> -->


<!-- # Electricity Capacity -->

<!-- <!-- Electricity Capacity (%) --> -->

<!-- ```{r, echo=FALSE} -->

<!-- vars <- c( -->
<!-- #  "Net Imports" = "Cap|Electricity|Imports", -->
<!--   "Coal w/ CC" = "Cap|Electricity|Coal|w/ CC", -->
<!--   "Coal w/o CC" = "Cap|Electricity|Coal|w/o CC", -->
<!--   "Oil" = "Cap|Electricity|Oil", -->
<!--   "Gas w/ CC" = "Cap|Electricity|Gas|w/ CC", -->
<!--   "Gas w/o CC" = "Cap|Electricity|Gas|w/o CC", -->
<!--   "Hydrogen" = "Cap|Electricity|Hydrogen", -->
<!--   "Nuclear" = "Cap|Electricity|Nuclear", -->
<!--   "Geothermal" = "Cap|Electricity|Geothermal", -->
<!--   "Hydro" = "Cap|Electricity|Hydro", -->
<!--   "Biomass w/ CC" = "Cap|Electricity|Biomass|w/ CC", -->
<!--   "Biomass w/o CC" = "Cap|Electricity|Biomass|w/o CC", -->
<!--   "Solar CSP" = "Cap|Electricity|Solar|CSP", -->
<!--   "Solar PV" = "Cap|Electricity|Solar|PV", -->
<!--   "Wind Onshore" = "Cap|Electricity|Wind|Onshore", -->
<!--   "Wind Offshore" = "Cap|Electricity|Wind|Offshore", -->
<!--   "Storage Battery" = "Cap|Electricity|Storage|Battery" -->
<!--   ) -->


<!-- inv_vars <- setNames(names(vars),vars) -->

<!-- color <- c( -->
<!-- #  "Net Imports"   = "#472b62", -->
<!--   "Coal w/ CC"    = "#b2b2b2", -->
<!--   "Coal w/o CC"   = "#0c0c0c", -->
<!--   "Oil"           = "#b30000", -->
<!--   "Gas w/ CC"     = "#b79e38", -->
<!--   "Gas w/o CC"    = "#999959", -->
<!--   "Hydrogen"      = "#5ed5b0", -->
<!--   "Nuclear"       = "#ff33ff", -->
<!--   "Geothermal"    = "#e51900", -->
<!--   "Hydro"         = "#191999", -->
<!--   "Biomass w/ CC" = "#33ff00", -->
<!--   "Biomass w/o CC"= "#005900", -->
<!--   "Solar CSP"     = "#ffcc00", -->
<!--   "Solar PV"      = "#ffe600", -->
<!--   "Wind Onshore"  = "#193F7F", -->
<!--   "Wind Offshore" = "#337fff", -->
<!--   "Storage Battery" = "#472b62") -->

<!-- plotData <- df %>%  -->
<!--   filter(region == "EU27", period >= 2020, period <= 2060, scenario  == mainScen, variable %in% unlist(vars)) %>%  -->
<!--   mutate(variable = factor(variable, levels=vars)) %>%  -->
<!--   arrange(factor(variable, levels = rev(vars))) %>% -->
<!--   group_by(model,scenario,region,period) %>% -->
<!--   mutate(cumValue = cumsum(value), -->
<!--          n = sum(value), -->
<!--          percentage = value / n, -->
<!--          cumPercentage = cumValue / n)  -->

<!-- plotData2040 <- plotData[plotData$period == 2040,] -->
<!-- #plotData$value <- plotData$value / plotData[plotData$period == "2020",]$value -->
<!-- #plotData$period <- as.character(plotData$period) -->
<!-- #plotData$period <- factor(plotData$period , levels = rev(c("2020","2030","2040","2050"))) -->

<!-- plotData2040$xPos <- 2042.5 -->
<!-- #plotData2040[plotData2040$variable %in% c("SE|Electricity|Hydro"),]$xPos <- 2028.5 -->
<!-- #plotData2040[plotData2040$variable %in% c("SE|Electricity|Biomass|w/o CC"),]$xPos <- 2020 -->
<!-- plotData2040[plotData2040$variable %in% c("SE|Electricity|Nuclear","SE|Electricity|Biomass|w/o CC"),]$xPos <- 2035 -->

<!-- plotDataRenewables <- plotData %>% -->
<!--   filter(variable %in% c("Cap|Electricity|Hydrogen","Cap|Electricity|Geothermal","Cap|Electricity|Hydro","Cap|Electricity|Biomass|w/ CC","Cap|Electricity|Biomass|w/o CC","Cap|Electricity|Solar|CSP","Cap|Electricity|Solar|PV","Cap|Electricity|Wind|Onshore","Cap|Electricity|Wind|Offshore","Cap|Electricity|Nuclear","Cap|Electricity|Storage|Battery")) %>% -->
<!--   group_by(model,scenario,region,period) %>% -->
<!--   summarize(percentage = sum(percentage),.groups = "keep") -->

<!-- g[["Electricity Capacity"]] <-  -->
<!--   ggplot(plotData,aes(x=period,y=percentage)) + -->
<!--   geom_area(aes(fill=variable),alpha=0.4) + -->
<!--   geom_line(data=plotDataRenewables, linetype = "dashed", linewidth = 1.5, color="#666666") + -->
<!--   geom_bar(data=plotData2040,aes(fill=variable),stat='identity', show.legend = FALSE, alpha = 0.7, color="white", width = 3, linewidth = 1.5) + -->
<!--   #ggrepel::geom_text_repel(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(round(percentage,2)*100,"%"), y=cumPercentage-percentage/2, x = 2043.5), vjust=0.5, hjust=0.5, na.rm=TRUE, color = "black", size = 12) + -->
<!--   #geom_text(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(inv_vars[variable], " (",round(percentage,2)*100,"%)"), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size = 12) + -->
<!--   geom_text(data=plotData2040[plotData2040$percentage >= 0.02,],aes(label = paste0(round(percentage,2)*100,"%", ifelse(inv_vars[variable] %in% c("Solar PV","Wind Onshore","Wind Offshore"),paste0(" - ", inv_vars[variable]), "")), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size=geom.text.double.size) + -->
<!--   theme_doubleColumn()  + -->
<!--   scale_y_continuous(minor_breaks = seq(0.2, 0.8, 0.2), breaks=c(0,1),labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2020,2040,2060)) + -->
<!--   scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   guides(fill=guide_legend(nrow=8,override.aes = list(alpha=1), byrow = TRUE)) + -->
<!--   #annotate(geom = "text", x = 2022, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage + 0.06, label = "renewables", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2023, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage - 0.06, label = "and nuclear", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "renewables\nand nuclear", color = "#666666",angle = 26, hjust=0, vjust=1, size=geom.text.double.size) + -->
<!--   annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, label = "renewables,\nnuclear and hydrogen", color = "#666666",angle = 90, hjust=0.5, vjust=-0.5, size=geom.text.double.size, lineheight = 0.8) + -->
<!--   annotate(geom = "text", x = 2020, y = (1-plotDataRenewables[plotDataRenewables$period == 2020,]$percentage)/2+plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "fossil", color = "#666666",angle = 90, hjust=0.5, vjust=-2, size=geom.text.double.size) + -->
<!--   annotation_custom(grob = linesGrob(gp=gpar(col="#666666",lwd = 3,lty="dashed")), xmin = 2016, xmax = 2019.8, ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage) + -->
<!--   theme(axis.text.y=element_blank()) + -->
<!--   theme(legend.key.height = unit(0.8, "cm"), -->
<!--     legend.key.width = unit(0.8,"cm")) + -->
<!--   theme(legend.spacing.y = unit(0.1, 'cm')) + -->
<!--   theme() + -->
<!--   annotate(geom = "text", label = "100%", x = 2020, y = 1, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   annotate(geom = "text", label = "0%", x = 2020, y = 0, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 20, unit = "pt") -->
<!--         #,legend.margin=margin(l = -2, unit='cm') -->
<!--         ) #+ -->
<!--   #annotation_custom( -->
<!--   #  grob = textGrob(label = "renewables\nand nuclear",hjust=0.5, vjust=-0.5, rot = 90, gp=gpar(col="#666666", fontsize=geom.text.double.size)), -->
<!--   #  ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, -->
<!--   #  xmin = 2020, xmax = 2020) -->


<!-- ggsave(paste0(outChartsFolder,"/svg/Electricity Capacity.svg"), g[["Electricity Capacity"]] , device="svg", width = 6, height = 10, dpi=100, units = "in") -->
<!-- ggsave(paste0(outChartsFolder,"/png/Electricity Capacity.png"), g[["Electricity Capacity"]] , device="png", width = 6, height = 10, dpi=300, units = "in") -->

<!-- ``` -->

<!-- ```{r, echo=FALSE, fig.width=6, fig.height=10} -->

<!-- g[["Electricity Capacity"]] -->

<!-- ``` -->

<!-- --- -->


<!-- # Electricity flexible Capacity -->

<!-- <!-- Electricity flexible Capacity (GW) --> -->

<!-- ```{r, echo=FALSE} -->

<!-- vars <- list( -->
<!--   "Variable Renewables" = c( -->
<!--     "Cap|Electricity|Solar|CSP", "Cap|Electricity|Solar|PV", "Cap|Electricity|Wind|Onshore", "Cap|Electricity|Wind|Offshore" -->

<!--   ), -->
<!--   "Hydrogen and batteries" = c( -->
<!--     "Cap|Electricity|Hydrogen","Cap|Electricity|Storage|Battery" -->

<!--   ), -->
<!--   "Dispatchable fossil" = c( -->
<!--     "Cap|Electricity|Coal|w/ CC", "Cap|Electricity|Coal|w/o CC", "Cap|Electricity|Oil", "Cap|Electricity|Gas|w/ CC", "Cap|Electricity|Gas|w/o CC" -->
<!--   ), -->
<!--   "Other non dispatchable" = c("Cap|Electricity|Nuclear", "Cap|Electricity|Geothermal", "Cap|Electricity|Hydro", "Cap|Electricity|Biomass|w/ CC", "Cap|Electricity|Biomass|w/o CC" -->
<!--   ) -->
<!-- ) -->

<!-- plotData <- NULL -->
<!-- for(group in names(vars)){ -->
<!--   plotData <- rbind( -->
<!--     plotData, -->
<!--     df %>%  -->
<!--       filter(region == "EU27",  -->
<!--              period >= 2020, period <= 2060,  -->
<!--              scenario  == mainScen,  -->
<!--              variable %in% unlist(vars[[group]])) %>% -->
<!--       group_by(model,scenario,region,period) %>% -->
<!--       summarize(value = sum(value),.groups = "keep") %>% -->
<!--       mutate(variable = group) -->
<!--     ) -->
<!--   } -->

<!-- plotData <- plotData %>% -->
<!--    mutate(variable = factor(variable, levels=names(vars))) %>%  -->
<!--    arrange(factor(variable, levels = names(vars)))  -->

<!-- # plotData <- plotData %>% -->
<!-- #   mutate(variable = factor(variable, levels=names(vars))) %>%  -->
<!-- #   arrange(factor(variable, levels = names(vars))) %>% -->
<!-- #   group_by(model,scenario,region,period) %>% -->
<!-- #   mutate(cumValue = cumsum(value), -->
<!-- #          n = sum(value), -->
<!-- #          percentage = value / n, -->
<!-- #          cumPercentage = cumValue / n)  -->

<!-- #inv_vars <- setNames(names(vars),vars) -->

<!-- color <- c( -->
<!--   "Variable Renewables"       = "#003b6d", -->
<!--   "Hydrogen and batteries"   = "#6699cc", -->
<!--   "Dispatchable fossil"   = "#bdbdbd", -->
<!--   "Other non dispatchable"    = "#676767") -->

<!-- #plotData2040 <- plotData[plotData$period == 2040,] -->
<!-- #  -->
<!-- #plotData2040$xPos <- 2042.5 -->
<!-- #plotData2040[plotData2040$variable %in% c("SE|Electricity|Nuclear","SE|Electricity|Biomass|w/o CC"),]$xPos <- 2035 -->
<!-- #  -->
<!-- # plotDataRenewables <- plotData %>% -->
<!-- #   filter(variable %in% c("Cap|Electricity|Hydrogen","Cap|Electricity|Geothermal","Cap|Electricity|Hydro","Cap|Electricity|Biomass|w/ CC","Cap|Electricity|Biomass|w/o CC","Cap|Electricity|Solar|CSP","Cap|Electricity|Solar|PV","Cap|Electricity|Wind|Onshore","Cap|Electricity|Wind|Offshore","Cap|Electricity|Nuclear","Cap|Electricity|Storage|Battery")) %>% -->
<!-- #   group_by(model,scenario,region,period) %>% -->
<!-- #   summarize(percentage = sum(percentage),.groups = "keep") -->

<!-- g[["Electricity flexible capacity"]] <-  -->
<!--   ggplot(plotData,aes(x=period,y=value)) + -->
<!--   geom_area(aes(fill=variable), alpha = 0.9) + -->
<!--   #geom_line(data=plotDataRenewables, linetype = "dashed", linewidth = 1.5, color="#666666") + -->
<!--   #geom_bar(data=plotData2040,aes(fill=variable),stat='identity', show.legend = FALSE, alpha = 0.7, color="white", width = 3, linewidth = 1.5) + -->
<!--   #ggrepel::geom_text_repel(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(round(percentage,2)*100,"%"), y=cumPercentage-percentage/2, x = 2043.5), vjust=0.5, hjust=0.5, na.rm=TRUE, color = "black", size = 12) + -->
<!--   #geom_text(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(inv_vars[variable], " (",round(percentage,2)*100,"%)"), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size = 12) + -->
<!--   #geom_text(data=plotData2040[plotData2040$percentage >= 0.02,],aes(label = paste0(round(percentage,2)*100,"%", ifelse(inv_vars[variable] %in% c("Solar PV","Wind Onshore","Wind Offshore"),paste0(" - ", inv_vars[variable]), "")), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size=geom.text.double.size) + -->
<!--   theme_doubleColumn()  + -->
<!--   #scale_y_continuous(minor_breaks = seq(0.2, 0.8, 0.2), breaks=c(0,1),labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2020,2040,2060)) + -->
<!--   scale_fill_manual(values = color) + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   guides(fill=guide_legend(nrow=8,override.aes = list(alpha=1), byrow = TRUE)) + -->
<!--   #annotate(geom = "text", x = 2022, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage + 0.06, label = "renewables", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2023, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage - 0.06, label = "and nuclear", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "renewables\nand nuclear", color = "#666666",angle = 26, hjust=0, vjust=1, size=geom.text.double.size) + -->
<!--   #annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, label = "renewables,\nnuclear and hydrogen", color = "#666666",angle = 90, hjust=0.5, vjust=-0.5, size=geom.text.double.size, lineheight = 0.8) + -->
<!--   #annotate(geom = "text", x = 2020, y = (1-plotDataRenewables[plotDataRenewables$period == 2020,]$percentage)/2+plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "fossil", color = "#666666",angle = 90, hjust=0.5, vjust=-2, size=geom.text.double.size) + -->
<!--   #annotation_custom(grob = linesGrob(gp=gpar(col="#666666",lwd = 3,lty="dashed")), xmin = 2016, xmax = 2019.8, ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage) + -->
<!--   #theme(axis.text.y=element_blank()) + -->
<!--   theme(legend.key.height = unit(0.8, "cm"), -->
<!--     legend.key.width = unit(0.8,"cm")) + -->
<!--   theme(legend.spacing.y = unit(0.1, 'cm')) + -->
<!--   theme() + -->
<!--   #annotate(geom = "text", label = "100%", x = 2020, y = 1, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   #annotate(geom = "text", label = "0%", x = 2020, y = 0, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 20, unit = "pt") -->
<!--         #,legend.margin=margin(l = -2, unit='cm') -->
<!--         ) #+ -->
<!--   #annotation_custom( -->
<!--   #  grob = textGrob(label = "renewables\nand nuclear",hjust=0.5, vjust=-0.5, rot = 90, gp=gpar(col="#666666", fontsize=geom.text.double.size)), -->
<!--   #  ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, -->
<!--   #  xmin = 2020, xmax = 2020) -->


<!-- ggsave(paste0(outChartsFolder,"/svg/Electricity flexible capacity.svg"), g[["Electricity flexible capacity"]] , device="svg", width = 6, height = 10, dpi=100, units = "in") -->
<!-- ggsave(paste0(outChartsFolder,"/png/Electricity flexible capacity.png"), g[["Electricity flexible capacity"]] , device="png", width = 6, height = 10, dpi=300, units = "in") -->

<!-- ``` -->

<!-- ```{r, echo=FALSE, fig.width=6, fig.height=10} -->

<!-- g[["Electricity flexible capacity"]] -->

<!-- ``` -->

<!-- Electricity Generation - Hydrogen input (%) -->

<!-- ```{r, echo=FALSE} -->

<!-- vars <- c( -->
<!--   "Net Imports" = "SE|Electricity|Net Imports", -->
<!--   "Coal w/ CC" = "SE|Electricity|Coal|w/ CC", -->
<!--   "Coal w/o CC" = "SE|Electricity|Coal|w/o CC", -->
<!--   "Oil" = "SE|Electricity|Oil", -->
<!--   "Gas w/ CC" = "SE|Electricity|Gas|w/ CC", -->
<!--   "Gas w/o CC" = "SE|Electricity|Gas|w/o CC", -->
<!--   "Hydrogen" = "SE|Input|Electricity|Hydrogen", -->
<!--   "Nuclear" = "SE|Electricity|Nuclear", -->
<!--   "Geothermal" = "SE|Electricity|Geothermal", -->
<!--   "Hydro" = "SE|Electricity|Hydro", -->
<!--   "Biomass w/ CC" = "SE|Electricity|Biomass|w/ CC", -->
<!--   "Biomass w/o CC" = "SE|Electricity|Biomass|w/o CC", -->
<!--   "Solar CSP" = "SE|Electricity|Solar|CSP", -->
<!--   "Solar PV" = "SE|Electricity|Solar|PV", -->
<!--   "Wind Onshore" = "SE|Electricity|Wind|Onshore", -->
<!--   "Wind Offshore" = "SE|Electricity|Wind|Offshore") -->

<!-- inv_vars <- setNames(names(vars),vars) -->

<!-- color <- c( -->
<!--   "Net Imports"   = "#472b62", -->
<!--   "Coal w/ CC"    = "#b2b2b2", -->
<!--   "Coal w/o CC"   = "#0c0c0c", -->
<!--   "Oil"           = "#b30000", -->
<!--   "Gas w/ CC"     = "#b79e38", -->
<!--   "Gas w/o CC"    = "#999959", -->
<!--   "Hydrogen"      = "#5ed5b0", -->
<!--   "Nuclear"       = "#ff33ff", -->
<!--   "Geothermal"    = "#e51900", -->
<!--   "Hydro"         = "#191999", -->
<!--   "Biomass w/ CC" = "#33ff00", -->
<!--   "Biomass w/o CC"= "#005900", -->
<!--   "Solar CSP"     = "#ffcc00", -->
<!--   "Solar PV"      = "#ffe600", -->
<!--   "Wind Onshore"  = "#193F7F", -->
<!--   "Wind Offshore" = "#337fff") -->

<!-- plotData <- df %>%  -->
<!--   filter(region == "EU27", period >= 2020, period <= 2060, scenario  == mainScen, variable %in% unlist(vars)) %>%  -->
<!--   mutate(variable = factor(variable, levels=vars)) %>%  -->
<!--   arrange(factor(variable, levels = rev(vars))) %>% -->
<!--   group_by(model,scenario,region,period) %>% -->
<!--   mutate(cumValue = cumsum(value), -->
<!--          n = sum(value), -->
<!--          percentage = value / n, -->
<!--          cumPercentage = cumValue / n)  -->

<!-- plotData2040 <- plotData[plotData$period == 2040,] -->
<!-- #plotData$value <- plotData$value / plotData[plotData$period == "2020",]$value -->
<!-- #plotData$period <- as.character(plotData$period) -->
<!-- #plotData$period <- factor(plotData$period , levels = rev(c("2020","2030","2040","2050"))) -->

<!-- plotData2040$xPos <- 2042.5 -->
<!-- #plotData2040[plotData2040$variable %in% c("SE|Electricity|Hydro"),]$xPos <- 2028.5 -->
<!-- #plotData2040[plotData2040$variable %in% c("SE|Electricity|Biomass|w/o CC"),]$xPos <- 2020 -->
<!-- plotData2040[plotData2040$variable %in% c("SE|Electricity|Nuclear","SE|Electricity|Biomass|w/o CC"),]$xPos <- 2035 -->

<!-- plotDataRenewables <- plotData %>% -->
<!--   filter(variable %in% c("SE|Input|Electricity|Hydrogen", "SE|Electricity|Geothermal","SE|Electricity|Hydro","SE|Electricity|Biomass|w/ CC","SE|Electricity|Biomass|w/o CC","SE|Electricity|Solar|CSP","SE|Electricity|Solar|PV","SE|Electricity|Wind|Onshore","SE|Electricity|Wind|Offshore","SE|Electricity|Nuclear")) %>% -->
<!--   group_by(model,scenario,region,period) %>% -->
<!--   summarize(percentage = sum(percentage),.groups = "keep") -->

<!-- g[["Electricity Generation - Hydrogen input"]] <-  -->
<!--   ggplot(plotData,aes(x=period,y=percentage)) + -->
<!--   geom_area(aes(fill=variable),alpha=0.4) + -->
<!--   geom_line(data=plotDataRenewables, linetype = "dashed", linewidth = 1.5, color="#666666") + -->
<!--   geom_bar(data=plotData2040,aes(fill=variable),stat='identity', show.legend = FALSE, alpha = 0.7, color="white", width = 3, linewidth = 1.5) + -->
<!--   #ggrepel::geom_text_repel(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(round(percentage,2)*100,"%"), y=cumPercentage-percentage/2, x = 2043.5), vjust=0.5, hjust=0.5, na.rm=TRUE, color = "black", size = 12) + -->
<!--   #geom_text(data=plotData2040[plotData2040$percentage >= 0.01,],aes(label = paste0(inv_vars[variable], " (",round(percentage,2)*100,"%)"), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size = 12) + -->
<!--   geom_text(data=plotData2040[plotData2040$percentage >= 0.02,],aes(label = paste0(round(percentage,2)*100,"%", ifelse(inv_vars[variable] %in% c("Solar PV","Wind Onshore","Wind Offshore"),paste0(" - ", inv_vars[variable]), "")), y=cumPercentage-percentage/2, x = xPos), vjust=0.5, hjust=0, na.rm=TRUE, color = "black", size=geom.text.double.size) + -->
<!--   theme_doubleColumn()  + -->
<!--   scale_y_continuous(minor_breaks = seq(0.2, 0.8, 0.2), breaks=c(0,1),labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2020,2040,2060)) + -->
<!--   scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars), vars)) + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   guides(fill=guide_legend(nrow=8,override.aes = list(alpha=1), byrow = TRUE)) + -->
<!--   #annotate(geom = "text", x = 2022, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage + 0.06, label = "renewables", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2023, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage - 0.06, label = "and nuclear", color = "#888888",angle = 28, hjust=0, vjust=-0.5, size = 12) + -->
<!--   #annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "renewables\nand nuclear", color = "#666666",angle = 26, hjust=0, vjust=1, size=geom.text.double.size) + -->
<!--   annotate(geom = "text", x = 2020, y = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, label = "renewables,\nnuclear and hydrogen", color = "#666666",angle = 90, hjust=0.5, vjust=-0.5, size=geom.text.double.size, lineheight = 0.8) + -->
<!--   annotate(geom = "text", x = 2020, y = (1-plotDataRenewables[plotDataRenewables$period == 2020,]$percentage)/2+plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, label = "fossil", color = "#666666",angle = 90, hjust=0.5, vjust=-2, size=geom.text.double.size) + -->
<!--   annotation_custom(grob = linesGrob(gp=gpar(col="#666666",lwd = 3,lty="dashed")), xmin = 2016, xmax = 2019.8, ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage) + -->
<!--   theme(axis.text.y=element_blank()) + -->
<!--   theme(legend.key.height = unit(0.8, "cm"), -->
<!--     legend.key.width = unit(0.8,"cm")) + -->
<!--   theme(legend.spacing.y = unit(0.1, 'cm')) + -->
<!--   theme() + -->
<!--   annotate(geom = "text", label = "100%", x = 2020, y = 1, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   annotate(geom = "text", label = "0%", x = 2020, y = 0, hjust=1.2, color = "#666666", size=geom.text.double.size) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 20, unit = "pt") -->
<!--         #,legend.margin=margin(l = -2, unit='cm') -->
<!--         ) #+ -->
<!--   #annotation_custom( -->
<!--   #  grob = textGrob(label = "renewables\nand nuclear",hjust=0.5, vjust=-0.5, rot = 90, gp=gpar(col="#666666", fontsize=geom.text.double.size)), -->
<!--   #  ymin = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, ymax = plotDataRenewables[plotDataRenewables$period == 2020,]$percentage/2, -->
<!--   #  xmin = 2020, xmax = 2020) -->


<!-- ggsave(paste0(outChartsFolder,"/svg/Electricity Generation - Hydrogen input.svg"), g[["Electricity Generation - Hydrogen input"]] , device="svg", width = 6, height = 10, dpi=100, units = "in") -->
<!-- ggsave(paste0(outChartsFolder,"/png/Electricity Generation - Hydrogen input.png"), g[["Electricity Generation - Hydrogen input"]] , device="png", width = 6, height = 10, dpi=300, units = "in") -->



<!-- ``` -->

<!-- ```{r, echo=FALSE, fig.width=6, fig.height=10} -->

<!-- g[["Electricity Generation - Hydrogen input"]] -->

<!-- ``` -->


<!-- --- -->



<!-- ```{r chart_figure5, echo=FALSE} -->

<!-- # â€œexistent targetsâ€ -->
<!-- # emission reduction - 2030 (FitFor55) - 2030 scenarios - 2040 scenarios -->
<!-- # energy savings  - 2030 (FitFor55 and REPowerEU) - 2030 scenarios - 2040 scenarios -->
<!-- # renewables target - 2030 (RED II, RED II revised, REPowerEU) - 2030 scenarios - 2040 scenarios -->
<!-- # solar photovoltaics capacity - 2030 (REPowerEU) - 2030 scenarios - 2040 scenarios -->
<!-- # CCS capacity target - 2030 EU-wide 50 MtCO2/y â€œNet-Zero Industry Act" -->
<!-- # â€œimplicit targetsâ€ -->
<!-- # electrification? -> fe electrification share -> 45% -->
<!-- # â€œcarbon-content in electricityâ€ ->â€œcarbon-free electricityâ€ (>95%)  -->
<!-- # Total Residual Fossil emissions -->
<!-- # sectoral emissions -> Transport emissions -> 23% of 2020  -->
<!-- #                                   -> Industry and buildings emissions -> 27% of 2020 -->
<!-- # â€œresidual fossilâ€     -> Complete coal-phase by 2040 -->
<!-- #                                  -> natural gas -->
<!-- #                                 -> oil -->
<!-- # â€œnet tradeâ€ -> net-supply independency of gas by 2040 -->
<!-- #                       -> one third of oil imports by 2040 -->


<!-- #Emissions Reduction -->
<!-- plotData <- rbind( -->
<!--     df %>%  -->
<!--       filter(region == "EU27", period == 2030, tgt2030 %in% tgt2030Scen) %>% -->
<!--       calc_addVariable( "`Emissions with LULUCF and with intra-EU aviation`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers|Intra-region`" , units = "Mt CO2/yr", only.new=T) %>%  -->
<!--       mutate(value = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with intra-EU aviation") %>% pull(reference)) ,2)) %>%  -->
<!--       select(-variable) -->
<!--     , -->
<!--     df %>%  -->
<!--       filter(region == "EU27", period == 2040, tgt2030 %in% tgt2030Scen) %>% -->
<!--       calc_addVariable( "`Emissions with LULUCF and with international transport`" = "`Emi|GHG|LULUCF national accounting` + `Emi|CO2|Energy|Demand|Transport|International Bunkers`" , units = "Mt CO2/yr", only.new=T) %>%  -->
<!--       mutate(value = round(1-(value / tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference)) ,2)) %>%  -->
<!--       select(-variable) -->
<!--   ) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Emissions\nreductions") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value)) -->

<!-- fullPlotData <- plotData  -->

<!-- h <- refEmi %>% filter(variable == "Emissions with LULUCF and with international transport", region == "EU27", pollutant == "All greenhouse gases - (CO2 equivalent)") %>% ungroup() %>% select(region,variable,period,value) -->
<!-- emi1990 <- tgt %>% filter(target == "Emissions with LULUCF and with international transport") %>% pull(reference) -->
<!-- reduction_h <- 1- (h %>% filter(period==2022) %>% pull(value) / emi1990) -->

<!-- g[["milestone - vert"]][["Emissions reductions"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=0.55, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 0.55, label = "FitFor55", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   geom_hline(yintercept=reduction_h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = reduction_h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,1)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->


<!-- # Final Energy Demand - Energy savings -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "FE|w/o Non-energy Use w/o Bunkers") %>% select(-variable) %>% -->
<!--   mutate(value = round(value * 23.8845896627496)) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Final Energy\nDemand") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value)) -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- h <- addHist$FE_consumption %>% #TJ -->
<!--   mutate(value = value/1000000) %>% #EJ -->
<!--   mutate(value = round(value * 23.8845896627496)) # 1EJ = 23.8845896627496 Mtoe -->

<!-- g[["milestone - vert"]][["Energy savings"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=750, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   geom_hline(yintercept=787, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 750, label = "REPowerEU", vjust = 1.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   annotate("text", x = Inf, y = 787, label = "FitFor55", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   geom_hline(yintercept=h %>% filter(period==2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = h %>% filter(period==2022) %>% pull(value), label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,400,1000)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(Mtoe)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Electricity Demand -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "FE|Electricity") %>% select(-variable) %>% -->
<!--   mutate(value = round(value * 1/0.0036)) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Electricity\nDemand") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value)) -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- #2022 = 2469471.42 GWh = 2469471.42 *1000 / 8.76E+09 * 31.536 EJ - FE electricity - https://ec.europa.eu/eurostat/databrowser/bookmark/d19a01c7-6099-4b88-8ccd-c6bcc01c3ddc?lang=en -->
<!-- h <- 2469471.42 /1000 -->
<!-- # old value? 2641 -->

<!-- g[["milestone - vert"]][["Electricity Demand"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,5000)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(TWh)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Renewables share -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Renewables Share") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Renewables\nShare in\nFinal Energy")  -->

<!-- plotData$value <- plotData$value*( -->
<!--   addHist$res %>% filter(type == "RES", period == 2020) %>% pull(value) / -->
<!--    df %>% filter(region == "EU27", period == 2020, variable == "SE|Renewables Share", scenario == mainScen) %>% pull(value)  -->
<!-- ) -->

<!-- plotData <- plotData %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value)) -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Renewables Share"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=0.4, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 0.4, label = "RED II revised", vjust = 1.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   geom_hline(yintercept=0.45, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 0.45, label = "REPowerEU", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   geom_hline(yintercept=addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = addHist$res %>% filter(type == "RES", period == 2022) %>% pull(value), label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,1)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Wind -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Cap|Electricity|Wind") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Wind\ncapacity") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Wind capacity"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=255, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 255, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,1000)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(GW)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Solar photovoltaics -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Cap|Electricity|Solar|PV") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Solar\nphotovoltaics") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Solar photovoltaics"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=600, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 600, label = "REPowerEU", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   geom_hline(yintercept=208.9, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 208.9, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,2500)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(GW)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Carbon Capture and Storage  -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Carbon Management|Storage") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Carbon\nCapture and\nStorage") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Carbon Capture and Storage"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=50, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = 50, label = "Net-Zero\nIndustry Act", vjust = 0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,400)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Novel CDR = atmospheric/biogenic CO2 (CDR)  -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Carbon Management|atmospheric/biogenic CO2 - CDR") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "BECCS\nand\nDACCS") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Novel CDR"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,400)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Direct Electrification -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Final Energy|Electricity Share") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Electricity\nShare in\nFinal Energy") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- #estimation of historical share in 2022 for FE electricity / FE with non-energy use and with bunkers -->
<!-- h <- ( -->
<!--       2550461.10 *1000 / 8.76E+09 * 31.536  # https://ec.europa.eu/eurostat/databrowser/bookmark/12d54df4-7c35-47eb-a103-dd8994d26b80?lang=en -->
<!--      ) / ( -->
<!--       addHist$FE_consumption %>% mutate(value = value/1000000) %>% filter(period==2022) %>% pull(value) + # FE|w/o Non-energy Use w/o Bunkers - EJ -->
<!--       df %>% filter(region == "EU27", period == 2020, scenario == "Npi", variable == "FE|Transport|Bunkers") %>% pull(value) + -->
<!--       df %>% filter(region == "EU27", period == 2020, scenario == "Npi", variable == "FE|Non-energy Use|Industry") %>% pull(value) -->
<!--      ) -->

<!-- g[["milestone - vert"]][["Direct Electrification"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,1)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Carbon-free electricity share -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Electricity|carbon-free") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Carbon-free\nelectricity\nshare") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))   -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- #historical - 2022 - https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Electricity_and_heat_statistics&oldid=347519 -->
<!-- #solid fossil	453180 -->
<!-- #oil	54277 -->
<!-- #gas	571687 -->
<!-- #nuclear	609169 -->
<!-- #renewables	1076710 -->
<!-- #other	32822 -->
<!-- h <- (609169 + 1076710)	/ (453180 + 54277 + 571687 + 609169 + 1076710 + 32822) -->

<!-- g[["milestone - vert"]][["Carbon-free electricity share"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=h, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = Inf, y = h, label = "2022", vjust = -0.5, hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_y_continuous(breaks=seq(0, 1, 0.2), labels = scales::percent) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,1)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Residual Fossil Emissions -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "Emi|CO2|Residual Fossil") %>% select(-variable) %>% -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Residual\nFossil\nEmissions") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))   -->


<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- g[["milestone - vert"]][["Residual Fossil Emissions"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,2500)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(Mt CO2/yr)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- # Domestic Hydrogen Production -->
<!-- plotData <- df %>% filter(region == "EU27", period %in% c(2030,2040), tgt2030 %in% tgt2030Scen, variable == "SE|Hydrogen") %>% select(-variable) %>% -->
<!--   mutate(value = value*8)  %>% #1EJ <- 8 million tons adrian -->
<!--   filter(tgt2050 != "Npi") %>% -->
<!--   mutate(target = "Domestic\nHydrogen\nProduction") %>% -->
<!--   group_by(period) %>%  -->
<!--   mutate(min = min(value), -->
<!--         max = max(value))  -->

<!-- fullPlotData <- rbind(fullPlotData,plotData)  -->

<!-- target <- data.frame(target=c("REPowerEU","REPowerEU"),period=c(2030,2030),value=c(10,20)) -->

<!-- g[["milestone - vert"]][["Domestic Hydrogen Production"]] <- ggplot(plotData, aes(x = period, y = value, group=period)) + -->
<!--   geom_errorbar(aes(ymin=min, ymax=max), width=6, colour="black", alpha=0.9, linewidth=1) + -->
<!--   geom_boxplot(outlier.shape = NA, width=6) + -->
<!--   geom_hline(yintercept=10, color = "black", linewidth=1, alpha = 0.5, linetype = "dashed") + -->
<!--   annotate("text", x = -Inf, y = 10, label = "REPowerEU\ndomestic", vjust = 0.5, hjust = 0, color = "black", alpha = 0.5, size = 0.8*geomText.size) + -->
<!--   facet_grid(.~target, scales="free") + -->
<!--   theme_doubleColumn() + -->
<!--   theme(axis.title.y=element_blank()) + -->
<!--   theme(strip.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks=c(2030,2040), labels = c(2030,2040), minor_breaks = NULL, position = "top") + -->
<!--   expand_limits(y=c(0,20)) +  -->
<!--   theme(panel.spacing = unit(4, "lines")) + -->
<!--   theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) + -->
<!--   theme(strip.placement = "outside") + -->
<!--   theme(strip.text = element_text(angle = 90)) + -->
<!--   coord_cartesian(clip = 'off') + -->
<!--   annotate("text", x = -Inf, y = Inf, label = "(Mtoe)", hjust = 1, color = "black", alpha = 0.5, size = 0.8*geomText.size) #+ -->
<!--   #theme(axis.text.x = element_text(size = 1*theme.double.text.size)) + -->
<!--   #theme(axis.text.y = element_text(size = 1*theme.double.text.size)) -->

<!-- ``` -->

<!-- ```{r, echo=FALSE} -->

<!-- g[["ECEMP abstract"]] <- gridExtra::arrangeGrob( -->
<!--   g[["milestone - vert"]][["Electricity Demand"]] + theme(plot.margin=margin(r=30,t = 35)), -->
<!--   g[["milestone - vert"]][["Direct Electrification"]] + theme(plot.margin=margin(r=30,t = 17)), -->
<!--   g[["milestone - vert"]][["Carbon-free electricity share"]] + theme(plot.margin=margin(t = 24)), -->
<!--   g[["milestone - vert"]][["Residual Fossil Emissions"]] + theme(plot.margin=margin(r=30,t = 39)), -->
<!--   g[["milestone - vert"]][["Carbon Capture and Storage"]] + theme(plot.margin=margin(r=30,t = 15)), -->
<!--   g[["milestone - vert"]][["Novel CDR"]] + theme(plot.margin=margin(t = 50)), -->
<!--   nrow = 1 -->
<!-- ) -->

<!-- ggsave(paste0(outChartsFolder,"/png/ECEMP abstract.png"), g[["ECEMP abstract"]] , device="png", width = 12, height = 8, dpi=300, units = "in") -->

<!-- ``` -->



# Power sector Emissions


```{r, echo=FALSE, include=FALSE}

baseSize <- 24

theme_white <- function(){
  theme_minimal(base_size = baseSize) +
    theme(
      legend.position="bottom",
      legend.title = element_blank(),
      axis.title.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      #axis.text = element_text(size = theme.double.text.size),
      #legend.text=element_text(size= theme.double.text.size),
      #axis.text.x = element_text(size = 0.8*theme.double.text.size, angle = 90, hjust = 1, vjust = 0.5),
      #axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 10)),
      legend.key.height = unit(1, "cm"),
      legend.key.width = unit(1,"cm"),
      panel.background = element_rect(fill="#FFFFFF", color = NA),
      plot.background = element_rect(fill="#FFFFFF", color = NA),
      #panel.spacing = unit(1, "lines"),
      #plot.title = element_text(size = theme.double.text.size, face = "plain"),
      #strip.text.x = element_text(size = theme.double.text.size)
    )
}

histEmber <- data.frame(period=seq(2000,2023,1),value=c(1079, 1084, 1122, 1166, 1157, 1156, 1170, 1188, 1128, 1039, 1048, 1054, 1033, 980, 917, 948, 934, 942, 879, 769, 660, 722, 750, 596))

mainScen <- "Nzero_57_bio7p5" 

plotData <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod", scenario != "Npi") %>%
  group_by(period) %>%
  summarise_at(vars(value), list(
    Min = min,
    Mean = mean,
    Median = median,
    Max = max,
    Sd = sd,
    Q1=~quantile(., probs = 0.25),
    Q3=~quantile(., probs = 0.75)))

plotData2 <- df_beforeFilter %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod", scenario != "Npi") %>%
  filter(scenario == mainScen)

g[["power_sector_emissions"]] <- ggplot(plotData,aes(x=period,y=Median)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    #geom_line(linewidth=1,color="black") +
    geom_line(data = histEmber,aes(x=period,y=value), linewidth=1,color="black",linetype="dashed") +
    geom_line(data = plotData2,aes(x=period,y=value), linewidth=1,color="black") +
    geom_ribbon(aes(ymax = Q3, ymin = Q1), alpha = 0.5, fill = "#545454") +
    geom_ribbon(aes(ymax = Max, ymin = Min), alpha = 0.5, fill = "#545454") +
    #geom_line(aes(y=Min),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    #geom_line(aes(y=Max),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    #geom_line(data=h,linewidth=1,aes(linetype=Source)) +
    #geom_point() +
    theme_white() +
    ylab(expression(paste("Mt ", CO[2],"/yr")))


ggsave(paste0(outChartsFolder,"/svg/power_sector_emissions.svg"), g[["power_sector_emissions"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/power_sector_emissions.png"), g[["power_sector_emissions"]], device="png", width = 12, height = 8, dpi=300, units = "in")


plotData <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod", scenario != "Npi") %>%
  group_by(period) %>%
  summarise_at(vars(value), list(
    Min = min,
    Mean = mean,
    Median = median,
    Max = max,
    Sd = sd,
    Q1=~quantile(., probs = 0.25),
    Q3=~quantile(., probs = 0.75)))

plotData2 <- df %>%
  filter(region == "EU27", period %in% c(2010:2050), variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod", scenario != "Npi") %>%
  filter(scenario == mainScen)

g[["power_sector_emissions_noLimVRE"]] <- ggplot(plotData,aes(x=period,y=Median)) +
    geom_hline(yintercept=0, color = "black", linewidth=2, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1.5, alpha = 0.5,linetype="dashed") +
    #geom_line(linewidth=1,color="black") +
    geom_line(data = histEmber,aes(x=period,y=value), linewidth=1,color="black",linetype="dashed") +
    geom_line(data = plotData2,aes(x=period,y=value), linewidth=1,color="black") +
    geom_ribbon(aes(ymax = Q3, ymin = Q1), alpha = 0.5, fill = "#545454") +
    geom_ribbon(aes(ymax = Max, ymin = Min), alpha = 0.5, fill = "#545454") +
    #geom_line(aes(y=Min),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    #geom_line(aes(y=Max),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    #geom_line(data=h,linewidth=1,aes(linetype=Source)) +
    #geom_point() +
    theme_white() +
    ylab(expression(paste("Mt ", CO[2],"/yr")))


ggsave(paste0(outChartsFolder,"/svg/power_sector_emissions_noLimVRE.svg"), g[["power_sector_emissions_noLimVRE"]], device="svg", width = 12, height = 8, dpi=100, units = "in")
ggsave(paste0(outChartsFolder,"/png/power_sector_emissions_noLimVRE.png"), g[["power_sector_emissions_noLimVRE"]], device="png", width = 12, height = 8, dpi=300, units = "in")



```


